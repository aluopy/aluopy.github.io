---
title: "è¿ç»´è‡ªåŠ¨åŒ–ä¹‹ Ansible"
toc: true
toc_label: "è¿ç»´è‡ªåŠ¨åŒ–ä¹‹ Ansible"
toc_icon: "cog"
categories: Ansible
tags:
  - ansible
---



## æœ¬ä¹¦å†…å®¹

- è¿ç»´è‡ªåŠ¨åŒ–å‘å±•å†ç¨‹åŠæŠ€æœ¯åº”ç”¨
- Ansible å‘½ä»¤ä½¿ç”¨
- Ansible å¸¸ç”¨æ¨¡å—è¯¦è§£
- YAML è¯­æ³•ç®€ä»‹
- Ansible playbook åŸºç¡€
- Playbook å˜é‡ã€tagsã€handlers ä½¿ç”¨
- Playbook æ¨¡æ¿ templates
- Playbook æ¡ä»¶åˆ¤æ–­ when
- Playbook å­—å…¸ with_items
- Ansible Roles
## 1. è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯
### 1.1 äº‘è®¡ç®—è¿ç»´å·¥ç¨‹å¸ˆæ ¸å¿ƒèŒèƒ½

![]({{ site.url }}{{ site.baseurl }}/assets/images/ansible-01.png){: .align-center}

![]({{ site.url }}{{ site.baseurl }}/assets/images/ansible-02.jpg){: .align-center}

![]({{ site.url }}{{ site.baseurl }}/assets/images/ansible-03.jpg){: .align-center}
**ç›¸å…³å·¥å…·**

- ä»£ç ç®¡ç†ï¼ˆSCMï¼‰ï¼šGitHubã€GitLabã€BitBucketã€SubVersion
- æ„å»ºå·¥å…·ï¼šmavenã€Antã€Gradle
- è‡ªåŠ¨éƒ¨ç½²ï¼šCapistranoã€CodeDeploy
- æŒç»­é›†æˆï¼ˆCIï¼‰ï¼šJenkinsã€Travis
- é…ç½®ç®¡ç†ï¼šAnsibleã€SaltStackã€Chefã€Puppet
- å®¹å™¨ï¼šDockerã€Podmanã€LXCã€ç¬¬ä¸‰æ–¹å‚å•†å¦‚ AWS
- ç¼–æ’ï¼šKubernetesã€Coreã€Apache Mesos
- æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼šZookeeperã€etcdã€Consul
- è„šæœ¬è¯­è¨€ï¼špythonã€rubyã€shell
- æ—¥å¿—ç®¡ç†ï¼šELKã€Logentries
- ç³»ç»Ÿç›‘æ§ï¼šPrometheusã€Zabbixã€Datadogã€Graphiteã€Gangliaã€Nagios
- æ€§èƒ½ç›‘æ§ï¼šAppDynamicsã€New Relicã€Splunk
- å‹åŠ›æµ‹è¯•ï¼šJMeterã€Blaze Meterã€loader.io
- åº”ç”¨æœåŠ¡å™¨ï¼šTomcatã€JBossã€IIS
- WebæœåŠ¡å™¨ï¼šApacheã€Nginx
- æ•°æ®åº“ï¼šMySQLã€Oracleã€PostgreSQL ç­‰å…³ç³»å‹æ•°æ®åº“ï¼›mongoDBã€redis ç­‰ NoSQL æ•°æ®åº“
- é¡¹ç›®ç®¡ç†ï¼ˆPMï¼‰ï¼šJiraã€Asanaã€Taigaã€Trelloã€Basecampã€Pivotal Tracker
### 1.2 è¿ç»´èŒä¸šå‘å±•è·¯çº¿

![]({{ site.url }}{{ site.baseurl }}/assets/images/ansible-04.jpg){: .align-left}

**è¿ç»´çš„æœªæ¥æ˜¯ä»€ä¹ˆï¼Ÿ**
**ä¸€åˆ‡çš†è‡ªåŠ¨åŒ–**

â€œè¿ç»´çš„æœªæ¥æ˜¯ï¼Œè®©ç ”å‘äººå‘˜èƒ½å¤Ÿå€ŸåŠ©å·¥å…·ã€è‡ªåŠ¨åŒ–å’Œæµç¨‹ï¼Œå¹¶ä¸”è®©ä»–ä»¬èƒ½å¤Ÿåœ¨è¿ç»´å¹²é¢„æå°‘çš„æƒ…å†µä¸‹éƒ¨ç½²å’Œè¿è¥æœåŠ¡ï¼Œä»è€Œå®ç°è‡ªåŠ©æœåŠ¡ã€‚æ¯ä¸ªè§’è‰²éƒ½åº”è¯¥åŠªåŠ›ä½¿å·¥ä½œå®ç°è‡ªåŠ¨åŒ–ã€‚â€â€”â€”ã€Šè¿ç»´çš„æœªæ¥ã€‹

### 1.3 ä¼ä¸šå®é™…åº”ç”¨åœºæ™¯åˆ†æ
![]({{ site.url }}{{ site.baseurl }}/assets/images/ansible-05.png){: .align-left}
#### 1.3.1 Devå¼€å‘ç¯å¢ƒ
ä½¿ç”¨è€…ï¼šç¨‹åºå‘˜
åŠŸèƒ½ï¼šç¨‹åºå‘˜ä¸ªäººçš„åŠå…¬ç”µè„‘æˆ–é¡¹ç›®çš„å¼€å‘æµ‹è¯•ç¯å¢ƒï¼Œéƒ¨ç½²å¼€å‘è½¯ä»¶ï¼Œæµ‹è¯•ä¸ªäººæˆ–é¡¹ç›®æ•´ä½“çš„ BUG çš„ç¯å¢ƒ
ç®¡ç†è€…ï¼šç¨‹åºå‘˜
#### 1.3.2 æµ‹è¯•ç¯å¢ƒ
ä½¿ç”¨è€…ï¼šQA æµ‹è¯•å·¥ç¨‹å¸ˆ
åŠŸèƒ½ï¼šæµ‹è¯•ç»è¿‡ Dev ç¯å¢ƒæµ‹è¯•é€šè¿‡çš„è½¯ä»¶çš„åŠŸèƒ½å’Œæ€§èƒ½ï¼Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°é¡¹ç›®çš„é¢„æœŸç›®æ ‡ï¼Œç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
ç®¡ç†è€…ï¼šè¿ç»´
è¯´æ˜ï¼šæµ‹è¯•ç¯å¢ƒå¾€å¾€æœ‰å¤šå¥—,æµ‹è¯•ç¯å¢ƒæ»¡è¶³æµ‹è¯•åŠŸèƒ½å³å¯ï¼Œä¸å®œè¿‡å¤š
1ã€æµ‹è¯•äººå‘˜å¸Œæœ›æµ‹è¯•ç¯å¢ƒæœ‰å¤šå¥—,å…¬å¸çš„äº§å“å¤šäº§å“çº¿å¹¶å‘ï¼Œå³å¤šä¸ªç‰ˆæœ¬ï¼Œæ„å‘³ç€å¤šä¸ªç‰ˆæœ¬åŒæ­¥æµ‹è¯•
2ã€é€šå¸¸æµ‹è¯•ç¯å¢ƒæœ‰å¤šå°‘å¥—å’Œäº§å“çº¿æ•°é‡ä¿æŒä¸€æ ·
#### 1.3.3 é¢„å‘å¸ƒç¯å¢ƒ
ä½¿ç”¨è€…ï¼šè¿ç»´
åŠŸèƒ½ï¼šä½¿ç”¨å’Œç”Ÿäº§ç¯å¢ƒä¸€æ ·çš„æ•°æ®åº“ï¼Œç¼“å­˜æœåŠ¡ç­‰é…ç½®ï¼Œæµ‹è¯•æ˜¯å¦æ­£å¸¸
#### 1.3.4 å‘å¸ƒç¯å¢ƒ
åŒ…æ‹¬ä»£ç å‘å¸ƒæœºï¼Œæœ‰äº›å…¬å¸ä¸ºå ¡å’æœºï¼ˆå®‰å…¨å±éšœï¼‰
ä½¿ç”¨è€…ï¼šè¿ç»´
åŠŸèƒ½ï¼šå‘å¸ƒä»£ç è‡³ç”Ÿäº§ç¯å¢ƒ
ç®¡ç†è€…ï¼šè¿ç»´ï¼ˆæœ‰ç»éªŒï¼‰
å‘å¸ƒæœºï¼šå¾€å¾€éœ€è¦æœ‰2å°ï¼ˆä¸»å¤‡ï¼‰
#### 1.3.5 ç”Ÿäº§ç¯å¢ƒ
ä½¿ç”¨è€…ï¼šè¿ç»´ï¼Œå°‘æ•°æƒ…å†µå¼€æ”¾æƒé™ç»™æ ¸å¿ƒå¼€å‘äººå‘˜ï¼Œæå°‘æ•°å…¬å¸å°†æƒé™å®Œå…¨å¼€æ”¾ç»™å¼€å‘äººå‘˜å¹¶å…¶ç»´æŠ¤
åŠŸèƒ½ï¼šå¯¹ç”¨æˆ·æä¾›å…¬å¸äº§å“çš„æœåŠ¡
ç®¡ç†è€…ï¼šåªèƒ½æ˜¯è¿ç»´
ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨æ•°é‡ï¼šä¸€èˆ¬æ¯”è¾ƒå¤šï¼Œä¸”åº”ç”¨éå¸¸é‡è¦ã€‚å¾€å¾€éœ€è¦è‡ªåŠ¨å·¥å…·ååŠ©éƒ¨ç½²é…ç½®åº”ç”¨
#### 1.3.6 ç°åº¦ç¯å¢ƒ
å±äºç”Ÿäº§ç¯å¢ƒçš„ä¸€éƒ¨åˆ†
ä½¿ç”¨è€…ï¼šè¿ç»´
åŠŸèƒ½ï¼šåœ¨å…¨é‡å‘å¸ƒä»£ç å‰å°†ä»£ç çš„åŠŸèƒ½é¢å‘å°‘é‡ç²¾å‡†ç”¨æˆ·å‘å¸ƒçš„ç¯å¢ƒ,å¯åŸºäºä¸»æœºæˆ–ç”¨æˆ·æ‰§è¡Œç°åº¦å‘å¸ƒ
æ¡ˆä¾‹ï¼šå…±100å°ç”Ÿäº§æœåŠ¡å™¨ï¼Œå…ˆå‘å¸ƒå…¶ä¸­çš„10å°æœåŠ¡å™¨ï¼Œè¿™10å°æœåŠ¡å™¨å°±æ˜¯ç°åº¦æœåŠ¡å™¨
ç®¡ç†è€…ï¼šè¿ç»´
ç°åº¦ç¯å¢ƒï¼šå¾€å¾€è¯¥ç‰ˆæœ¬åŠŸèƒ½å˜æ›´è¾ƒå¤§ï¼Œä¸ºä¿é™©èµ·è§ç‰¹æ„å…ˆè®©ä¸€éƒ¨åˆ†ç”¨æˆ·ä¼˜åŒ–ä½“éªŒè¯¥åŠŸèƒ½ï¼Œå¾…è¿™éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨æ²¡æœ‰é‡å¤§é—®é¢˜çš„æ—¶å€™ï¼Œå†å…¨é‡å‘å¸ƒè‡³æ‰€æœ‰æœåŠ¡å™¨ã€‚
### 1.4 ç¨‹åºå‘å¸ƒ
**ç¨‹åºå‘å¸ƒè¦æ±‚ï¼š**
ä¸èƒ½å¯¼è‡´ç³»ç»Ÿæ•…éšœæˆ–é€ æˆç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨
ä¸èƒ½å½±å“ç”¨æˆ·ä½“éªŒ

**é¢„å‘å¸ƒéªŒè¯ï¼š**
æ–°ç‰ˆæœ¬çš„ä»£ç å…ˆå‘å¸ƒåˆ°æœåŠ¡å™¨ï¼ˆè·Ÿçº¿ä¸Šç¯å¢ƒé…ç½®å®Œå…¨ç›¸åŒï¼Œåªæ˜¯æœªæ¥å…¥åˆ°è°ƒåº¦å™¨ï¼‰

**ç°åº¦å‘å¸ƒï¼š**
åŸºäºä¸»æœºï¼Œç”¨æˆ·ï¼Œä¸šåŠ¡

**å‘å¸ƒè·¯å¾„ï¼š**
`/webapp/tuangou`
`/webapp/tuangou-1.1`
`/webapp/tuangou-1.2`

**å‘å¸ƒè¿‡ç¨‹ï¼š**
1. åœ¨è°ƒåº¦å™¨ä¸Šä¸‹çº¿ä¸€æ‰¹ä¸»æœº(æ ‡è®°ä¸º maintenance çŠ¶æ€)
2. å…³é—­æœåŠ¡
3. éƒ¨ç½²æ–°ç‰ˆæœ¬çš„åº”ç”¨ç¨‹åº
4. å¯åŠ¨æœåŠ¡
5. åœ¨è°ƒåº¦å™¨ä¸Šå¯ç”¨è¿™ä¸€æ‰¹æœåŠ¡å™¨

**è‡ªåŠ¨åŒ–ç°åº¦å‘å¸ƒï¼š**
- è„šæœ¬
- å‘å¸ƒå¹³å°
### 1.5 è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯
- æ–‡ä»¶ä¼ è¾“
- åº”ç”¨éƒ¨ç½²
- é…ç½®ç®¡ç†
- ä»»åŠ¡æµç¼–æ’
### 1.6 å¸¸ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·
- **Ansibleï¼š**pythonï¼ŒAgentlessï¼Œä¸­å°å‹åº”ç”¨ç¯å¢ƒ
- **Saltstackï¼š**pythonï¼Œä¸€èˆ¬éœ€éƒ¨ç½² agentï¼Œæ‰§è¡Œæ•ˆç‡æ›´é«˜
- **Puppetï¼š**ruby, åŠŸèƒ½å¼ºå¤§ï¼Œé…ç½®å¤æ‚ï¼Œé‡å‹ï¼Œé€‚åˆå¤§å‹ç¯å¢ƒ
- **Fabricï¼š**pythonï¼Œagentless
- **Chefï¼š**rubyï¼Œå›½å†…åº”ç”¨å°‘
- **Cfengine**
- **func**
## 2. Ansible ä»‹ç»å’Œæ¶æ„
å…¬å¸è®¡åˆ’åœ¨å¹´åº•åšä¸€æ¬¡å¤§å‹å¸‚åœºä¿ƒé”€æ´»åŠ¨ï¼Œå…¨é¢å†²åˆºä¸‹äº¤æ˜“é¢ï¼Œä¸ºæ˜å¹´çš„ä¸Šå¸‚åšå‡†å¤‡ã€‚å…¬å¸è¦æ±‚å„ä¸šåŠ¡ç»„å¯¹å¹´åº•å¤§ä¿ƒåšå‡†å¤‡ï¼Œè¿ç»´éƒ¨è¦æ±‚æ‰€æœ‰ä¸šåŠ¡å®¹é‡è¿›è¡Œä¸‰å€çš„æ‰©å®¹ï¼Œå¹¶æ­å»ºå‡ºå¤šå¥—ç¯å¢ƒå¯ä»¥å…±å¼€å‘å’Œæµ‹è¯•äººå‘˜åšæµ‹è¯•ï¼Œè¿ç»´è€å¤§ä¸ºäº†åœ¨å¹´åº•æœ‰æ‰€è¡¨ç°ï¼Œè¦æ±‚è¿ç»´éƒ¨é—¨åŒå­¦å°½å¿«å®ç°ï¼Œå½“ä½ æ¥åˆ°è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œæœ‰æ²¡æœ‰æ›´å¿«çš„è§£å†³æ–¹æ¡ˆï¼Ÿ
### 2.1 Ansible å‘å±•å²
Ansible ä½œè€… Michael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰ï¼ŒAnsible çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚2012å¹´3æœˆ9æ—¥å‘å¸ƒ0.0.1ç‰ˆï¼Œ2015å¹´10æœˆ17æ—¥è¢« Red Hat ä»¥1.5äº¿ç¾å…ƒæ”¶è´­ã€‚
å®˜æ–¹ç½‘ç«™ï¼š[https://www.ansible.com](http://www.yunweipai.com/go?_=a49e019ca3aHR0cHM6Ly93d3cuYW5zaWJsZS5jb20v)
å®˜æ–¹æ–‡æ¡£ï¼š[https://docs.ansible.com](http://www.yunweipai.com/go?_=beb2e5d97daHR0cHM6Ly9kb2NzLmFuc2libGUuY29tLw%3D%3D)

### 2.2 Ansible ç‰¹æ€§
- æ¨¡å—åŒ–ï¼šè°ƒç”¨ç‰¹å®šçš„æ¨¡å—å®Œæˆç‰¹å®šä»»åŠ¡ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¨¡å—ï¼Œå¯ä½¿ç”¨ä»»ä½•ç¼–ç¨‹è¯­è¨€å†™æ¨¡å—
- Paramikoï¼ˆpython å¯¹ ssh çš„å®ç°ï¼‰ï¼ŒPyYAMLï¼ŒJinja2ï¼ˆæ¨¡æ¿è¯­è¨€ï¼‰ä¸‰ä¸ªå…³é”®æ¨¡å—
- åŸºäº Python è¯­è¨€å®ç°
- éƒ¨ç½²ç®€å•ï¼ŒåŸºäº python å’Œ SSH (é»˜è®¤å·²å®‰è£…)ï¼Œagentlessï¼Œæ— éœ€ä»£ç†ä¸ä¾èµ– PKIï¼ˆæ— éœ€ sslï¼‰
- å®‰å…¨ï¼ŒåŸºäº OpenSSH
- å¹‚ç­‰æ€§ï¼šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ1éå’Œæ‰§è¡Œ n éæ•ˆæœä¸€æ ·ï¼Œä¸å› é‡å¤æ‰§è¡Œå¸¦æ¥æ„å¤–æƒ…å†µ
- æ”¯æŒ playbook ç¼–æ’ä»»åŠ¡ï¼ŒYAML æ ¼å¼ï¼Œç¼–æ’ä»»åŠ¡ï¼Œæ”¯æŒä¸°å¯Œçš„æ•°æ®ç»“æ„
- è¾ƒå¼ºå¤§çš„å¤šå±‚è§£å†³æ–¹æ¡ˆ role
### 2.3 Ansible æ¶æ„
#### 2.3.1 Ansible ç»„æˆ
![]({{ site.url }}{{ site.baseurl }}/assets/images/ansible-06.png){: .align-left}
ç»„åˆ INVENTORYã€APIã€MODULESã€PLUGINS çš„ç»¿æ¡†ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ ansible å‘½ä»¤å·¥å…·ï¼Œå…¶ä¸ºæ ¸å¿ƒæ‰§è¡Œå·¥å…·ã€‚

- INVENTORYï¼šAnsible ç®¡ç†ä¸»æœºçš„æ¸…å• `/etc/anaible/hosts`
- MODULESï¼šAnsible æ‰§è¡Œå‘½ä»¤çš„åŠŸèƒ½æ¨¡å—ï¼Œå¤šæ•°ä¸ºå†…ç½®æ ¸å¿ƒæ¨¡å—ï¼Œä¹Ÿå¯è‡ªå®šä¹‰
- PLUGINSï¼šæ¨¡å—åŠŸèƒ½çš„è¡¥å……ï¼Œå¦‚è¿æ¥ç±»å‹æ’ä»¶ã€å¾ªç¯æ’ä»¶ã€å˜é‡æ’ä»¶ã€è¿‡æ»¤æ’ä»¶ç­‰ï¼Œè¯¥åŠŸèƒ½ä¸å¸¸ç”¨
- APIï¼šä¾›ç¬¬ä¸‰æ–¹ç¨‹åºè°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£
#### 2.3.2 Ansible å‘½ä»¤æ‰§è¡Œæ¥æº
- USER æ™®é€šç”¨æˆ·ï¼Œå³ SYSTEM ADMINISTRATOR
- PLAYBOOKSï¼šä»»åŠ¡å‰§æœ¬ï¼ˆä»»åŠ¡é›†ï¼‰ï¼Œç¼–æ’å®šä¹‰ Ansible ä»»åŠ¡é›†çš„é…ç½®æ–‡ä»¶ï¼Œç”± Ansible é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œé€šå¸¸æ˜¯ JSON æ ¼å¼çš„ YML æ–‡ä»¶
- CMDBï¼ˆé…ç½®ç®¡ç†æ•°æ®åº“ï¼‰ API è°ƒç”¨
- PUBLIC/PRIVATE CLOUD API è°ƒç”¨
- USER -> Ansible Playbook -> Ansibile
#### 2.3.3 æ³¨æ„äº‹é¡¹
- æ‰§è¡Œ ansible çš„ä¸»æœºä¸€èˆ¬ç§°ä¸ºä¸»æ§ç«¯ï¼Œä¸­æ§ï¼Œmaster æˆ–å ¡å’æœº
- ä¸»æ§ç«¯ Python ç‰ˆæœ¬éœ€è¦2.6æˆ–ä»¥ä¸Š
- è¢«æ§ç«¯ Python ç‰ˆæœ¬å°äº2.4ï¼Œéœ€è¦å®‰è£… python-simplejson
- è¢«æ§ç«¯å¦‚å¼€å¯ SELinux éœ€è¦å®‰è£… libselinux-python
- windows ä¸èƒ½åšä¸ºä¸»æ§ç«¯
## 3. Ansible å®‰è£…å’Œå…¥é—¨
### 3.1 Ansible å®‰è£…
Ansible çš„å®‰è£…æ–¹æ³•æœ‰å¤šç§
#### 3.1.1 EPEL æºçš„ rpm åŒ…å®‰è£…
```shell
$ yum install epel-release -y
$ yum install ansible -y
```
#### 3.1.2 ç¼–è¯‘å®‰è£…
```shell
$ yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto
$ tar xf ansible-1.5.4.tar.gz
$ cd ansible-1.5.4
$ python setup.py build
$ python setup.py install
$ mkdir /etc/ansible
$ cp -r examples/* /etc/ansible
```
#### 3.1.3 Gitæ–¹å¼
```shell
$ git clone git://github.com/ansible/ansible.git --recursive
$ cd ./ansible
$ source ./hacking/env-setup
```
#### 3.1.4 pip å®‰è£…
pip æ˜¯å®‰è£… Python åŒ…çš„ç®¡ç†å™¨ï¼Œç±»ä¼¼ yum
```shell
$ yum install python-pip python-devel
$ yum install gcc glibc-devel zibl-devel  rpm-bulid openssl-devel
$ pip install  --upgrade pip
$ pip install ansible --upgrade
```
#### 3.1.5 ç¡®è®¤å®‰è£…
```shell
$ ansible --version
ansible 2.9.5
  config file = /etc/ansible/ansible.cfg
  configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3.6/site-packages/ansible
  executable location = /usr/bin/ansible
  python version = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507 (Red Hat 8.3.1-4)]
```
### 3.2 Ansible ç›¸å…³æ–‡ä»¶

#### 3.2.1 é…ç½®æ–‡ä»¶

- **`/etc/ansible/ansible.cfg`**ï¼šä¸»é…ç½®æ–‡ä»¶ï¼Œé…ç½® ansible å·¥ä½œç‰¹æ€§
- **`/etc/ansible/hosts`**ï¼šä¸»æœºæ¸…å•æ–‡ä»¶
- **`/etc/ansible/roles`**ï¼šå­˜æ”¾è§’è‰²çš„ç›®å½•

#### 3.2.2 Ansible ä¸»é…ç½®æ–‡ä»¶

Ansible ä¸»é…ç½®æ–‡ä»¶ `/etc/ansible/ansible.cfg` çš„å¤§éƒ¨åˆ†é…ç½®å†…å®¹æ— éœ€ä¿®æ”¹

```ini
[defaults]
#inventory     = /etc/ansible/hosts      # ä¸»æœºåˆ—è¡¨é…ç½®æ–‡ä»¶
#library       = /usr/share/my_modules/  # åº“æ–‡ä»¶å­˜æ”¾ç›®å½•
#remote_tmp    = $HOME/.ansible/tmp      # ä¸´æ—¶ py å‘½ä»¤æ–‡ä»¶å­˜æ”¾åœ¨è¿œç¨‹ä¸»æœºç›®å½•
#local_tmp     = $HOME/.ansible/tmp      # æœ¬æœºçš„ä¸´æ—¶å‘½ä»¤æ‰§è¡Œç›®å½•  
#forks         = 5                       # é»˜è®¤å¹¶å‘æ•°,åŒæ—¶å¯ä»¥æ‰§è¡Œ5æ¬¡
#sudo_user     = root                    # é»˜è®¤ sudo ç”¨æˆ·
#ask_sudo_pass = True                    # æ¯æ¬¡æ‰§è¡Œ ansible å‘½ä»¤æ˜¯å¦è¯¢é—® ssh å¯†ç 
#ask_pass      = True                    # æ¯æ¬¡æ‰§è¡Œ ansible å‘½ä»¤æ˜¯å¦è¯¢é—® ssh å£ä»¤
#remote_port   = 22                      # è¿œç¨‹ä¸»æœºçš„ç«¯å£å·(é»˜è®¤22)

# å»ºè®®ä¼˜åŒ–é¡¹ï¼š 
host_key_checking = False               # æ£€æŸ¥å¯¹åº”æœåŠ¡å™¨çš„ host_keyï¼Œå»ºè®®å–æ¶ˆæ³¨é‡Š
log_path=/var/log/ansible.log           # æ—¥å¿—æ–‡ä»¶,å»ºè®®å–æ¶ˆæ³¨é‡Š
module_name   = command                 # é»˜è®¤æ¨¡å—,å¯ä¿®æ”¹ä¸º shell æ¨¡å—
```

#### 3.2.3 inventory ä¸»æœºæ¸…å•

Ansible çš„ä¸»è¦åŠŸç”¨åœ¨äºæ‰¹é‡ä¸»æœºæ“ä½œï¼Œä¸ºäº†ä¾¿æ·åœ°ä½¿ç”¨å…¶ä¸­çš„éƒ¨åˆ†ä¸»æœºï¼Œå¯ä»¥åœ¨ inventory file ä¸­å°†å…¶åˆ†ç»„å‘½åï¼›

é»˜è®¤çš„ inventory file ä¸º `/etc/ansible/hosts` ï¼›

inventory file å¯ä»¥æœ‰å¤šä¸ªï¼Œä¸”ä¹Ÿå¯ä»¥é€šè¿‡ Dynamic Inventory æ¥åŠ¨æ€ç”Ÿæˆã€‚

**ä¸»æœºæ¸…å•æ–‡ä»¶æ ¼å¼ï¼š**

inventory æ–‡ä»¶éµå¾ª INI æ–‡ä»¶é£æ ¼ï¼Œä¸­æ‹¬å·ä¸­çš„å­—ç¬¦ä¸ºç»„åï¼Œå¯ä»¥å°†åŒä¸€ä¸ªä¸»æœºåŒæ—¶å½’å¹¶åˆ°å¤šä¸ªä¸åŒçš„ç»„ä¸­ï¼›

æ­¤å¤–ï¼Œå½“å¦‚è‹¥ç›®æ ‡ä¸»æœºä½¿ç”¨äº†éé»˜è®¤çš„ SSH ç«¯å£ï¼Œè¿˜å¯ä»¥åœ¨ä¸»æœºåç§°ä¹‹åä½¿ç”¨å†’å·åŠ ç«¯å£å·æ¥æ ‡æ˜ï¼›

å¦‚æœä¸»æœºåç§°éµå¾ªç›¸ä¼¼çš„å‘½åæ¨¡å¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åˆ—è¡¨çš„æ–¹å¼æ ‡è¯†å„ä¸»æœºã€‚

```ini
ntp.magedu.com

[webservers]
www1.magedu.com:2222
www2.magedu.com
    
[dbservers]
db1.magedu.com
db2.magedu.com
db3.magedu.com

[websrvs]
www[1:100].example.com

[dbsrvs]
db-[a:f].example.com

[appsrvs]
10.0.0.[1:100]
```

### 3.3 Ansible ç›¸å…³å·¥å…·

- **/usr/bin/ansibleï¼š**ä¸»ç¨‹åºï¼Œä¸´æ—¶å‘½ä»¤æ‰§è¡Œå·¥å…·
- **/usr/bin/ansible-docï¼š**æŸ¥çœ‹é…ç½®æ–‡æ¡£ï¼Œæ¨¡å—åŠŸèƒ½æŸ¥çœ‹å·¥å…·
- **/usr/bin/ansible-galaxyï¼š**ä¸‹è½½/ä¸Šä¼ ä¼˜ç§€ä»£ç æˆ– Roles æ¨¡å—çš„å®˜ç½‘å¹³å°
- **/usr/bin/ansible-playbookï¼š**å®šåˆ¶è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œç¼–æ’å‰§æœ¬å·¥å…·
- **/usr/bin/ansible-pullï¼š**è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å·¥å…·
- **/usr/bin/ansible-vaultï¼š**æ–‡ä»¶åŠ å¯†å·¥å…·
- **/usr/bin/ansible-consoleï¼š**åŸºäº Console ç•Œé¢ä¸ç”¨æˆ·äº¤äº’çš„æ‰§è¡Œå·¥å…·

**åˆ©ç”¨ Ansible å®ç°ç®¡ç†çš„ä¸»è¦æ–¹å¼ï¼š**

- **Ad-Hocï¼š**å³åˆ©ç”¨ ansible å‘½ä»¤ï¼Œä¸»è¦ç”¨äºä¸´æ—¶å‘½ä»¤ä½¿ç”¨åœºæ™¯
- **Ansible-playbookï¼š**ä¸»è¦ç”¨äºé•¿æœŸè§„åˆ’å¥½çš„ï¼Œå¤§å‹é¡¹ç›®çš„åœºæ™¯ï¼Œéœ€è¦æœ‰å‰æœŸçš„è§„åˆ’è¿‡ç¨‹

#### 3.3.1 ansible-doc

æ­¤å·¥å…·ç”¨æ¥æ˜¾ç¤ºæ¨¡å—å¸®åŠ©

æ ¼å¼ï¼š

```shell
ansible-doc [options] [module...]
-l, --list          # åˆ—å‡ºå¯ç”¨æ¨¡å—
-s, --snippet       # æ˜¾ç¤ºæŒ‡å®šæ¨¡å—çš„playbookç‰‡æ®µ
```

èŒƒä¾‹ï¼š

```shell
# åˆ—å‡ºæ‰€æœ‰æ¨¡å—
$ ansible-doc -l  
# æŸ¥çœ‹æŒ‡å®šæ¨¡å—å¸®åŠ©ç”¨æ³•
$ ansible-doc ping  
# æŸ¥çœ‹æŒ‡å®šæ¨¡å—å¸®åŠ©ç”¨æ³•
$ ansible-doc -s  ping 
```

#### 3.3.2 ansible

æ­¤å·¥å…·é€šè¿‡ ssh åè®®ï¼Œå®ç°å¯¹è¿œç¨‹ä¸»æœºçš„é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€ä»»åŠ¡æ‰§è¡Œç­‰åŠŸèƒ½

å»ºè®®ï¼šä½¿ç”¨æ­¤å·¥å…·å‰ï¼Œå…ˆé…ç½® ansible ä¸»æ§ç«¯èƒ½åŸºäºå¯†é’¥è®¤è¯çš„æ–¹å¼è”ç³»å„ä¸ªè¢«ç®¡ç†èŠ‚ç‚¹

èŒƒä¾‹ï¼šåˆ©ç”¨ sshpass æ‰¹é‡å®ç°åŸºäº key éªŒè¯

```sh
#!/bin/bash
ssh-keygen -f /root/.ssh/id_rsa  -P ''
NET=192.168.100
export SSHPASS=magedu
for IP in {1..200};do 
    sshpass -e ssh-copy-id  $NET.$IP 
done
```

##### Ansible å‘½ä»¤æ ¼å¼

```
ansible <host-pattern> [-m module_name] [-a args]
```

é€‰é¡¹è¯´æ˜ï¼š

```shell
--version               # æ˜¾ç¤ºç‰ˆæœ¬
-m module               # æŒ‡å®šæ¨¡å—ï¼Œé»˜è®¤ä¸º command
-v                      # è¯¦ç»†è¿‡ç¨‹â€“vv, -vvv æ›´è¯¦ç»†
--list-hosts            # æ˜¾ç¤ºä¸»æœºåˆ—è¡¨ï¼Œå¯ç®€å†™ --list
-k, --ask-pass          # æç¤ºè¾“å…¥ ssh è¿æ¥å¯†ç ï¼Œé»˜è®¤ Key éªŒè¯    
-C, --check             # æ£€æŸ¥ï¼Œå¹¶ä¸æ‰§è¡Œ
-T, --timeout=TIMEOUT   # æ‰§è¡Œå‘½ä»¤çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤10s
-u, --user=REMOTE_USER  # æ‰§è¡Œè¿œç¨‹æ‰§è¡Œçš„ç”¨æˆ·
-b, --become            # ä»£æ›¿æ—§ç‰ˆçš„ sudo åˆ‡æ¢
--become-user=USERNAME  # æŒ‡å®š sudo çš„ runas ç”¨æˆ·ï¼Œé»˜è®¤ä¸º root
-K, --ask-become-pass   # æç¤ºè¾“å…¥ sudo æ—¶çš„å£ä»¤
```

##### Ansible host-pattern

ç”¨äºåŒ¹é…è¢«æ§åˆ¶çš„ä¸»æœºçš„åˆ—è¡¨

ä¸‹è¡¨åˆ—å‡ºäº†é’ˆå¯¹æ¸…å•ä¸»æœºå’Œç»„çš„å¸¸è§æ¨¡å¼

| æè¿°     | Pattern(s)ï¼ˆæ¨¡å¼ï¼‰           | ç›®æ ‡                                             |
| -------- | ---------------------------- | ------------------------------------------------ |
| æ‰€æœ‰ä¸»æœº | `all` (æˆ– `*`)               |                                                  |
| ä¸€å°ä¸»æœº | host1                        |                                                  |
| å¤šå°ä¸»æœº | host1:host2 (æˆ– host1,host2) |                                                  |
| ä¸€ç»„     | websrvs                      |                                                  |
| å¤šç»„     | websrvs:dbsrvs               | websrvs ç»„ä¸­çš„æ‰€æœ‰ä¸»æœºåŠ ä¸Š dbsrvs ç»„ä¸­çš„æ‰€æœ‰ä¸»æœº |
| æ’é™¤ç»„   | websrvs:!atlanta             | åœ¨ websrvs ç»„ä½†ä¸åœ¨ atlanta ç»„ä¸­çš„æ‰€æœ‰ä¸»æœº       |
| ç»„çš„äº¤é›† | websrvs:&staging             | åœ¨ websrvs ç»„å¹¶ä¸”åœ¨ staging ç»„ä¸­çš„æ‰€æœ‰ä¸»æœº       |

**`all`**  è¡¨ç¤ºæ‰€æœ‰ Inventory ä¸­çš„æ‰€æœ‰ä¸»æœº

```shell
$ ansible all â€“m ping
```

**`*`**  é€šé…ç¬¦

```shell
$ ansible  "*"  -m ping
$ ansible  192.168.1.* -m ping
$ ansible  "svc"  -m ping
```

**`:`**  æˆ–å…³ç³»

```shell
$ ansible "websrvs:appsrvs"  -m ping 
$ ansible "192.168.1.10:192.168.1.20"  -m ping
```

**`:&`**  é€»è¾‘ä¸

```shell
# åœ¨ websrvs ç»„å¹¶ä¸”åœ¨ dbsrvs ç»„ä¸­çš„ä¸»æœº
$ ansible "websrvs:&dbsrvs" â€“m ping 
```

**`:!`**  é€»è¾‘é

```shell
# åœ¨ websrvs ç»„ï¼Œä½†ä¸åœ¨ dbsrvs ç»„ä¸­çš„ä¸»æœº
# æ³¨æ„ï¼šæ­¤å¤„ä¸ºå•å¼•å·
$ ansible 'websrvs:!dbsrvs' â€“m ping 
```

**ç»¼åˆé€»è¾‘**

```shell
# åœ¨ websrvs ç»„æˆ– dbsrvs ç»„ï¼Œå¹¶ä¸”åœ¨ appsrvs ç»„ï¼Œè€Œä¸”ä¸åœ¨ ftpsvc ç»„
$ ansible 'websrvs:dbsrvs:&appsrvs:!ftpsvc' â€“m ping
```

**æ­£åˆ™è¡¨è¾¾å¼**

```shell
$ ansible "websrvs:&dbsrvs" â€“m ping 
$ ansible "~(web|db).*\.magedu\.com" â€“m ping 
```

##### Ansible å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹

1. åŠ è½½è‡ªå·±çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ `/etc/ansible/ansible.cfg`

2. åŠ è½½è‡ªå·±å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚ï¼š`command`

3. é€šè¿‡ ansible å°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆå¯¹åº”çš„ä¸´æ—¶ `.py` æ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³è¿œç¨‹æœåŠ¡å™¨çš„å¯¹åº”æ‰§è¡Œç”¨æˆ·çš„å®¶ç›®å½•ï¼Œé»˜è®¤ä½ç½®ï¼š`$HOME/.ansible/tmp/ansible-tmp-æ•°å­—/xxx.py`

4. ç»™æ–‡ä»¶æ‰§è¡Œæƒé™ `+x`

5. æ‰§è¡Œå¹¶è¿”å›ç»“æœ

6. åˆ é™¤ä¸´æ—¶ `.py` æ–‡ä»¶ï¼Œé€€å‡º

##### Ansible çš„æ‰§è¡ŒçŠ¶æ€

```shell
$ grep -A 14 '\[colors\]' /etc/ansible/ansible.cfg 
[colors]
#highlight = white
#verbose = blue
#warn = bright purple
#error = red
#debug = dark gray
#deprecate = purple
#skip = cyan
#unreachable = red
#ok = green
#changed = yellow
#diff_add = green
#diff_remove = red
#diff_lines = cyan
```

- <font color="#008000">ç»¿è‰²</font>ï¼šæ‰§è¡ŒæˆåŠŸå¹¶ä¸”ä¸éœ€è¦åšæ”¹å˜çš„æ“ä½œ
- <font color="FFFF00">é»„è‰²</font>ï¼šæ‰§è¡ŒæˆåŠŸå¹¶ä¸”å¯¹ç›®æ ‡ä¸»æœºåšå˜æ›´
- <font color="#FF0000">çº¢è‰²</font>ï¼šæ‰§è¡Œå¤±è´¥

##### Ansible ä½¿ç”¨èŒƒä¾‹

```shell
# ä»¥ wang ç”¨æˆ·æ‰§è¡Œ ping å­˜æ´»æ£€æµ‹
$ ansible all -m ping -u wang  -k
# ä»¥ wang ç”¨æˆ· sudo è‡³ root ç”¨æˆ·æ‰§è¡Œ ping å­˜æ´»æ£€æµ‹ï¼ˆé»˜è®¤ sudo è‡³ root ç”¨æˆ·ï¼‰
$ ansible all -m ping -u wang -k -b
# ä»¥ wang ç”¨æˆ· sudo è‡³ mage ç”¨æˆ·æ‰§è¡Œ ping å­˜æ´»æ£€æµ‹
$ ansible all -m ping -u wang -k -b --become-user=mage
# ä»¥ wang ç”¨æˆ· sudo è‡³ root ç”¨æˆ·æ‰§è¡Œ ls å‘½ä»¤
$ ansible all -m command  -u wang -a 'ls /root' -b --become-user=root   -k -K
```

#### 3.3.3 ansible-galaxy

æ­¤å·¥å…·ä¼šè¿æ¥ [Ansible Galaxy](https://galaxy.ansible.com/) ä¸‹è½½ç›¸åº”çš„ roles

èŒƒä¾‹ï¼š

```shell
# åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„ galaxy
$ ansible-galaxy list
# å®‰è£… galaxy
$ ansible-galaxy install geerlingguy.mysql
$ ansible-galaxy install geerlingguy.redis
# åˆ é™¤ galaxy
$ ansible-galaxy remove geerlingguy.redis
```

#### 3.3.4 ansible-pull

æ­¤å·¥å…·ä¼šæ¨é€ ansible çš„å‘½ä»¤è‡³è¿œç¨‹ï¼Œæ•ˆç‡æ— é™æå‡ï¼Œå¯¹è¿ç»´è¦æ±‚è¾ƒé«˜

#### 3.3.5 ansible-playbook

æ­¤å·¥å…·ç”¨äºæ‰§è¡Œç¼–å†™å¥½çš„ playbook ä»»åŠ¡

èŒƒä¾‹ï¼š

```shell
$ ansible-playbook hello.yml
$ cat  hello.yml
---
#hello world yml file
- hosts: websrvs
  remote_user: root  
  tasks:
    - name: hello world
      command: /usr/bin/wall hello world
```

#### 3.3.6 ansible-vault

æ­¤å·¥å…·å¯ä»¥ç”¨äºåŠ è§£å¯† yml æ–‡ä»¶

æ ¼å¼ï¼š

```shell
ansible-vault [create|decrypt|edit|encrypt|rekey|view]
```

èŒƒä¾‹ï¼š

```shell
$ ansible-vault encrypt hello.yml     # åŠ å¯†
$ ansible-vault decrypt hello.yml     # è§£å¯†
$ ansible-vault view hello.yml        # æŸ¥çœ‹
$ ansible-vault edit  hello.yml       # ç¼–è¾‘åŠ å¯†æ–‡ä»¶
$ ansible-vault rekey  hello.yml      # ä¿®æ”¹å£ä»¤
$ ansible-vault create new.yml        # åˆ›å»ºæ–°æ–‡ä»¶
```

#### 3.3.7 ansible-console

æ­¤å·¥å…·å¯äº¤äº’æ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒ tabï¼Œansible 2.0+ æ–°å¢

æç¤ºç¬¦æ ¼å¼ï¼š

```
æ‰§è¡Œç”¨æˆ·@å½“å‰æ“ä½œçš„ä¸»æœºç»„ (å½“å‰ç»„çš„ä¸»æœºæ•°é‡)[f:å¹¶å‘æ•°]$
```

å¸¸ç”¨å­å‘½ä»¤ï¼š

- è®¾ç½®å¹¶å‘æ•°ï¼š `forks n`   ä¾‹å¦‚ï¼š forks 10
- åˆ‡æ¢ç»„ï¼š `cd ä¸»æœºç»„`   ä¾‹å¦‚ï¼š cd web
- åˆ—å‡ºå½“å‰ç»„ä¸»æœºåˆ—è¡¨ï¼š `list`
- åˆ—å‡ºæ‰€æœ‰çš„å†…ç½®å‘½ä»¤ï¼š `?`æˆ– `help`

èŒƒä¾‹ï¼š

```shell
$ ansible-console
Welcome to the ansible console.
Type help or ? to list commands.

root@all (3)[f:5]$ list
10.0.0.8
10.0.0.7
10.0.0.6
root@all (3)[f:5]$ cd websrvs
root@websrvs (2)[f:5]$ list
10.0.0.7
10.0.0.8
root@websrvs (2)[f:5]$ forks 10
root@websrvs (2)[f:10]$ cd appsrvs
root@appsrvs (2)[f:5]$ yum name=httpd state=present
root@appsrvs (2)[f:5]$ service name=httpd state=started
```

### 3.4 Ansible å¸¸ç”¨æ¨¡å—

2015å¹´åº•270å¤šä¸ªæ¨¡å—ï¼Œ2016å¹´è¾¾åˆ°540ä¸ªï¼Œ2018å¹´01æœˆ12æ—¥æœ‰1378ä¸ªæ¨¡å—ï¼Œ2018å¹´07æœˆ15æ—¥1852ä¸ªæ¨¡å—ï¼Œ2019å¹´05æœˆ25æ—¥ï¼ˆansible 2.7.10ï¼‰æ—¶2080ä¸ªæ¨¡å—ï¼Œ2020å¹´03æœˆ02æ—¥æœ‰3387ä¸ªæ¨¡å—ã€‚

è™½ç„¶æ¨¡å—ä¼—å¤šï¼Œä½†æœ€å¸¸ç”¨çš„æ¨¡å—ä¹Ÿå°±äºŒä¸‰åä¸ªè€Œå·²ï¼Œé’ˆå¯¹ç‰¹å®šä¸šåŠ¡åªç”¨åå‡ ä¸ªæ¨¡å—ã€‚

æ¨¡å—å¸®åŠ©æ–‡æ¡£ï¼š[Index of all Modules â€” Ansible Documentation](https://docs.ansible.com/ansible/latest/collections/index_module.html)

#### 3.4.1 Command æ¨¡å—

åŠŸèƒ½ï¼šåœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œå‘½ä»¤ï¼Œæ­¤æ¨¡å—ä¸ºé»˜è®¤æ¨¡å—ï¼Œå¯å¿½ç•¥ `-m` é€‰é¡¹

æ³¨æ„ï¼šæ­¤å‘½ä»¤ä¸æ”¯æŒ `$VARNAME`ã€`<`ã€`>`ã€`|`ã€`;`ã€`&` ç­‰ï¼Œéœ€è¦ç”¨ shell æ¨¡å—å®ç°

èŒƒä¾‹ï¼š

```shell
$ ansible websrvs -m command -a 'chdir=/etc cat centos-release'
10.0.0.7 | CHANGED | rc=0 >>
CentOS Linux release 7.7.1908 (Core)
10.0.0.8 | CHANGED | rc=0 >>
CentOS Linux release 8.1.1911 (Core)
$ ansible websrvs -m command -a 'chdir=/etc creates=/data/f1.txt cat centos-release'
10.0.0.7 | CHANGED | rc=0 >>
CentOS Linux release 7.7.1908 (Core)
10.0.0.8 | SUCCESS | rc=0 >>
skipped, since /data/f1.txt exists
$ ansible websrvs -m command -a 'chdir=/etc removes=/data/f1.txt cat centos-release'
10.0.0.7 | SUCCESS | rc=0 >>
skipped, since /data/f1.txt does not exist
10.0.0.8 | CHANGED | rc=0 >>
CentOS Linux release 8.1.1911 (Core)

$ ansible websrvs -m command -a 'service vsftpd start'
$ ansible websrvs -m command -a 'rm -rf /data/'

# ä»¥ä¸‹ä¸ºé”™è¯¯ç¤ºä¾‹ï¼Œå› ä¸º command æ¨¡å—ä¸æ”¯æŒ |, >, $
$ ansible websrvs -m command -a 'echo magedu |passwd --stdin wang'
$ ansible websrvs -m command -a 'echo hello > /data/hello.log'
$ ansible websrvs -m command -a 'echo $HOSTNAME'
```

#### 3.4.2 Shell æ¨¡å—

åŠŸèƒ½ï¼šä¸ command æ¨¡å—ç›¸ä¼¼ï¼Œç”¨ shell æ¨¡å—æ‰§è¡Œå‘½ä»¤

èŒƒä¾‹ï¼š

```shell
$ ansible websrvs -m shell -a "echo $HOSTNAME"
10.0.0.7 | CHANGED | rc=0 >>
ansible
10.0.0.8 | CHANGED | rc=0 >>
ansible
# éœ€è¦æ¢æˆå•å¼•å·ï¼Œä¸ç„¶ä¼šè¾“å‡ºå½“å‰ä¸»æœºçš„ä¸»æœºå
$ ansible websrvs -m shell -a 'echo $HOSTNAME'
10.0.0.7 | CHANGED | rc=0 >>
centos7.wangxiaochun.com
10.0.0.8 | CHANGED | rc=0 >>
centos8.localdomain

$ ansible websrvs -m shell -a 'echo centos | passwd --stdin wang'
10.0.0.7 | CHANGED | rc=0 >>
Changing password for user wang.
passwd: all authentication tokens updated successfully.
10.0.0.8 | CHANGED | rc=0 >>
Changing password for user wang.
passwd: all authentication tokens updated successfully.
$ ansible websrvs -m shell -a 'ls -l /etc/shadow'
10.0.0.7 | CHANGED | rc=0 >>
---------- 1 root root 889 Mar  2 14:34 /etc/shadow
10.0.0.8 | CHANGED | rc=0 >>
---------- 1 root root 944 Mar  2 14:34 /etc/shadow
$ ansible websrvs -m shell -a 'echo hello > /data/hello.log'
10.0.0.7 | CHANGED | rc=0 >>

10.0.0.8 | CHANGED | rc=0 >>

$ ansible websrvs -m shell -a 'cat  /data/hello.log'
10.0.0.7 | CHANGED | rc=0 >>
hello
10.0.0.8 | CHANGED | rc=0 >>
hello
```

> **æ³¨æ„ï¼š**
>
> **é—®é¢˜ï¼š**è°ƒç”¨ bash æ‰§è¡Œå‘½ä»¤ï¼Œå½“æ‰§è¡Œç±»ä¼¼ `cat /tmp/test.md | awk -F'|' '{print $1,$2}' &> /tmp/example.txt` è¿™äº›å¤æ‚å‘½ä»¤æ—¶ï¼Œå³ä½¿ä½¿ç”¨ shell æ¨¡å—ä¹Ÿå¯èƒ½ä¼šå¤±è´¥ã€‚
>
> **è§£å†³åŠæ³•ï¼š**
>
> 1. æŠŠå¤æ‚å‘½ä»¤å†™åˆ°è„šæœ¬é‡Œé¢ï¼Œå°†è„šæœ¬ copy åˆ°è¿œç¨‹ä¸»æœºï¼Œç„¶åä½¿ç”¨ shell æ¨¡å—æ‰§è¡Œè„šæœ¬ï¼Œå†æŠŠéœ€è¦çš„ç»“æœæ‹‰å›æ‰§è¡Œå‘½ä»¤çš„æœºå™¨ã€‚å› ä¸ºè¿™ç§æ–¹å¼éœ€è¦äº‹å…ˆå°†è„šæœ¬æ‹·è´åˆ°è¿œç¨‹ä¸»æœºï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”å½“è¿œç¨‹ä¸»æœºæ•°é‡è¾ƒå¤šæ—¶ï¼Œå°±æ›´æ˜¾å¾—éº»çƒ¦äº†ï¼ˆè‡³å°‘éœ€è¦å†™ä¸€ä¸ª for å¾ªç¯æ¥æ‹·è´è„šæœ¬ï¼‰ã€‚
> 2. å¯ä»¥ç›´æ¥ä½¿ç”¨ script æ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—å°±æ˜¯ä¸“é—¨ç”¨æ¥åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œ ansible æœåŠ¡å™¨ä¸Šçš„è„šæœ¬ã€‚script æ¨¡å—ä¼šè‡ªåŠ¨å°† ansible ä¸»æœºä¸Šçš„è„šæœ¬æ‹·è´åˆ°è¿œç¨‹ä¸»æœºç„¶åå†æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åä¼šåˆ é™¤æ‹·è´åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„è„šæœ¬ã€‚åœ¨ ansible æœåŠ¡å™¨ä¸Šä½¿ç”¨ ansible å‘½ä»¤è°ƒç”¨ script æ¨¡å—æ—¶ï¼Œåœ¨å‘½ä»¤è¿˜æ²¡æ‰§è¡Œå®Œæ¯•å‰ä½¿ç”¨ `Ctrl + C` ç»“æŸå‘½ä»¤ï¼ˆå‡è®¾è„šæœ¬å·²ç»æ‹·è´åˆ°è¿œç¨‹ä¸»æœºï¼‰ï¼Œè¿™æ—¶ ansible ä¹Ÿä¼šåˆ é™¤è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„è„šæœ¬ ï¼ˆä¸ç•™ä¸€ç‚¹ç—•è¿¹ğŸ˜)ã€‚

ä¿®æ”¹é»˜è®¤æ¨¡å—ï¼Œå°† shell æ¨¡å—è®¾ç½®ä¸ºé»˜è®¤æ¨¡å—

```shell
$ vim /etc/ansible/ansible.cfg
# ä¿®æ”¹ä¸‹é¢ä¸€è¡Œ
module_name = shell
```

#### 3.4.3 Script æ¨¡å—

åŠŸèƒ½ï¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šè¿è¡Œ ansible æœåŠ¡å™¨ä¸Šçš„è„šæœ¬

èŒƒä¾‹ï¼š

```shell
$ ansible websrvs  -m script -a /data/test.sh
```

#### 3.4.4 Copy æ¨¡å—

åŠŸèƒ½ï¼šä» ansible æœåŠ¡å™¨ä¸»æ§ç«¯å¤åˆ¶æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœº

```shell
# å¦‚ç›®æ ‡å­˜åœ¨ï¼Œé»˜è®¤è¦†ç›–ï¼Œæ­¤å¤„æŒ‡å®šå…ˆå¤‡ä»½
$ ansible websrvs -m copy -a "src=/root/test1.sh dest=/tmp/test2.sh owner=wang mode=600 backup=yes"
# æŒ‡å®šå†…å®¹ï¼Œç›´æ¥ç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶å­˜åœ¨åˆ™ç›´æ¥è¦†ç›–å…¶å†…å®¹
$ ansible websrvs -m copy -a "content='aluopy https://aluopy.cn\nhallo aluopy\n' dest=/tmp/test.txt"
# å¤åˆ¶ /etc/ ä¸‹çš„æ–‡ä»¶ï¼Œä¸åŒ…æ‹¬ /etc/ ç›®å½•è‡ªèº«
$ ansible websrvs -m copy -a "src=/etc/ dest=/backup"
```

#### 3.4.5 Fetch æ¨¡å—

åŠŸèƒ½ï¼šä»è¿œç¨‹ä¸»æœºæå–æ–‡ä»¶è‡³ ansible çš„ä¸»æ§ç«¯ï¼Œä¸ copy æ¨¡å—ç›¸åï¼Œç›®å‰ä¸æ”¯æŒç›®å½•

```shell
$ ansible websrvs -m fetch -a 'src=/root/test.sh dest=/data/scripts'
$ ansible all -m fetch -a 'src=/etc/redhat-release dest=/data/os'
$ tree /data/os/
/data/os/
â”œâ”€â”€ 10.0.0.6
â”‚   â””â”€â”€ etc
â”‚       â””â”€â”€ redhat-release
â”œâ”€â”€ 10.0.0.7
â”‚   â””â”€â”€ etc
â”‚       â””â”€â”€ redhat-release
â””â”€â”€ 10.0.0.8
    â””â”€â”€ etc
        â””â”€â”€ redhat-release

6 directories, 3 files
```

#### 3.4.6 File æ¨¡å—

åŠŸèƒ½ï¼šè®¾ç½®æ–‡ä»¶å±æ€§

```shell
# åˆ›å»ºç©ºæ–‡ä»¶
$ ansible all -m file -a 'path=/data/test.txt state=touch'
$ ansible all -m file -a 'path=/data/test.txt state=absent'
$ ansible all -m file -a "path=/root/test.sh owner=wang mode=755"
# åˆ›å»ºç›®å½•
$ ansible all -m file -a "path=/data/mysql state=directory owner=mysql group=mysql"
# åˆ›å»ºè½¯é“¾æ¥
$ ansible all -m file -a 'src=/data/testfile dest=/data/testfile-link state=link'
```

#### 3.4.7 unarchive æ¨¡å—

ç”¨äºåœ¨è¿œç¨‹ä¸»æœºä¸Šè§£åŒ…

å®ç°æœ‰ä¸‰ç§ç”¨æ³•ï¼š

1. **å…ˆæ‹·è´å†è§£åŒ…ï¼š**å°† ansible ä¸»æœºä¸Šçš„å‹ç¼©åŒ…ä¼ åˆ°è¿œç¨‹ä¸»æœºåè§£å‹ç¼©è‡³ç‰¹å®šç›®å½•ï¼Œè®¾ç½® `copy=yes` æˆ– `remote_src=no`

   > æ³¨æ„ï¼šåœ¨è§£åŒ…ä¹‹å‰å°†æºæ–‡ä»¶ä»æœ¬åœ°ç³»ç»Ÿå¤åˆ¶åˆ°ç›®æ ‡ä¸»æœºçš„ `$HOME/.ansible/tmp/ansible-tmp-æ•°å­—/` ç›®å½•ä¸‹

2. **ç›´æ¥è§£åŒ…ï¼š**å°†è¿œç¨‹ä¸»æœºä¸Šçš„æŸä¸ªå‹ç¼©åŒ…è§£å‹ç¼©åˆ°æŒ‡å®šè·¯å¾„ä¸‹ï¼Œè®¾ç½® `copy=no` æˆ– `remote_src=yes`

3. **å…ˆä¸‹è½½å†è§£åŒ…ï¼š**ä»æŒ‡å®šçš„ URL åœ°å€ä¸‹è½½æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœºå¹¶æ‰§è¡Œè§£åŒ…ï¼Œè®¾ç½® `copy=no` æˆ– `remote_src=yes` ä¸” src æŒ‡å®šçš„è·¯å¾„ä¸º URL åœ°å€

å¸¸è§å‚æ•°ï¼š

- `copy`ï¼šé»˜è®¤ä¸º yesï¼Œå³å…ˆå°†åŒ…æ–‡ä»¶ä» Ansible ä¸»æœºå¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºå†æ‰§è¡Œè§£åŒ…ï¼›è®¾ä¸º no æ—¶ï¼Œä¼šç›´æ¥åœ¨è¿œç¨‹ä¸»æœºä¸ŠæŸ¥æ‰¾ src æŒ‡å®šçš„æ–‡ä»¶ï¼Œæ‰¾åˆ°åæ‰§è¡Œè§£åŒ…ã€‚
- `remote_src`ï¼šå’Œ copy åŠŸèƒ½ä¸€æ ·ä¸”äº’æ–¥ï¼ŒäºŒè€…è®¾ç½®ä¸€ä¸ªå°±å¯ä»¥ã€‚é»˜è®¤ä¸º noï¼Œå³ä¸åœ¨è¿œç¨‹ä¸»æœºä¸ŠæŸ¥æ‰¾ src æŒ‡å®šçš„æ–‡ä»¶ï¼›è®¾ä¸º yes æ—¶ï¼Œä¼šç›´æ¥åœ¨è¿œç¨‹ä¸»æœºä¸ŠæŸ¥æ‰¾ src æŒ‡å®šçš„æ–‡ä»¶ï¼Œæ‰¾åˆ°åæ‰§è¡Œè§£åŒ…ã€‚
- `src`ï¼šåŒ…æ–‡ä»¶çš„è·¯å¾„ï¼Œæ˜¯åœ¨ Ansible ä¸»æœºä¸ŠæŸ¥æ‰¾ï¼Œè¿˜æ˜¯åœ¨è¿œç¨‹ä¸»æœºä¸ŠæŸ¥æ‰¾ï¼Œå–å†³äº copy æˆ– remote_src çš„è®¾ç½®ã€‚å½“è®¾ç½® copy=no æˆ–remote-src=yes ä¸” src æŒ‡å®šçš„è·¯å¾„ä¸­åŒ…å«`://`ï¼Œåˆ™ä¼šå…ˆä»æŒ‡å®šçš„ URL ä¸‹è½½æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœºç„¶åå†æ‰§è¡Œè§£åŒ…ï¼ˆè§£åŒ…ååˆ é™¤åŒ…æ–‡ä»¶ï¼‰ã€‚
- `dest`ï¼šè¿œç¨‹ä¸»æœºä¸Šçš„ç›®æ ‡è·¯å¾„ï¼Œç»å¯¹è·¯å¾„ã€‚
- `mode`ï¼šè®¾ç½®è§£åŒ…åçš„æ–‡ä»¶æˆ–ç›®å½•æƒé™ã€‚

```shell
# æ‹·è´ ansible ä¸»æœºä¸Šçš„ foo.tgz åŒ…å¹¶è§£å‹åˆ°è¿œç¨‹ä¸»æœºçš„ /var/lib/foo ç›®å½•
# dest ç›®å½•å¿…é¡»å­˜åœ¨, å‘½ä»¤è¿è¡Œå®Œæ¯•å foo.tgz åŒ…ä¸ä¼šå­˜åœ¨äº dest ç›®å½•
$ ansible all -m unarchive -a 'src=/data/foo.tgz dest=/var/lib/foo'
$ ansible all -m unarchive -a 'src=/tmp/foo.zip dest=/data copy=no mode=0777'
$ ansible all -m unarchive -a 'src=https://luojianjun.cn/download/apache-tomcat-9.0.55.tar.gz dest=/data copy=no'
```

#### 3.4.8 Archive æ¨¡å—

æ‰“åŒ…å‹ç¼©

```shell
# path: æºè·¯å¾„ï¼Œéœ€è¦æ‰“åŒ…çš„æ–‡ä»¶
# dest: å‹ç¼©æˆä»€ä¹ˆæ ¼å¼çš„åŒ…ï¼Œæ”¾åˆ°ä»€ä¹ˆä½ç½®
# owner: å±ä¸»
# mode: åŒ…æ–‡ä»¶æƒé™
$ ansible websrvs -m archive  -a 'path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600'
```

#### 3.4.9 Hostname æ¨¡å—

ç®¡ç†ä¸»æœºå

```shell
$ ansible node1 -m hostname -a â€œname=websrvâ€ 
$ ansible 192.168.100.18 -m hostname -a 'name=node18.magedu.com'
```

#### 3.4.10 Cron æ¨¡å—

è®¡åˆ’ä»»åŠ¡

æ”¯æŒæ—¶é—´ï¼šminuteï¼Œhourï¼Œdayï¼Œmonthï¼Œweekday

```shell
# å¤‡ä»½æ•°æ®åº“è„šæœ¬
$ cat mysql_backup.sh 
mysqldump -A -F --single-transaction --master-data=2 -q -uroot |gzip > /data/mysql_date+%F_%T.sql.gz
# åˆ›å»ºä»»åŠ¡
$ ansible 10.0.0.8 -m cron -a 'hour=2 minute=30 weekday=1-5 name="backup mysql" job=/root/mysql_backup.sh'
$ ansible websrvs   -m cron -a "minute=*/5 job='/usr/sbin/ntpdate 172.20.0.1 &>/dev/null' name=Synctime"
# ç¦ç”¨è®¡åˆ’ä»»åŠ¡
$ ansible websrvs   -m cron -a "minute=*/5 job='/usr/sbin/ntpdate 172.20.0.1 &>/dev/null' name=Synctime disabled=yes"
# å¯ç”¨è®¡åˆ’ä»»åŠ¡
$ ansible websrvs   -m cron -a "minute=*/5 job='/usr/sbin/ntpdate 172.20.0.1 &>/dev/null' name=Synctime disabled=no"
# åˆ é™¤ä»»åŠ¡
$ ansible websrvs -m cron -a "name='backup mysql' state=absent"
$ ansible websrvs -m cron -a 'state=absent name=Synctime'
```

#### 3.4.11 Yum æ¨¡å—

ç®¡ç†è½¯ä»¶åŒ…ï¼Œåªæ”¯æŒ RHELï¼ŒCentOSï¼Œfedoraï¼Œä¸æ”¯æŒ Ubuntu åŠå…¶å®ƒç‰ˆæœ¬

```shell
# å®‰è£…
$ ansible websrvs -m yum -a 'name=httpd state=present'
# åˆ é™¤
$ ansible websrvs -m yum -a 'name=httpd state=absent'
```

#### 3.4.12 Service æ¨¡å—

ç®¡ç†æœåŠ¡

```shell
$ ansible all -m service -a 'name=httpd state=started enabled=yes'
$ ansible all -m service -a 'name=httpd state=stopped'
$ ansible all -m service -a 'name=httpd state=reloadedâ€™
$ ansible all -m shell -a "sed -i 's/^Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf"
$ ansible all -m service -a 'name=httpd state=restarted' 
```

#### 3.4.13 User æ¨¡å—

ç®¡ç†ç”¨æˆ·

```shell
# åˆ›å»ºç”¨æˆ·
$ ansible all -m user -a 'name=user1 comment=â€œtest userâ€ uid=2048 home=/app/user1 group=root'
$ ansible all -m user -a 'name=nginx comment=nginx uid=88 group=nginx groups="root,daemon" shell=/sbin/nologin system=yes create_home=no home=/data/nginx non_unique=yes'

# åˆ é™¤ç”¨æˆ·åŠå®¶ç›®å½•ç­‰æ•°æ®
$ ansible all -m user -a 'name=nginx state=absent remove=yes'
```

#### 3.4.14 Group æ¨¡å—

ç®¡ç†ç»„

```shell
# åˆ›å»ºç»„
$ ansible websrvs -m group  -a 'name=nginx gid=88 system=yes'
# åˆ é™¤ç»„
$ ansible websrvs -m group  -a 'name=nginx state=absent'
```

#### 3.4.15 Lineinfile æ¨¡å—

ansible åœ¨ä½¿ç”¨ sed è¿›è¡Œæ›¿æ¢æ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°éœ€è¦è½¬ä¹‰çš„é—®é¢˜ï¼Œè€Œä¸” ansible åœ¨é‡åˆ°ç‰¹æ®Šç¬¦å·è¿›è¡Œæ›¿æ¢æ—¶ï¼Œå­˜åœ¨é—®é¢˜ï¼Œæ— æ³•æ­£å¸¸è¿›è¡Œæ›¿æ¢ ã€‚å…¶å® ansible è‡ªèº«æä¾›äº†ä¸¤ä¸ªæ¨¡å—ï¼šlineinfile æ¨¡å—å’Œ replace æ¨¡å—ï¼Œå¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œæ›¿æ¢ï¼Œç›¸å½“äºsedï¼Œå¯ä»¥ä¿®æ”¹æ–‡ä»¶å†…å®¹ã€‚

```shell
$ ansible all -m lineinfile -a "path=/etc/selinux/config regexp='^SELINUX=' line='SELINUX=enforcing'"
$ ansible all -m lineinfile -a 'dest=/etc/fstab state=absent regexp="^#"'
```

#### 3.4.16 Replace æ¨¡å—

è¯¥æ¨¡å—æœ‰ç‚¹ç±»ä¼¼äº sed å‘½ä»¤ï¼Œä¸»è¦ä¹Ÿæ˜¯åŸºäºæ­£åˆ™è¿›è¡ŒåŒ¹é…å’Œæ›¿æ¢

```shell
$ ansible all -m replace -a "path=/etc/fstab regexp='^(UUID.*)' replace='#\1'"  
$ ansible all -m replace -a "path=/etc/fstab regexp='^#(.*)' replace='\1'"
```

#### 3.4.17 Setup æ¨¡å—

setup æ¨¡å—æ¥æ”¶é›†ä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯ï¼Œè¿™äº› facts ä¿¡æ¯å¯ä»¥ç›´æ¥ä»¥å˜é‡çš„å½¢å¼ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœä¸»æœºè¾ƒå¤šï¼Œä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ï¼Œå¯ä»¥ä½¿ç”¨ `gather_facts: no` æ¥ç¦æ­¢ Ansible æ”¶é›† facts ä¿¡æ¯

```shell
$ ansible all -m setup
$ ansible all -m setup -a "filter=ansible_nodename"
$ ansible all -m setup -a "filter=ansible_hostname"
$ ansible all -m setup -a "filter=ansible_domain"
$ ansible all -m setup -a "filter=ansible_memtotal_mb"
$ ansible all -m setup -a "filter=ansible_memory_mb"
$ ansible all -m setup -a "filter=ansible_memfree_mb"
$ ansible all -m setup -a "filter=ansible_os_family"
$ ansible all -m setup -a "filter=ansible_distribution_major_version"
$ ansible all -m setup -a "filter=ansible_distribution_version"
$ ansible all -m setup -a "filter=ansible_processor_vcpus"
$ ansible all -m setup -a "filter=ansible_all_ipv4_addresses"
$ ansible all -m setup -a "filter=ansible_architecture"
$ ansible all -m setup -a "filter=ansible_processor*"

$ ansible all -m setup -a 'filter=ansible_python_version'
10.0.0.7 | SUCCESS => {
    "ansible_facts": {
        "ansible_python_version": "2.7.5",
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": false
}
10.0.0.6 | SUCCESS => {
    "ansible_facts": {
        "ansible_python_version": "2.6.6",
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": false
}
10.0.0.8 | SUCCESS => {
    "ansible_facts": {
        "ansible_python_version": "3.6.8",
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false
}
[root@ansible ~]#
```

## 4. Playbook

### 4.1 Playbook ä»‹ç»

playbook å‰§æœ¬æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ª â€œplayâ€ ç»„æˆçš„åˆ—è¡¨
play çš„ä¸»è¦åŠŸèƒ½åœ¨äºå°†é¢„å®šä¹‰çš„ä¸€ç»„ä¸»æœºï¼Œè£…æ‰®æˆäº‹å…ˆé€šè¿‡ ansible ä¸­çš„ task å®šä¹‰å¥½çš„è§’è‰²ã€‚Task å®é™…æ˜¯è°ƒç”¨ ansible çš„ä¸€ä¸ª moduleï¼Œå°†å¤šä¸ª play ç»„ç»‡åœ¨ä¸€ä¸ªplaybookä¸­ï¼Œå³å¯ä»¥è®©å®ƒä»¬è”åˆèµ·æ¥ï¼ŒæŒ‰äº‹å…ˆç¼–æ’çš„æœºåˆ¶æ‰§è¡Œé¢„å®šä¹‰çš„åŠ¨ä½œ
Playbook æ–‡ä»¶æ˜¯é‡‡ç”¨YAMLè¯­è¨€ç¼–å†™çš„

### 4.2 YAML è¯­è¨€

#### 4.2.1 YAMl è¯­è¨€ä»‹ç»

YAML æ˜¯ä¸€ä¸ªå¯è¯»æ€§é«˜çš„ç”¨æ¥è¡¨è¾¾èµ„æ–™åºåˆ—çš„æ ¼å¼ã€‚YAML å‚è€ƒäº†å…¶ä»–å¤šç§è¯­è¨€ï¼ŒåŒ…æ‹¬ï¼šXMLã€C è¯­è¨€ã€Pythonã€Perl ä»¥åŠç”µå­é‚®ä»¶æ ¼å¼ RFC2822ç­‰ã€‚Clark Evans åœ¨2001å¹´åœ¨é¦–æ¬¡å‘è¡¨äº†è¿™ç§è¯­è¨€ï¼Œå¦å¤– Ingy dÃ¶t Net ä¸ Oren Ben-Kiki ä¹Ÿæ˜¯è¿™è¯­è¨€çš„å…±åŒè®¾è®¡è€…,ç›®å‰å¾ˆå¤šè½¯ä»¶ä¸­é‡‡æœ‰æ­¤æ ¼å¼çš„æ–‡ä»¶ï¼Œå¦‚ ubuntuï¼Œanisbleï¼Œdockerï¼Œk8s ç­‰
YAMLï¼šYAML Ainâ€™t Markup Languageï¼Œå³ YAML ä¸æ˜¯ XMLã€‚ä¸è¿‡ï¼Œåœ¨å¼€å‘çš„è¿™ç§è¯­è¨€æ—¶ï¼ŒYAML çš„æ„æ€å…¶å®æ˜¯ï¼š"Yet Another Markup Language"ï¼ˆä»æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ï¼‰

YAML å®˜æ–¹ç½‘ç«™ï¼š[The Official YAML Web Site](https://yaml.org/)

#### 4.2.2 YAML è¯­è¨€ç‰¹æ€§

- YAML å¯è¯»æ€§å¥½
- YAML å’Œè„šæœ¬è¯­è¨€çš„äº¤äº’æ€§å¥½
- YAML ä½¿ç”¨å®ç°è¯­è¨€çš„æ•°æ®ç±»å‹
- YAML æœ‰ä¸€ä¸ªä¸€è‡´çš„ä¿¡æ¯æ¨¡å‹
- YAML æ˜“äºå®ç°
- YAML å¯ä»¥åŸºäºæµæ¥å¤„ç†
- YAML è¡¨è¾¾èƒ½åŠ›å¼ºï¼Œæ‰©å±•æ€§å¥½

#### 4.2.3 YAML è¯­æ³•ç®€ä»‹

- åœ¨å•ä¸€æ–‡ä»¶ç¬¬ä¸€è¡Œï¼Œç”¨è¿ç»­ä¸‰ä¸ªè¿å­—å·â€œ-â€ å¼€å§‹ï¼Œè¿˜æœ‰é€‰æ‹©æ€§çš„è¿ç»­ä¸‰ä¸ªç‚¹å·( â€¦ )ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶çš„ç»“å°¾
- æ¬¡è¡Œå¼€å§‹æ­£å¸¸å†™ Playbook çš„å†…å®¹ï¼Œä¸€èˆ¬å»ºè®®å†™æ˜è¯¥ Playbook çš„åŠŸèƒ½
- ä½¿ç”¨#å·æ³¨é‡Šä»£ç 
- ç¼©è¿›å¿…é¡»æ˜¯ç»Ÿä¸€çš„ï¼Œä¸èƒ½ç©ºæ ¼å’Œ tab æ··ç”¨
- ç¼©è¿›çš„çº§åˆ«ä¹Ÿå¿…é¡»æ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·çš„ç¼©è¿›ä»£è¡¨åŒæ ·çš„çº§åˆ«ï¼Œç¨‹åºåˆ¤åˆ«é…ç½®çš„çº§åˆ«æ˜¯é€šè¿‡ç¼©è¿›ç»“åˆæ¢è¡Œæ¥å®ç°çš„
  YAML æ–‡ä»¶å†…å®¹æ˜¯åŒºåˆ«å¤§å°å†™çš„ï¼Œkey/value çš„å€¼å‡éœ€å¤§å°å†™æ•æ„Ÿ
- å¤šä¸ª key/value å¯åŒè¡Œå†™ä¹Ÿå¯æ¢è¡Œå†™ï¼ŒåŒè¡Œä½¿ç”¨ `,` åˆ†éš”
- v å¯æ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯æ˜¯å¦ä¸€ä¸ªåˆ—è¡¨
- ä¸€ä¸ªå®Œæ•´çš„ä»£ç å—åŠŸèƒ½éœ€æœ€å°‘å…ƒç´ éœ€åŒ…æ‹¬ name å’Œ task
- ä¸€ä¸ª name åªèƒ½åŒ…æ‹¬ä¸€ä¸ª task
- YAML æ–‡ä»¶æ‰©å±•åé€šå¸¸ä¸º yml æˆ– yaml

YAML çš„è¯­æ³•å’Œå…¶ä»–é«˜é˜¶è¯­è¨€ç±»ä¼¼ï¼Œå¹¶ä¸”å¯ä»¥ç®€å•è¡¨è¾¾æ¸…å•ã€æ•£åˆ—è¡¨ã€æ ‡é‡ç­‰æ•°æ®ç»“æ„ã€‚å…¶ç»“æ„ï¼ˆStructureï¼‰é€šè¿‡ç©ºæ ¼æ¥å±•ç¤ºï¼Œåºåˆ—ï¼ˆSequenceï¼‰é‡Œçš„é¡¹ç”¨"-"æ¥ä»£è¡¨ï¼ŒMap é‡Œçš„é”®å€¼å¯¹ç”¨":"åˆ†éš”ï¼Œä¸‹é¢ä»‹ç»å¸¸è§çš„æ•°æ®ç»“æ„ã€‚

##### 4.2.3.1 List åˆ—è¡¨

åˆ—è¡¨ç”±å¤šä¸ªå…ƒç´ ç»„æˆï¼Œæ¯ä¸ªå…ƒç´ æ”¾åœ¨ä¸åŒè¡Œï¼Œä¸”å…ƒç´ å‰å‡ä½¿ç”¨â€œ-â€æ‰“å¤´ï¼Œæˆ–è€…å°†æ‰€æœ‰å…ƒç´ ç”¨ [ ] æ‹¬èµ·æ¥æ”¾åœ¨åŒä¸€è¡Œ

```yaml
# A list of tasty fruits
- Apple
- Orange
- Strawberry
- Mango

[Apple,Orange,Strawberry,Mango]
```

##### 4.2.3.2 Dictionary å­—å…¸

å­—å…¸ç”±å¤šä¸ª key ä¸ value æ„æˆï¼Œkey å’Œ value ä¹‹é—´ç”¨ `: ` åˆ†éš”ï¼Œæ‰€æœ‰ k/v å¯ä»¥æ”¾åœ¨ä¸€è¡Œï¼Œæˆ–è€…æ¯ä¸ª k/v åˆ†åˆ«æ”¾åœ¨ä¸åŒè¡Œ

```yaml
# An employee record
name: Example Developer
job: Developer
skill: Elite

# ä¹Ÿå¯ä»¥å°† key: value æ”¾ç½®äº{}ä¸­è¿›è¡Œè¡¨ç¤ºï¼Œç”¨,åˆ†éš”å¤šä¸ª key: value
# An employee record
{name: "Example Developer",job: "Developer",skill: "Elite"}

# ç¤ºä¾‹
name: John Smith
age: 41
gender: Male
spouse:
  name: Jane Smith
  age: 37
  gender: Female
children:
  - name: Jimmy Smith
    age: 17
    gender: Male
  - name: Jenny Smith
    age 13
    gender: Female
```

#### 4.2.4 ä¸‰ç§å¸¸è§çš„æ•°æ®æ ¼å¼

- **XML**ï¼šExtensible Markup Languageï¼Œå¯æ‰©å±•æ ‡è®°è¯­è¨€ï¼Œå¯ç”¨äºæ•°æ®äº¤æ¢å’Œé…ç½®
- **JSON**ï¼šJavaScript Object Notation, JavaScript å¯¹è±¡è¡¨è®°æ³•ï¼Œä¸»è¦ç”¨æ¥æ•°æ®äº¤æ¢æˆ–é…ç½®ï¼Œä¸æ”¯æŒæ³¨é‡Š
- **YAML**ï¼šYAML Ainâ€™t Markup Language YAML ä¸æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ï¼Œ ä¸»è¦ç”¨æ¥é…ç½®ï¼Œå¤§å°å†™æ•æ„Ÿï¼Œä¸æ”¯æŒ tab

![]({{ site.url }}{{ site.baseurl }}/assets/images/ansible-07.png){: .align-center}

**å¯ä»¥ç”¨å·¥å…·äº’ç›¸è½¬æ¢ï¼Œå‚è€ƒç½‘ç«™ï¼š**

- [https://www.json2yaml.com/](http://www.yunweipai.com/go?_=60bb30fe06aHR0cHM6Ly93d3cuanNvbjJ5YW1sLmNvbS8%3D)

- [http://www.bejson.com/json/json2yaml/](http://www.yunweipai.com/go?_=07b1ecff68aHR0cDovL3d3dy5iZWpzb24uY29tL2pzb24vanNvbjJ5YW1sLw%3D%3D)

### 4.3 Playbook æ ¸å¿ƒå…ƒç´ 

- **Hosts** æ‰§è¡Œçš„è¿œç¨‹ä¸»æœºåˆ—è¡¨ï¼›
- **Tasks** ä»»åŠ¡é›†ï¼›
- **Variables** å†…ç½®å˜é‡æˆ–è‡ªå®šä¹‰å˜é‡åœ¨ playbook ä¸­è°ƒç”¨ï¼›
- **Templates** æ¨¡æ¿ï¼Œå¯æ›¿æ¢æ¨¡æ¿æ–‡ä»¶ä¸­çš„å˜é‡å¹¶å®ç°ä¸€äº›ç®€å•é€»è¾‘çš„æ–‡ä»¶ï¼›
- **Handlers** å’Œ **notify** ç»“åˆä½¿ç”¨ï¼Œç”±ç‰¹å®šæ¡ä»¶è§¦å‘çš„æ“ä½œï¼Œæ»¡è¶³æ¡ä»¶æ–¹æ‰æ‰§è¡Œï¼Œå¦åˆ™ä¸æ‰§è¡Œï¼›
- **tags** æ ‡ç­¾ï¼ŒæŒ‡å®šæŸæ¡ä»»åŠ¡æ‰§è¡Œï¼Œç”¨äºé€‰æ‹©è¿è¡Œ playbook ä¸­çš„éƒ¨åˆ†ä»£ç ã€‚ansible å…·æœ‰å¹‚ç­‰æ€§ï¼Œå› æ­¤ä¼šè‡ªåŠ¨è·³è¿‡æ²¡æœ‰å˜åŒ–çš„éƒ¨åˆ†ï¼Œå³ä¾¿å¦‚æ­¤ï¼Œæœ‰äº›ä»£ç ä¸ºæµ‹è¯•å…¶ç¡®å®æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„æ—¶é—´ä¾ç„¶ä¼šéå¸¸åœ°é•¿ã€‚æ­¤æ—¶ï¼Œå¦‚æœç¡®ä¿¡å…¶æ²¡æœ‰å˜åŒ–ï¼Œå°±å¯ä»¥é€šè¿‡ tags è·³è¿‡æ­¤äº›ä»£ç ç‰‡æ–­ã€‚

#### 4.3.1 hosts ç»„ä»¶

Hostsï¼šplaybook ä¸­çš„æ¯ä¸€ä¸ª play çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†è®©ç‰¹å®šä¸»æœºä»¥æŸä¸ªæŒ‡å®šçš„ç”¨æˆ·èº«ä»½æ‰§è¡Œä»»åŠ¡ã€‚hosts ç”¨äºæŒ‡å®šè¦æ‰§è¡ŒæŒ‡å®šä»»åŠ¡çš„ä¸»æœºï¼Œé¡»äº‹å…ˆå®šä¹‰åœ¨ä¸»æœºæ¸…å•ä¸­ã€‚

```ini
one.example.com
one.example.com:two.example.com
192.168.1.50
192.168.1.*
# æˆ–ï¼Œä¸¤ä¸ªç»„çš„å¹¶é›†
Websrvs:dbsrvs
# ä¸ï¼Œä¸¤ä¸ªç»„çš„äº¤é›†
Websrvs:&dbsrvs
# åœ¨ websrvs ç»„ï¼Œä½†ä¸åœ¨ dbsrvs ç»„
webservers:!phoenix
```

ç¤ºä¾‹ï¼š

```yaml
- hosts: websrvs:appsrvs
```

#### 4.3.2 remote_user ç»„ä»¶

remote_user å¯ç”¨äº Host å’Œ task ä¸­ã€‚ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå…¶é€šè¿‡ sudo çš„æ–¹å¼åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œå…¶å¯ç”¨äº play å…¨å±€æˆ–æŸä»»åŠ¡ï¼›æ­¤å¤–ï¼Œç”šè‡³å¯ä»¥åœ¨ sudo æ—¶ä½¿ç”¨ sudo_user æŒ‡å®š sudo æ—¶åˆ‡æ¢çš„ç”¨æˆ·ã€‚

```yaml
- hosts: websrvs
  remote_user: root

  tasks:
    - name: test connection
      ping:
      remote_user: magedu
      sudo: yes                 # é»˜è®¤ sudo ä¸º root
      sudo_user:wang            # sudo ä¸º wang
```

#### 4.3.3 task åˆ—è¡¨å’Œ action ç»„ä»¶

play çš„ä¸»ä½“éƒ¨åˆ†æ˜¯ task listï¼Œtask list ä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª taskï¼Œå„ä¸ª task æŒ‰æ¬¡åºé€ä¸ªåœ¨ hosts ä¸­æŒ‡å®šçš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œï¼Œå³åœ¨æ‰€æœ‰ä¸»æœºä¸Šå®Œæˆç¬¬ä¸€ä¸ª task åï¼Œå†å¼€å§‹ç¬¬äºŒä¸ª taskï¼›
task çš„ç›®çš„æ˜¯ä½¿ç”¨æŒ‡å®šçš„å‚æ•°æ‰§è¡Œæ¨¡å—ï¼Œè€Œåœ¨æ¨¡å—å‚æ•°ä¸­å¯ä»¥ä½¿ç”¨å˜é‡ã€‚æ¨¡å—æ‰§è¡Œæ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ„å‘³ç€å¤šæ¬¡æ‰§è¡Œæ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå…¶ç»“æœå‡ä¸€è‡´ï¼›
æ¯ä¸ª task éƒ½åº”è¯¥æœ‰å…¶ nameï¼Œç”¨äº playbook çš„æ‰§è¡Œç»“æœè¾“å‡ºï¼Œå»ºè®®å…¶å†…å®¹èƒ½æ¸…æ™°åœ°æè¿°ä»»åŠ¡æ‰§è¡Œæ­¥éª¤ã€‚å¦‚æœæœªæä¾› nameï¼Œåˆ™ action çš„ç»“æœå°†ç”¨äºè¾“å‡ºã€‚

**task ä¸¤ç§æ ¼å¼ï¼š**

- `action: module arguments`
- `module: arguments` (å»ºè®®ä½¿ç”¨)

> **æ³¨æ„**ï¼šshell å’Œ command æ¨¡å—åé¢è·Ÿå‘½ä»¤ï¼Œè€Œé key=value

ç¤ºä¾‹ï¼š

```yaml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: install httpd
      yum: name=httpd 
    - name: start httpd
      service: name=httpd state=started enabled=yes
```

#### 4.3.4 å…¶å®ƒç»„ä»¶

æŸä»»åŠ¡çš„çŠ¶æ€åœ¨è¿è¡Œåä¸º changed æ—¶ï¼Œå¯é€šè¿‡ â€œnotifyâ€ é€šçŸ¥ç»™ç›¸åº”çš„ handlersï¼›
ä»»åŠ¡å¯ä»¥é€šè¿‡ "tagsâ€œ æ‰“æ ‡ç­¾ï¼Œå¯åœ¨ ansible-playbook å‘½ä»¤ä¸Šä½¿ç”¨ `-t` æŒ‡å®šè¿›è¡Œè°ƒç”¨ã€‚

#### 4.3.5 ShellScripts VS Playbook æ¡ˆä¾‹

SHELL è„šæœ¬å®ç°ï¼š

```shell
#!/bin/bash
# å®‰è£… Apache
yum install --quiet -y httpd 
# å¤åˆ¶é…ç½®æ–‡ä»¶
cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf
cp/tmp/vhosts.conf /etc/httpd/conf.d/
# å¯åŠ¨ Apacheï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨
systemctl enable --now httpd 
```

Playbook å®ç°ï¼š

```yaml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: "å®‰è£… Apache"
      yum: name=httpd
    - name: "å¤åˆ¶é…ç½®æ–‡ä»¶"
      copy: src=/tmp/httpd.conf dest=/etc/httpd/conf/
    - name: "å¤åˆ¶é…ç½®æ–‡ä»¶"
      copy: src=/tmp/vhosts.conf dest=/etc/httpd/conf.d/
    - name: "å¯åŠ¨ Apacheï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨"
      service: name=httpd state=started enabled=yes
```

### 4.4 Playbook å‘½ä»¤

æ ¼å¼ï¼š`ansible-playbook <filename.yml> ... [options]`

å¸¸è§é€‰é¡¹ï¼š

```shell
-C --check          # åªæ£€æµ‹å¯èƒ½ä¼šå‘ç”Ÿçš„æ”¹å˜ï¼Œä½†ä¸çœŸæ­£æ‰§è¡Œæ“ä½œ
--list-hosts        # åˆ—å‡ºè¿è¡Œä»»åŠ¡çš„ä¸»æœº
--list-tags         # åˆ—å‡º tag
--list-tasks        # åˆ—å‡º task
--limit HostList    # åªé’ˆå¯¹ä¸»æœºåˆ—è¡¨ HostList ä¸­çš„ä¸»æœºæ‰§è¡Œ
-v -vv  -vvv        # æ˜¾ç¤ºè¿‡ç¨‹
```

ç¤ºä¾‹ï¼š

```shell
$ ansible-playbook  file.yml  --check   # åªæ£€æµ‹
$ ansible-playbook  file.yml  
$ ansible-playbook  file.yml  --limit websrvs
```

### 4.5 Playbook åˆæ­¥

#### 4.5.1 åˆ©ç”¨ playbook åˆ›å»º mysql ç”¨æˆ·

ç¤ºä¾‹ï¼š`mysql_user.yml`

```yaml
---
- hosts: dbsrvs
  remote_user: root
  # ç¦æ­¢ Ansible æ”¶é›† facts ä¿¡æ¯
  gather_facts: no

  tasks:
    - {name: create group, group: name=mysql system=yes gid=306}
    - name: create user
      user: name=mysql shell=/sbin/nologin system=yes group=mysql uid=306 home=/data/mysql create_home=no
```

#### 4.5.2 åˆ©ç”¨ playbook å®‰è£… nginx

ç¤ºä¾‹ï¼š`install_nginx.yml`

```yaml
---
- hosts: websrvs
  remote_user: root
  gather_facts: no

  tasks:
    - name: add group nginx
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: web page
      copy: src=files/index.html dest=/usr/share/nginx/html/index.html
    - name: Start Nginx
      service: name=nginx state=started enabled=yes
```

#### 4.5.3 åˆ©ç”¨ playbook å®‰è£…å’Œå¸è½½ httpd

ç¤ºä¾‹ï¼š`install_httpd.yml`

```yaml
---
- hosts: websrvs
  remote_user: root
  gather_facts: no

  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
    - name: web html
      copy: src=files/index.html  dest=/var/www/html/
    - name: start service
      service: name=httpd state=started enabled=yes
```

å®‰è£…ï¼š

```shell
$ ansible-playbook install_httpd.yml --limit 10.0.0.8
```

ç¤ºä¾‹ï¼š`remove_httpd.yml`

```yaml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: remove httpd package
      yum: name=httpd state=absent
    - name: remove apache user 
      user: name=apache state=absent
    - name: remove config file
      file: name=/etc/httpd  state=absent
    - name: remove web html
      file: name=/var/www/html/index.html state=absent
```

#### 4.5.4 åˆ©ç”¨ playbook å®‰è£… mysql

å®‰è£… mysql-5.6.46-linux-glibc2.12

```shell
$ ls -l /data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz 
-rw-r--r-- 1 root root 403177622 Dec  4 13:05 /data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz

$ cat /data/ansible/files/my.cnf 
[mysqld]
socket=/tmp/mysql.sock
user=mysql
symbolic-links=0
datadir=/data/mysql
innodb_file_per_table=1
log-bin
pid-file=/data/mysql/mysqld.pid

[client]
port=3306
socket=/tmp/mysql.sock

[mysqld_safe]
log-error=/var/log/mysqld.log

$ cat /data/ansible/files/secure_mysql.sh 
#!/bin/bash
/usr/local/mysql/bin/mysql_secure_installation <<EOF

y
magedu
magedu
y
y
y
y
EOF

$ tree /data/ansible/files/
/data/ansible/files/
â”œâ”€â”€ my.cnf
â”œâ”€â”€ mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
â””â”€â”€ secure_mysql.sh

0 directories, 3 files
```

ç¤ºä¾‹ï¼š`install_mysql.yml`

```yaml
---
- hosts: dbsrvs
  remote_user: root
  gather_facts: no

  tasks:
    - name: install packages
      yum: name=libaio,perl-Data-Dumper,perl-Getopt-Long
    - name: create mysql group
      group: name=mysql gid=306 
    - name: create mysql user
      user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql
    - name: copy tar to remote host and file mode 
      unarchive: src=/data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/local/ owner=root group=root 
    - name: create linkfile  /usr/local/mysql 
      file: src=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
    - name: data dir
      shell: chdir=/usr/local/mysql/  ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql
      tags: data
    - name: config my.cnf
      copy: src=/data/ansible/files/my.cnf  dest=/etc/my.cnf 
    - name: service script
      shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
    - name: enable service
      shell: /etc/init.d/mysqld start;chkconfig --add mysqld;chkconfig mysqld on  
      tags: service
    - name: PATH variable
      copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
    - name: secure script
      script: /data/ansible/files/secure_mysql.sh
      tags: script
```

ç¤ºä¾‹ï¼š`install_mariadb.yml`

```yaml
---
- hosts: dbsrvs
  remote_user: root
  gather_facts: no

  tasks:
    - name: create group
      group: name=mysql gid=27 system=yes
    - name: create user
      user: name=mysql uid=27 system=yes group=mysql shell=/sbin/nologin home=/data/mysql create_home=no
    - name: mkdir datadir
      file: path=/data/mysql owner=mysql group=mysql state=directory
    - name: unarchive package
      unarchive: src=/data/ansible/files/mariadb-10.2.27-linux-x86_64.tar.gz dest=/usr/local/ owner=root group=root
    - name: link
      file: src=/usr/local/mariadb-10.2.27-linux-x86_64 path=/usr/local/mysql state=link 
    - name: install database
      shell: chdir=/usr/local/mysql   ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql
    - name: config file
      copy: src=/data/ansible/files/my.cnf  dest=/etc/ backup=yes
    - name: service script
      shell: /bin/cp  /usr/local/mysql/support-files/mysql.server  /etc/init.d/mysqld
    - name: start service
      service: name=mysqld state=started enabled=yes
    - name: PATH variable
      copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh
```

### 4.6 Playbook ä¸­ä½¿ç”¨ Handlers å’Œ notify

Handlers æœ¬è´¨æ˜¯ task listï¼Œç±»ä¼¼äº MySQL ä¸­çš„è§¦å‘å™¨è§¦å‘çš„è¡Œä¸ºï¼Œå…¶ä¸­çš„ task ä¸å‰è¿°çš„ task å¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼Œä¸»è¦ç”¨äºå½“å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡‡å–ä¸€å®šçš„æ“ä½œã€‚è€Œ Notify å¯¹åº”çš„ action å¯ç”¨äºåœ¨æ¯ä¸ª play çš„æœ€åè¢«è§¦å‘ï¼Œè¿™æ ·å¯é¿å…å¤šæ¬¡æœ‰æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼Œä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œæˆåä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œã€‚åœ¨ notify ä¸­åˆ—å‡ºçš„æ“ä½œæˆä¸º handlerï¼Œä¹Ÿå³ notify ä¸­è°ƒç”¨ handler ä¸­å®šä¹‰çš„æ“ä½œã€‚

æ¡ˆä¾‹1ï¼š

```yaml
- hosts: websrvs
  remote_user: root

  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      notify: restart httpd
    - name: ensure apache is running
      service: name=httpd state=started enabled=yes
  
  handlers:
    - name: restart httpd
      service: name=httpd state=restarted
```

æ¡ˆä¾‹2ï¼š

```yaml
- hosts: webnodes
  vars:
    http_port: 80
    max_clients: 256
  remote_user: root
  
  tasks:
    - name: ensure apache is at the latest version
      yum: name=httpd state=latest
    - name: ensure apache is running
      service: name=httpd state=started
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      notify: restart httpd
  
  handlers:
      - name: restart httpd 
        service: name=httpd state=restarted
```

æ¡ˆä¾‹3ï¼š

```yaml
- hosts: websrvs
  remote_user: root
  
  tasks:
    - name: add group nginx
      tags: user
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: config
      copy: src=/root/config.txt dest=/etc/nginx/nginx.conf
      notify:
        - Restart Nginx
        - Check Nginx Process
  
  handlers:
    - name: Restart Nginx
      service: name=nginx state=restarted enabled=yes
    - name: Check Nginx process
      shell: killall -0 nginx > /tmp/nginx.log
```

### 4.7 Playbook ä¸­ä½¿ç”¨ tags ç»„ä»¶

åœ¨ playbook æ–‡ä»¶ä¸­ï¼Œå¯ä»¥åˆ©ç”¨ tags ç»„ä»¶ä¸ºç‰¹å®šçš„ task æŒ‡å®šæ ‡ç­¾ï¼Œå½“åœ¨æ‰§è¡Œ playbook æ—¶ï¼Œå¯ä»¥é€‰æ‹©åªæ‰§è¡Œç‰¹å®š tags çš„ task ï¼Œè€Œéæ•´ä¸ª playbook æ–‡ä»¶ã€‚å¤šä¸ª task å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ª tags ã€‚

ç¤ºä¾‹ï¼š

```yaml
- hosts: websrvs
  remote_user: root
  gather_facts: no
  
  tasks:
    - name: Install httpd
      yum: name=httpd state=present
      tags: install 
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      tags: conf
    - name: start httpd service
      tags: service
      service: name=httpd state=started enabled=yes
```

æŒ‡å®šæ‰§è¡Œ `conf`ã€`service` ä¸¤ä¸ª tags çš„ task

```shell
$ ansible-playbook â€“t conf,service httpd.yml
```

### 4.8 Playbook ä¸­ä½¿ç”¨å˜é‡

å˜é‡åï¼šä»…èƒ½ç”±å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´ã€‚

**å˜é‡å®šä¹‰ï¼š**`variable=value`

ç¤ºä¾‹ï¼š`http_port=80`

**å˜é‡è°ƒç”¨æ–¹å¼ï¼š**é€šè¿‡ `{{ variable_name }}` è°ƒç”¨å˜é‡ï¼Œä¸”å˜é‡åå‰åå»ºè®®åŠ ç©ºæ ¼ï¼Œæœ‰æ—¶ç”¨ `"{{ variable_name }}"` æ‰ç”Ÿæ•ˆã€‚

#### 4.8.1 å˜é‡æ¥æº

1. ansible çš„ setup facts è¿œç¨‹ä¸»æœºçš„æ‰€æœ‰å˜é‡éƒ½å¯ç›´æ¥è°ƒç”¨

2. é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜

   ```shell
   $ ansible-playbook -e varname=value
   ```

3. åœ¨ playbook æ–‡ä»¶ä¸­å®šä¹‰

   ```yaml
     vars:
       - var1: value1
       - var2: value2
   ```

4. åœ¨ç‹¬ç«‹çš„å˜é‡ YAML æ–‡ä»¶ä¸­å®šä¹‰

   ```yaml
   - hosts: all
     vars_files:
       - vars.yml
   ```

5. åœ¨ `/etc/ansible/hosts` ä¸­å®šä¹‰

   **ä¸»æœºï¼ˆæ™®é€šï¼‰å˜é‡**ï¼šä¸»æœºç»„ä¸­ä¸»æœºå•ç‹¬å®šä¹‰ï¼Œä¼˜å…ˆçº§é«˜äºå…¬å…±å˜é‡
   **ç»„ï¼ˆå…¬å…±ï¼‰å˜é‡**ï¼šé’ˆå¯¹ä¸»æœºç»„ä¸­æ‰€æœ‰ä¸»æœºå®šä¹‰ç»Ÿä¸€å˜é‡

6. åœ¨ role ä¸­å®šä¹‰

#### 4.8.2 ä½¿ç”¨ setup æ¨¡å—ä¸­å˜é‡

æ‰§è¡Œ playbook æ—¶é»˜è®¤ä¼šè°ƒç”¨ setup æ¨¡å—ï¼ˆ`gather_facts` è®¾ç½®ä¸º `no` åˆ™ä¸ä¼šè°ƒç”¨ï¼‰ï¼Œæ‰€ä»¥åœ¨ playbook ä¸­å¯ä»¥ä½¿ç”¨ setup æ¨¡å—ä¸­çš„å˜é‡ï¼›ansible è°ƒç”¨å…¶ä»–æ¨¡å—æ‰§è¡Œå•æ¡å‘½ä»¤æ—¶æ²¡æœ‰è°ƒç”¨ setup æ¨¡å—ï¼Œæ‰€ä»¥ ansible å‘½ä»¤ä¸­å°†æ— æ³•ä½¿ç”¨ setup æ¨¡å—ä¸­çš„å˜é‡ã€‚

```yaml
# var.yml
---
- hosts: all
  remote_user: root
  gather_facts: yes

  tasks:
    - name: create log file
      file: name=/data/{{ ansible_nodename }}.log state=touch owner=wang mode=600
```

æ‰§è¡Œï¼š

```shell
$ ansible-playbook var.yml
```

#### 4.8.3 åœ¨ playbook å‘½ä»¤è¡Œä¸­å®šä¹‰å˜é‡

ç¤ºä¾‹ï¼š

```yaml
# var2.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: install package
      yum: name={{ pkname }} state=present
```

æ‰§è¡Œï¼š

```shell
$ ansible-playbook  â€“e pkname=httpd  var2.yml
```

#### 4.8.4 åœ¨ playbook æ–‡ä»¶ä¸­å®šä¹‰å˜é‡

ç¤ºä¾‹ï¼š

```yaml
# var3.yml
---
- hosts: websrvs
  remote_user: root
  vars:
    - username: user1
    - groupname: group1

  tasks:
    - name: create group
      group: name={{ groupname }} state=present
    - name: create user
      user: name={{ username }} group={{ groupname }} state=present
```

æ‰§è¡Œï¼š

```shell
$ ansible-playbook -e var3.yml
```

#### 4.8.5ä½¿ç”¨å˜é‡æ–‡ä»¶

å¯ä»¥åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ playbook æ–‡ä»¶ä¸­å®šä¹‰å˜é‡ï¼Œåœ¨å¦ä¸€ä¸ª playbook æ–‡ä»¶ä¸­å¼•ç”¨å˜é‡æ–‡ä»¶ä¸­çš„å˜é‡ï¼Œæ¯” playbook ä¸­å®šä¹‰çš„å˜é‡ä¼˜åŒ–çº§é«˜ã€‚

ç¤ºä¾‹1ï¼š

**Step 1ï¼‰**åˆ›å»ºç”¨äºå®šä¹‰å˜é‡çš„ yaml æ–‡ä»¶ï¼Œå¹¶åœ¨é‡Œé¢å®šä¹‰å¥½å˜é‡

*vars.yml*

```yaml
# variables file
package_name: mariadb-server
service_name: mariadb
```

**Step 2ï¼‰**åœ¨ playbook ä¸­å¼•ç”¨ `vars.yml` æ–‡ä»¶ä¸­çš„å˜é‡

```yaml
# var4.yml
---
#install package and start service
- hosts: dbsrvs
  remote_user: root
  vars_files:
    - /root/vars.yml

  tasks:
    - name: install package
      yum: name={{ package_name }}
      tags: install
    - name: start service
      service: name={{ service_name }} state=started enabled=yes
```

ç¤ºä¾‹2ï¼š

å˜é‡å®šä¹‰æ–‡ä»¶ `vars2.yml` ï¼š

```yaml
---
var1: httpd
var2: nginx
```

playbook æ–‡ä»¶ `var5.yml` ï¼š

```yaml
# var5.yml
---         
- hosts: web
  remote_user: root
  vars_files:
    - vars2.yml

   tasks:
     - name: create httpd log
       file: name=/app/{{ var1 }}.log state=touch
     - name: create nginx log
       file: name=/app/{{ var2 }}.log state=touch
```

#### 4.8.6 ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­å®šä¹‰å˜é‡

##### 4.8.6.1 ä¸»æœºå˜é‡

åœ¨ inventory ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­ä¸ºæŒ‡å®šçš„ä¸»æœºå®šä¹‰å˜é‡ä»¥ä¾¿åœ¨ playbook ä¸­ä½¿ç”¨

ç¤ºä¾‹ï¼š

```ini
[websrvs]
www1.magedu.com http_port=80 maxRequestsPerChild=808
www2.magedu.com http_port=8080 maxRequestsPerChild=909
```

ä¸Šè¿°ç¤ºä¾‹æ–‡ä»¶ä¸­ï¼Œä¸ºä¸»æœº *www1.magedu.com* å®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼š`http_port=80` å’Œ `maxRequestsPerChild=808`ï¼›ä¸ºä¸»æœº *www2.magedu.com* å®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼š`http_port=8080` å’Œ `maxRequestsPerChild=909`

##### 4.8.6.2 ç»„ï¼ˆå…¬å…±ï¼‰å˜é‡

åœ¨ inventory ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­èµ‹äºˆç»™æŒ‡å®šç»„å†…æ‰€æœ‰ä¸»æœºä¸Šçš„åœ¨playbookä¸­å¯ç”¨çš„å˜é‡ï¼Œå¦‚æœå’Œä¸»æœºå˜æ˜¯åŒåï¼Œä¼˜å…ˆçº§ä½äºä¸»æœºå˜é‡ã€‚

ç¤ºä¾‹ï¼š

```ini
[websrvs]
www1.magedu.com
www2.magedu.com

[websrvs:vars]
ntp_server=ntp.magedu.com
nfs_server=nfs.magedu.com
```

ä¸Šè¿°ç¤ºä¾‹æ–‡ä»¶ä¸­ï¼Œä¸º *websrvs* ç»„å®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼š`ntp_server=ntp.magedu.com` å’Œ `nfs_server=nfs.magedu.com`

##### ç»¼åˆç¤ºä¾‹

ç¤ºä¾‹1ï¼š

```ini
[websrvs]
10.0.0.8 hname=node1
10.0.0.7 hname=node2

[websvrs:vars]
domain=magedu.org
```

è°ƒç”¨ï¼š

```shell
$ ansible websvrs â€“m hostname â€“a 'name={{ hname }}.{{ domain }}'
```

åœ¨ä»¥ä¸Š ansible ä½¿ç”¨ hostname æ¨¡å—ä¿®æ”¹è¿œç¨‹ä¸»æœºåçš„ç¤ºä¾‹ä¸­ï¼šä¸»æœº *10.0.0.8* çš„åå­—å°†è¢«ä¿®æ”¹ä¸ºï¼š`node1.magedu.org`ï¼Œä¸»æœº *10.0.0.7* çš„åå­—å°†è¢«ä¿®æ”¹ä¸ºï¼š`node2.magedu.org`

ç¤ºä¾‹2ï¼š

*/etc/ansible/hosts*

```ini
[websrvs]
192.168.0.101 hname=www1 domain=magedu.io
192.168.0.102 hname=www2 

[websvrs:vars]
mark=â€œ-â€
domain=magedu.org
```

è°ƒç”¨ï¼š

```shell
$ ansible websvrs â€“m hostname â€“a 'name={{ hname }}{{ mark }}{{ domain }}'

# å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼š 
$ ansible websvrs â€“e domain=magedu.cn â€“m hostname â€“a 'name={{ hname }}{{ mark }}{{ domain }}'
```

### 4.9 template æ¨¡æ¿

æ¨¡æ¿æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥åšä¸ºç”Ÿæˆæ–‡ä»¶çš„æ¨¡ç‰ˆï¼Œå¹¶ä¸”æ¨¡æ¿æ–‡ä»¶ä¸­è¿˜å¯åµŒå¥— jinja è¯­æ³•

#### 4.9.1 jinja2 è¯­è¨€

[Jinja](https://jinja.palletsprojects.com/en/3.0.x/) æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯Œæœ‰è¡¨ç°åŠ›ã€å¯æ‰©å±•çš„æ¨¡æ¿å¼•æ“ã€‚æ¨¡æ¿ä¸­çš„ç‰¹æ®Šå ä½ç¬¦å…è®¸ç¼–å†™ç±»ä¼¼äº Python è¯­æ³•çš„ä»£ç ã€‚ç„¶åå‘æ¨¡æ¿ä¼ é€’æ•°æ®ä»¥å‘ˆç°æœ€ç»ˆæ–‡æ¡£ã€‚

jinja2 è¯­è¨€ä½¿ç”¨å­—é¢é‡ï¼Œæœ‰ä¸‹é¢å½¢å¼ï¼š

- å­—ç¬¦ä¸²ï¼šä½¿ç”¨å•å¼•å·æˆ–åŒå¼•å·
- æ•°å­—ï¼šæ•´æ•°ï¼Œæµ®ç‚¹æ•°
- åˆ—è¡¨ï¼š[item1, item2, â€¦]
- å…ƒç»„ï¼š(item1, item2, â€¦)
- å­—å…¸ï¼š{key1:value1, key2:value2, â€¦}
- å¸ƒå°”å‹ï¼štrue/false
- ç®—æœ¯è¿ç®—ï¼š+ï¼Œ-ï¼Œ*ï¼Œ/ï¼Œ//ï¼Œ%ï¼Œ**
- æ¯”è¾ƒæ“ä½œï¼š==ï¼Œ!=ï¼Œ>ï¼Œ>=ï¼Œ<ï¼Œ<=
- é€»è¾‘è¿ç®—ï¼šandï¼Œorï¼Œnot
- æµè¡¨è¾¾å¼ï¼šForï¼ŒIfï¼ŒWhen

**å­—é¢é‡**

è¡¨è¾¾å¼æœ€ç®€å•çš„å½¢å¼å°±æ˜¯å­—é¢é‡ã€‚å­—é¢é‡è¡¨ç¤ºè¯¸å¦‚å­—ç¬¦ä¸²å’Œæ•°å€¼çš„ Python å¯¹è±¡ã€‚å¦‚ "Hello World"
åŒå¼•å·æˆ–å•å¼•å·ä¸­é—´çš„ä¸€åˆ‡éƒ½æ˜¯å­—ç¬¦ä¸²ã€‚æ— è®ºä½•æ—¶ä½ éœ€è¦åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚å‡½æ•°è°ƒç”¨ã€è¿‡æ»¤å™¨æˆ–åªæ˜¯åŒ…å«æˆ–ç»§æ‰¿ä¸€ä¸ªæ¨¡æ¿çš„å‚æ•°ï¼‰ï¼Œå¦‚42ï¼Œ42.23
æ•°å€¼å¯ä»¥ä¸ºæ•´æ•°å’Œæµ®ç‚¹æ•°ã€‚å¦‚æœæœ‰å°æ•°ç‚¹ï¼Œåˆ™ä¸ºæµ®ç‚¹æ•°ï¼Œå¦åˆ™ä¸ºæ•´æ•°ã€‚åœ¨ Python é‡Œï¼Œ 42 å’Œ 42.0 æ˜¯ä¸ä¸€æ ·çš„

**ç®—æœ¯è¿ç®—**

Jinja å…è®¸ç”¨è®¡ç®—å€¼ã€‚æ”¯æŒä¸‹é¢çš„è¿ç®—ç¬¦
`+`ï¼šæŠŠä¸¤ä¸ªå¯¹è±¡åŠ åˆ°ä¸€èµ·ã€‚é€šå¸¸å¯¹è±¡æ˜¯ç´ è´¨ï¼Œä½†æ˜¯å¦‚æœä¸¤è€…æ˜¯å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼Œä½ å¯ä»¥ç”¨è¿™ ç§æ–¹å¼æ¥è¡”æ¥å®ƒä»¬ã€‚æ— è®ºå¦‚ä½•è¿™ä¸æ˜¯é¦–é€‰çš„è¿æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼è¿æ¥å­—ç¬¦ä¸²è§ ~ è¿ç®—ç¬¦ã€‚ {{ 1 + 1 }} ç­‰äº 2
`-`ï¼šç”¨ç¬¬ä¸€ä¸ªæ•°å‡å»ç¬¬äºŒä¸ªæ•°ã€‚ {{ 3 â€“ 2 }} ç­‰äº 1
`/`ï¼šå¯¹ä¸¤ä¸ªæ•°åšé™¤æ³•ã€‚è¿”å›å€¼ä¼šæ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ã€‚ {{ 1 / 2 }} ç­‰äº {{ 0.5 }}
`//`ï¼šå¯¹ä¸¤ä¸ªæ•°åšé™¤æ³•ï¼Œè¿”å›æ•´æ•°å•†ã€‚ {{ 20 // 7 }} ç­‰äº 2
`%`ï¼šè®¡ç®—æ•´æ•°é™¤æ³•çš„ä½™æ•°ã€‚ {{ 11 % 7 }} ç­‰äº 4
`*`ï¼šç”¨å³è¾¹çš„æ•°ä¹˜å·¦è¾¹çš„æ“ä½œæ•°ã€‚ {{ 2 * 2 }} ä¼šè¿”å› 4 ã€‚ä¹Ÿå¯ä»¥ç”¨äºé‡å¤ä¸€ä¸ªå­—ç¬¦ä¸²å¤šæ¬¡ã€‚ {{ '=' `*`80 }} ä¼šæ‰“å° 80 ä¸ªç­‰å·çš„æ¨ªæ¡
`**`ï¼šå–å·¦æ“ä½œæ•°çš„å³æ“ä½œæ•°æ¬¡å¹‚ã€‚ {{ 2**3 }} ä¼šè¿”å› 8

**æ¯”è¾ƒæ“ä½œç¬¦**

`==` æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰

`!=` æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ä¸ç­‰

`>` å¦‚æœå·¦è¾¹å¤§äºå³è¾¹ï¼Œè¿”å› true

`>=` å¦‚æœå·¦è¾¹å¤§äºç­‰äºå³è¾¹ï¼Œè¿”å› true

`<` å¦‚æœå·¦è¾¹å°äºå³è¾¹ï¼Œè¿”å› true

`<=` å¦‚æœå·¦è¾¹å°äºç­‰äºå³è¾¹ï¼Œè¿”å› true

**é€»è¾‘è¿ç®—ç¬¦**

å¯¹äº if è¯­å¥ï¼Œåœ¨ for è¿‡æ»¤æˆ– if è¡¨è¾¾å¼ä¸­ï¼Œå®ƒå¯ä»¥ç”¨äºè”åˆå¤šä¸ªè¡¨è¾¾å¼
and å¦‚æœå·¦æ“ä½œæ•°å’Œå³æ“ä½œæ•°åŒä¸ºçœŸï¼Œè¿”å› true
or å¦‚æœå·¦æ“ä½œæ•°å’Œå³æ“ä½œæ•°æœ‰ä¸€ä¸ªä¸ºçœŸï¼Œè¿”å› true
not å¯¹ä¸€ä¸ªè¡¨è¾¾å¼å–å
(expr)è¡¨è¾¾å¼ç»„
true / false true æ°¸è¿œæ˜¯ true ï¼Œè€Œ false å§‹ç»ˆæ˜¯ false

#### 4.9.2 template

template åŠŸèƒ½ï¼šå¯ä»¥æ ¹æ®å’Œå‚è€ƒæ¨¡å—æ–‡ä»¶ï¼ŒåŠ¨æ€ç”Ÿæˆç›¸ç±»ä¼¼çš„é…ç½®æ–‡ä»¶

template æ–‡ä»¶å¿…é¡»å­˜æ”¾äº templates ç›®å½•ä¸‹ï¼Œä¸”å‘½åä¸º .j2 ç»“å°¾

yaml/yml æ–‡ä»¶éœ€å’Œ templates ç›®å½•å¹³çº§ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ç¤ºä¾‹ï¼š

```shell
./
â”œâ”€â”€ temnginx.yml
â””â”€â”€ templates
â””â”€â”€ nginx.conf.j2
```

**ç¤ºä¾‹ï¼šåˆ©ç”¨ template åŒæ­¥ nginx é…ç½®æ–‡ä»¶**

**Step 1ï¼‰**å‡†å¤‡ `templates/nginx.conf.j2` æ–‡ä»¶

**Step 2ï¼‰**å‡†å¤‡ playbook çš„ yaml æ–‡ä»¶ï¼Œå¦‚ä¸‹

```yaml
# temnginx.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
```

**Step 3ï¼‰**æ‰§è¡Œ playbook

```shell
$ ansible-playbook temnginx.yml
```

**template å˜æ›´æ›¿æ¢**

**Step 1ï¼‰**å‡†å¤‡ template æ–‡ä»¶ï¼š`templates/nginx.conf.j2`

å¯ä»¥å°†æ–°å®‰è£…çš„ nginx é…ç½®æ–‡ä»¶æ‹·è´å¹¶é‡å‘½åä¸º `nginx.conf.j2`

```shell
# åˆ›å»ºç”¨äºå­˜æ”¾æ¨¡æ¿çš„ç›®å½• templates
$ mkdir templates

$ cp /etc/nginx/nginx.conf templates/nginx.conf.j2
```

**Step 2ï¼‰**ä¿®æ”¹ template æ–‡ä»¶ï¼š`nginx.conf.j2` 

æœ¬ä¾‹åªä¿®æ”¹äº† nginx çš„å·¥ä½œè¿›ç¨‹æ•°ï¼ˆ`worker_processes`ï¼‰ä¸ºè°ƒç”¨è¿œç¨‹ä¸»æœºçš„ vcpu æ•°ï¼ˆ`{{ ansible_processor_vcpus }}`ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®è¿œç¨‹ä¸»æœºçš„ vcpu çš„æ•°é‡åŠ¨æ€è®¾ç½®å®‰è£…åœ¨è¯¥ä¸»æœºä¸Šçš„ nginx çš„å·¥ä½œè¿›ç¨‹æ•°ã€‚

```shell
$ vim templates/nginx.conf.j2
user  nginx;
worker_processes  {{ ansible_processor_vcpus }};

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;
... ...
```

**Step 3ï¼‰**å‡†å¤‡ playbook çš„ yaml æ–‡ä»¶

```yaml
# temnginx2.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: install nginx
      yum: name=nginx
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf 
    - name: start service
      service: name=nginx state=started enable=yes
```

> `src=nginx.conf.j2` ä¸­ä¸ç”¨å†™ `templates/nginx.conf.j2` è·¯å¾„ï¼Œtemplate æ¨¡å—ä¼šè‡ªåŠ¨åœ¨ `temnginx2.yml` æ–‡ä»¶çš„åŒçº§ç›®å½•ä¸‹æŸ¥æ‰¾ templates ç›®å½•ä¸‹çš„ `nginx.conf.j2` æ–‡ä»¶ã€‚

**Step 4ï¼‰**æ‰§è¡Œ playbook

å®‰è£… nginx æœåŠ¡ã€æ ¹æ®æ¨¡æ¿æ–‡ä»¶ `nginx.conf.j2` ç”Ÿæˆ nginx é…ç½®æ–‡ä»¶ã€å¯åŠ¨ nginx æœåŠ¡

```shell
$ ansible-playbook temnginx2.yml
```

**template ç®—æœ¯è¿ç®—**

ç¤ºä¾‹1ï¼š

```shell
$ vim nginx.conf.j2 
worker_processes {{ ansible_processor_vcpus**2 }};    
worker_processes {{ ansible_processor_vcpus+2 }}; 
```

ç¤ºä¾‹2ï¼š

```shell
$ vim templates/nginx.conf.j2
worker_processes {{ ansible_processor_vcpus**3 }};

$ cat templnginx.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: install nginx
      yum: name=nginx
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
      notify: restart nginx
    - name: start service
      service: name=nginx state=started enabled=yes

  handlers:
    - name: restart nginx
      service: name=nginx state=restarted

$ ansible-playbook  templnginx.yml --limit 10.0.0.8
```

#### 4.9.3 template ä¸­ä½¿ç”¨æµç¨‹æ§åˆ¶ for å’Œ if

template ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨æµç¨‹æ§åˆ¶ for å¾ªç¯å’Œ if æ¡ä»¶åˆ¤æ–­ï¼Œå®ç°åŠ¨æ€ç”Ÿæˆæ–‡ä»¶åŠŸèƒ½

ç¤ºä¾‹1ï¼š

```shell
$ cat temlnginx2.yml
# temlnginx2.yml
---
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - 81
      - 82
      - 83
  tasks:
    - name: template config
      template: src=nginx.conf.j2 dest=/data/nginx.conf


$ cat templates/nginx.conf2.j2
# templates/nginx.conf2.j2
{% for vhost in  nginx_vhosts %}
server {
   listen {{ vhost }}
}
{% endfor %}


$ ansible-playbook templnginx2.yml  --limit 10.0.0.8

# ç”Ÿæˆçš„ç»“æœï¼š
server {
   listen 81   
}
server {
   listen 82   
}
server {
   listen 83   
}
```

ç¤ºä¾‹2ï¼š

```shell
$ cat temlnginx3.yml
# temlnginx3.yml
---
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - listen: 8080
  tasks:
    - name: config file
      template: src=nginx.conf3.j2 dest=/data/nginx3.conf


$ cat templates/nginx.conf3.j2
# templates/nginx.conf3.j2
{% for vhost in nginx_vhosts %}   
server {
  listen {{ vhost.listen }}
}
{% endfor %}


$ ansible-playbook templnginx3.yml  --limit 10.0.0.8

# ç”Ÿæˆçš„ç»“æœ
server {
  listen 8080  
}
```

ç¤ºä¾‹3ï¼š

```shell
$ cat templnginx4.yml
# templnginx4.yml
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - listen: 8080
        server_name: "web1.magedu.com"
        root: "/var/www/nginx/web1/"
      - listen: 8081
        server_name: "web2.magedu.com"
        root: "/var/www/nginx/web2/"
      - {listen: 8082, server_name: "web3.magedu.com", root: "/var/www/nginx/web3/"}
  tasks:
    - name: template config 
      template: src=nginx.conf4.j2 dest=/data/nginx4.conf


$ cat templates/nginx.conf4.j2
# templates/nginx.conf4.j2
{% for vhost in nginx_vhosts %}
server {
   listen {{ vhost.listen }}
   server_name {{ vhost.server_name }}
   root {{ vhost.root }}  
}
{% endfor %}


$ ansible-playbook templnginx4.yml --limit 10.0.0.8

# ç”Ÿæˆç»“æœï¼š
server {
    listen 8080
    server_name web1.magedu.com
    root /var/www/nginx/web1/  
}
server {
    listen 8081
    server_name web2.magedu.com
    root /var/www/nginx/web2/  
}
server {
    listen 8082
    server_name web3.magedu.com
    root /var/www/nginx/web3/  
} 
```

åœ¨æ¨¡ç‰ˆæ–‡ä»¶ä¸­è¿˜å¯ä»¥ä½¿ç”¨ if æ¡ä»¶åˆ¤æ–­ï¼Œå†³å®šæ˜¯å¦ç”Ÿæˆç›¸å…³çš„é…ç½®ä¿¡æ¯

ç¤ºä¾‹ï¼š

```shell
$ cat templnginx5.yml
# templnginx5.yml
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - web1:
        listen: 8080
        root: "/var/www/nginx/web1/"
      - web2:
        listen: 8080
        server_name: "web2.magedu.com"
        root: "/var/www/nginx/web2/"
      - web3:
        listen: 8080
        server_name: "web3.magedu.com"
        root: "/var/www/nginx/web3/"
  tasks:
    - name: template config to 
      template: src=nginx.conf5.j2 dest=/data/nginx5.conf


$ cat templates/nginx.conf5.j2
# templates/nginx.conf5.j2
{% for vhost in  nginx_vhosts %}
server {
   listen {{ vhost.listen }}
   {% if vhost.server_name is defined %}
server_name {{ vhost.server_name }}
   {% endif %}
root  {{ vhost.root }}
}
{% endfor %}


$ ansible-playbook templnginx5.yml --limit 10.0.0.8

# ç”Ÿæˆçš„ç»“æœ
server {
   listen 8080
   root  /var/www/nginx/web1/
}
server {
   listen 8080
   server_name web2.magedu.com
   root  /var/www/nginx/web2/
}
server {
   listen 8080
   server_name web3.magedu.com
   root  /var/www/nginx/web3/
}
```

### 4.10 Playbook ä½¿ç”¨ when

when è¯­å¥ï¼Œå¯ä»¥å®ç°æ¡ä»¶æµ‹è¯•ã€‚å¦‚æœéœ€è¦æ ¹æ®å˜é‡ã€facts æˆ–æ­¤å‰ä»»åŠ¡çš„æ‰§è¡Œç»“æœæ¥åšä¸ºæŸ task æ‰§è¡Œä¸å¦çš„å‰ææ—¶è¦ç”¨åˆ°æ¡ä»¶æµ‹è¯•ï¼Œé€šè¿‡åœ¨ task åæ·»åŠ  when å­å¥å³å¯ä½¿ç”¨æ¡ä»¶æµ‹è¯•ï¼Œjinja2 çš„è¯­æ³•æ ¼å¼

ç¤ºä¾‹1ï¼š

```yaml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: "shutdown RedHat flavored systems"
      command: /sbin/shutdown -h now
      when: ansible_os_family == "RedHat"
```

ç¤ºä¾‹2ï¼š

```yaml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: add group nginx
      tags: user
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: restart Nginx
      service: name=nginx state=restarted
      when: ansible_distribution_major_version == â€œ6â€
```

ç¤ºä¾‹3ï¼š

```yaml
---
- hosts: websrvs
  remote_user: root
  tasks: 
    - name: install conf file to centos7
      template: src=nginx.conf.c7.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version == "7"
    - name: install conf file to centos6
      template: src=nginx.conf.c6.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version == "6"
```

### 4.11 Playbook ä½¿ç”¨è¿­ä»£ with_items

è¿­ä»£ï¼šå½“æœ‰éœ€è¦é‡å¤æ€§æ‰§è¡Œçš„ä»»åŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿­ä»£æœºåˆ¶
å¯¹è¿­ä»£é¡¹çš„å¼•ç”¨ï¼Œå›ºå®šå˜é‡åä¸º "`item`"
è¦åœ¨ task ä¸­ä½¿ç”¨ `with_items` ç»™å®šè¦è¿­ä»£çš„å…ƒç´ åˆ—è¡¨

**åˆ—è¡¨å…ƒç´ æ ¼å¼ï¼š**

- å­—ç¬¦ä¸²
- å­—å…¸

ç¤ºä¾‹1ï¼šå¾ªç¯åˆ›å»ºç”¨æˆ·

```yaml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: add several users
      user: name={{ item }} state=present groups=wheel
      with_items:
        - testuser1
        - testuser2

# ä¸Šé¢è¯­å¥çš„åŠŸèƒ½ç­‰åŒäºä¸‹é¢çš„è¯­å¥
    - name: add user testuser1
      user: name=testuser1 state=present groups=wheel
    - name: add user testuser2
      user: name=testuser2 state=present groups=wheel
```

ç¤ºä¾‹2ï¼šå¾ªç¯åˆ é™¤æ–‡ä»¶

```yaml
---
# remove mariadb server
- hosts: appsrvs:!192.168.38.8
  remote_user: root

  tasks:
    - name: stop service
      shell: /etc/init.d/mysqld stop
    - name:  delete files and dir
      file: path={{item}} state=absent
      with_items:
        - /usr/local/mysql
        - /usr/local/mariadb-10.2.27-linux-x86_64
        - /etc/init.d/mysqld
        - /etc/profile.d/mysql.sh
        - /etc/my.cnf
        - /data/mysql
    - name: delete user
      user: name=mysql state=absent remove=yes 
```

ç¤ºä¾‹3ï¼šå¾ªç¯å®‰è£…è½¯ä»¶

```yaml
---
- hostsï¼šwebsrvs
  remote_user: root

  tasks
    - name: install some packages
      yum: name={{ item }} state=present
      with_items:
        - nginx
        - memcached
        - php-fpm 
```

ç¤ºä¾‹4ï¼šå¾ªç¯æ‹·è´æ–‡ä»¶åŠå®‰è£…è½¯ä»¶

```yaml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: copy file
      copy: src={{ item }} dest=/tmp/{{ item }}
      with_items:
        - file1
        - file2
        - file3
    - name: yum install httpd
      yum: name={{ item }}  state=present 
      with_items:
        - apr
        - apr-util
        - httpd
```

**è¿­ä»£åµŒå¥—å­å˜é‡ï¼š**åœ¨è¿­ä»£ä¸­ï¼Œè¿˜å¯ä»¥åµŒå¥—å­å˜é‡ï¼Œå…³è”å¤šä¸ªå˜é‡åœ¨ä¸€èµ·ä½¿ç”¨

ç¤ºä¾‹1ï¼š

```yaml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: add some groups
      group: name={{ item }} state=present
      with_items:
        - nginx
        - mysql
        - apache
    - name: add some users
      user: name={{ item.name }} group={{ item.group }} state=present
      with_items:
        - { name: 'nginx', group: 'nginx' }
        - { name: 'mysql', group: 'mysql' }
        - { name: 'apache', group: 'apache' }
```

ç¤ºä¾‹2ï¼š

```yaml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: add some groups
      group: name={{ item }} state=present
      with_items:
        - g1
        - g2
        - g3
    - name: add some users
      user: name={{ item.name }} group={{ item.group }} home={{ item.home }} create_home=yes state=present
      with_items:
        - { name: 'user1', group: 'g1', home: '/data/user1' }
        - { name: 'user2', group: 'g2', home: '/data/user2' }
        - { name: 'user3', group: 'g3', home: '/data/user3' }
```

## 5. Roles è§’è‰²

è§’è‰²æ˜¯ ansible è‡ª1.2ç‰ˆæœ¬å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œç”¨äºå±‚æ¬¡æ€§ã€ç»“æ„åŒ–åœ°ç»„ç»‡ playbookã€‚roles èƒ½å¤Ÿæ ¹æ®å±‚æ¬¡å‹ç»“æ„è‡ªåŠ¨è£…è½½å˜é‡æ–‡ä»¶ã€tasks ä»¥åŠ handlers ç­‰ã€‚è¦ä½¿ç”¨ roles åªéœ€è¦åœ¨ playbook ä¸­ä½¿ç”¨ include æŒ‡ä»¤å³å¯ã€‚ç®€å•æ¥è®²ï¼Œroles å°±æ˜¯é€šè¿‡åˆ†åˆ«å°†å˜é‡ã€æ–‡ä»¶ã€ä»»åŠ¡ã€æ¨¡æ¿åŠå¤„ç†å™¨æ”¾ç½®äºå•ç‹¬çš„ç›®å½•ä¸­ï¼Œå¹¶å¯ä»¥ä¾¿æ·åœ° include å®ƒä»¬çš„ä¸€ç§æœºåˆ¶ã€‚è§’è‰²ä¸€èˆ¬ç”¨äºåŸºäºä¸»æœºæ„å»ºæœåŠ¡çš„åœºæ™¯ä¸­ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯ç”¨äºæ„å»ºå®ˆæŠ¤è¿›ç¨‹ç­‰åœºæ™¯ä¸­ã€‚

è¿ç»´å¤æ‚çš„åœºæ™¯ï¼šå»ºè®®ä½¿ç”¨ rolesï¼Œä»£ç å¤ç”¨åº¦é«˜

**roles**ï¼šå¤šä¸ªè§’è‰²çš„é›†åˆï¼Œ å¯ä»¥å°†å¤šä¸ªçš„ roleï¼Œåˆ†åˆ«æ”¾è‡³ roles ç›®å½•ä¸‹çš„ç‹¬ç«‹å­ç›®å½•ä¸­

```shell
$ tree roles/
roles/
â”œâ”€â”€ httpd
â”œâ”€â”€ mysql
â”œâ”€â”€ nginx
â””â”€â”€ redis
```

### 5.1 Ansible Roles ç›®å½•ç¼–æ’

roles ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

![]({{ site.url }}{{ site.baseurl }}/assets/images/ansible-08.png){: .align-left}

æ¯ä¸ªè§’è‰²ï¼Œä»¥ç‰¹å®šçš„å±‚çº§ç›®å½•ç»“æ„è¿›è¡Œç»„ç»‡ã€‚

**roles ç›®å½•ç»“æ„ï¼š**
playbook.yml
roles/
project/
tasks/
files/
vars/
templates/
handlers/
default/
meta/

**Roles å„ç›®å½•ä½œç”¨ï¼š**
`roles/project/ `ï¼šé¡¹ç›®åç§°ï¼Œæœ‰ä»¥ä¸‹å­ç›®å½•

- `files/` ï¼šå­˜æ”¾ç”± copy æˆ– script æ¨¡å—ç­‰è°ƒç”¨çš„æ–‡ä»¶
- `templates/`ï¼štemplate æ¨¡å—æŸ¥æ‰¾æ‰€éœ€è¦æ¨¡æ¿æ–‡ä»¶çš„ç›®å½•
- `tasks/`ï¼šå®šä¹‰ taskï¼Œrole çš„åŸºæœ¬å…ƒç´ ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸º main.yml çš„æ–‡ä»¶ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡ include è¿›è¡ŒåŒ…å«
- `handlers/`ï¼šè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸º main.yml çš„æ–‡ä»¶ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡ include è¿›è¡ŒåŒ…å«
- `vars/`ï¼šå®šä¹‰å˜é‡ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸º main.yml çš„æ–‡ä»¶ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡ include è¿›è¡ŒåŒ…å«
- `meta/`ï¼šå®šä¹‰å½“å‰è§’è‰²çš„ç‰¹æ®Šè®¾å®šåŠå…¶ä¾èµ–å…³ç³»ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸º main.yml çš„æ–‡ä»¶ï¼Œå…¶å®ƒæ–‡ä»¶éœ€åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡ include è¿›è¡ŒåŒ…å«
- `default/`ï¼šè®¾å®šé»˜è®¤å˜é‡æ—¶ä½¿ç”¨æ­¤ç›®å½•ä¸­çš„ main.yml æ–‡ä»¶ï¼Œæ¯” vars çš„ä¼˜å…ˆçº§ä½

### 5.2 åˆ›å»º role

**åˆ›å»º role çš„æ­¥éª¤**

1. åˆ›å»ºä»¥ roles å‘½åçš„ç›®å½•ï¼›
2. åœ¨ roles ç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºä»¥å„è§’è‰²åç§°å‘½åçš„ç›®å½•ï¼Œå¦‚ webservers ç­‰ï¼›
3. åœ¨æ¯ä¸ªè§’è‰²å‘½åçš„ç›®å½•ä¸­åˆ†åˆ«åˆ›å»º filesã€handlersã€metaã€tasksã€templates å’Œ vars ç›®å½•ï¼›ç”¨ä¸åˆ°çš„ç›®å½•å¯ä»¥åˆ›å»ºä¸ºç©ºç›®å½•ï¼Œä¹Ÿå¯ä»¥ä¸åˆ›å»ºï¼›
4. åœ¨ playbook æ–‡ä»¶ä¸­ï¼Œè°ƒç”¨å„è§’è‰²ã€‚

**é’ˆå¯¹å¤§å‹é¡¹ç›®ä½¿ç”¨ Roles è¿›è¡Œç¼–æ’**

ç¤ºä¾‹ï¼šroles çš„ç›®å½•ç»“æ„

```shell
nginx-role.yml 
roles/
â””â”€â”€ nginx 
     â”œâ”€â”€ files
     â”‚    â””â”€â”€ main.yml 
     â”œâ”€â”€ tasks
     â”‚    â”œâ”€â”€ groupadd.yml 
     â”‚    â”œâ”€â”€ install.yml 
     â”‚    â”œâ”€â”€ main.yml 
     â”‚    â”œâ”€â”€ restart.yml 
     â”‚    â””â”€â”€ useradd.yml 
     â””â”€â”€ vars 
          â””â”€â”€ main.yml 
```

### 5.3 Playbook è°ƒç”¨è§’è‰²

**è°ƒç”¨è§’è‰²æ–¹æ³•1ï¼š**

```yaml
---
- hosts: websrvs
  remote_user: root
  roles:
    - mysql
    - memcached
    - nginx   
```

**è°ƒç”¨è§’è‰²æ–¹æ³•2ï¼š**

é”® role ç”¨äºæŒ‡å®šè§’è‰²åç§°ï¼Œåç»­çš„ k/v ç”¨äºä¼ é€’å˜é‡ç»™è§’è‰²

```yaml
---
- hosts: all
  remote_user: root
  roles:
    - mysql
    - { role: nginx, username: nginx }
```

**è°ƒç”¨è§’è‰²æ–¹æ³•3ï¼š**

è¿˜å¯åŸºäºæ¡ä»¶æµ‹è¯•å®ç°è§’è‰²è°ƒç”¨

```yaml
---
- hosts: all
  remote_user: root
  roles:
    - { role: nginx, username: nginx, when: ansible_distribution_major_version == â€˜7â€™  }
```

### 5.4 roles ä¸­ tags ä½¿ç”¨

ç¤ºä¾‹ï¼š

```shell
$ cat nginx-role.yml
# nginx-role.yml
---
- hosts: websrvs
  remote_user: root
  roles:
    - { role: nginx ,tags: [ 'nginx', 'web' ] ,when: ansible_distribution_major_version == "6â€œ }
    - { role: httpd ,tags: [ 'httpd', 'web' ]  }
    - { role: mysql ,tags: [ 'mysql', 'db' ] }
    - { role: mariadb ,tags: [ 'mariadb', 'db' ] }
    

$ ansible-playbook --tags="nginx,httpd,mysql" nginx-role.yml
```

### 5.5 å®æˆ˜æ¡ˆä¾‹

#### 5.5.1 æ¡ˆä¾‹1: å®ç° httpd è§’è‰²

```shell
# åˆ›å»ºè§’è‰²ç›¸å…³çš„ç›®å½•
$ mkdir -pv /data/ansible/roles/httpd/{tasks,handlers,files}

# åˆ›å»ºè§’è‰²ç›¸å…³çš„æ–‡ä»¶
$ cd /data/ansible/roles/httpd/

$ vim tasks/main.yml
- include: group.yml
- include: user.yml
- include: install.yml
- include: config.yml
- include: index.yml
- include: service.yml

$ vim  tasks/user.yml
- name: create apache user
  user: name=apache system=yes shell=/sbin/nologin home=/var/www/ uid=80 group=apache

$ vim  tasks/group.yml
- name: create apache group
  group: name=apache system=yes gid=80

$ vim tasks/install.yml
- name: install httpd package
  yum: name=httpd

$ vim tasks/config.yml
- name: config file
  copy: src=httpd.conf dest=/etc/httpd/conf/ backup=yes
  notify: restart

$ vim tasks/index.yml
- name: index.html
  copy: src=index.html dest=/var/www/html/

$ vim tasks/service.yml
- name: start service
  service: name=httpd state=started enabled=yes

$ vim handlers/main.yml
- name: restart
  service: name=httpd state=restarted

# åœ¨ files ç›®å½•ä¸‹å‡†å¤‡ä¸¤ä¸ªæ–‡ä»¶
$ ls files/
httpd.conf index.html

$ tree /data/ansible/roles/httpd/
/data/ansible/roles/httpd/
â”œâ”€â”€ files
â”‚   â”œâ”€â”€ httpd.conf
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ handlers
â”‚   â””â”€â”€ main.yml
â””â”€â”€ tasks
    â”œâ”€â”€ config.yml
    â”œâ”€â”€ group.yml
    â”œâ”€â”€ index.yml
    â”œâ”€â”€ install.yml
    â”œâ”€â”€ main.yml
    â”œâ”€â”€ service.yml
    â””â”€â”€ user.yml

3 directories, 10 files

# åœ¨ playbook ä¸­è°ƒç”¨è§’è‰²
$ vim  /data/ansible/role_httpd.yml
---
# httpd role
- hosts: websrvs
  remote_user: root

  roles:
    - httpd

# è¿è¡Œplaybook
$ ansible-playbook  /data/ansible/role_httpd.yml
```

#### 5.5.2 æ¡ˆä¾‹2: å®ç° nginx è§’è‰²

```shell
$ mkdir -pv  /data/ansible/roles/nginx/{tasks,handlers,templates,vars}

# åˆ›å»º taskæ–‡ä»¶
$ cd /data/ansible/roles/nginx/

$ vim tasks/main.yml 
- include: install.yml
- include: config.yml
- include: index.yml
- include: service.yml

$ vim  tasks/install.yml 
- name: install
  yum: name=nginx 

$ vim tasks/config.yml 
- name: config file for centos7
  template: src=nginx7.conf.j2 dest=/etc/nginx/nginx.conf
  when: ansible_distribution_major_version=="7"
  notify: restart
- name: config file for centos8
  template: src=nginx8.conf.j2 dest=/etc/nginx/nginx.conf
  when: ansible_distribution_major_version=="8"
  notify: restart

$ vim  tasks/index.yml 
- name: index.html
  copy: src=roles/httpd/files/index.html dest=/usr/share/nginx/html/

$ vim tasks/service.yml 
- name: start service
  service: name=nginx state=started enabled=yes

# åˆ›å»º handler æ–‡ä»¶
$ cat handlers/main.yml 
- name: restart
  service: name=nginx state=restarted

# åˆ›å»ºä¸¤ä¸ª template æ–‡ä»¶
$ cat templates/nginx7.conf.j2
...çœç•¥...
user {{user}};
worker_processes {{ansible_processor_vcpus+3}};   # ä¿®æ”¹æ­¤è¡Œ
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
...çœç•¥...

$ cat templates/nginx8.conf.j2
...çœç•¥...
user nginx;
worker_processes {{ansible_processor_vcpus**3}};  # ä¿®æ”¹æ­¤è¡Œ
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
...çœç•¥...

# åˆ›å»ºå˜é‡æ–‡ä»¶
$ vim vars/main.yml 
user: daemon

# ç›®å½•ç»“æ„å¦‚ä¸‹
$ tree /data/ansible/roles/nginx/
/data/ansible/roles/nginx/
â”œâ”€â”€ handlers
â”‚   â””â”€â”€ main.yml
â”œâ”€â”€ tasks
â”‚   â”œâ”€â”€ config.yml
â”‚   â”œâ”€â”€ file.yml
â”‚   â”œâ”€â”€ install.yml
â”‚   â”œâ”€â”€ main.yml
â”‚   â””â”€â”€ service.yml
â”œâ”€â”€ templates
â”‚   â”œâ”€â”€ nginx7.conf.j2
â”‚   â””â”€â”€ nginx8.conf.j2
â””â”€â”€ vars
    â””â”€â”€ main.yml

4 directories, 9 files

# åœ¨ playbook ä¸­è°ƒç”¨è§’è‰²
$ vim /data/ansible/role_nginx.yml 
---
# nginx role 
- hosts: websrvs

  roles:
    - role: nginx

# è¿è¡Œ playbook
$ ansible-playbook  /data/ansible/role_nginx.yml
```

#### 5.5.3 æ¡ˆä¾‹3: å®ç° memcached è§’è‰²

```shell
$ mkdir -pv  /data/ansible/roles/memcached/{tasks,templates}

$ cd /data/ansible/roles/memcached
$ vim tasks/main.yml 
- include: install.yml
- include: config.yml
- include: service.yml

$ vim tasks/install.yml 
- name: install
  yum: name=memcached

$ vim tasks/config.yml 
- name: config file
  template: src=memcached.j2  dest=/etc/sysconfig/memcached

$ vim tasks/service.yml 
- name: service
  service: name=memcached state=started enabled=yes

$ vim templates/memcached.j2 
PORT="11211"
USER="memcached"
MAXCONN="1024"
CACHESIZE="{{ansible_memtotal_mb//4}}"
OPTIONS=""

$ tree /data/ansible/roles/memcached/
/data/ansible/roles/memcached/
â”œâ”€â”€ tasks
â”‚   â”œâ”€â”€ config.yml
â”‚   â”œâ”€â”€ install.yml
â”‚   â”œâ”€â”€ main.yml
â”‚   â””â”€â”€ service.yml
â””â”€â”€ templates
    â””â”€â”€ memcached.j2

2 directories, 5 files

$ vim /data/ansible/role_memcached.yml 
---
- hosts: appsrvs

  roles:
    - role: memcached

$ ansible-play /data/ansible/role_memcached.yml
```

#### 5.5.4 æ¡ˆä¾‹4: å®ç° mysql è§’è‰²

```shell
$ cat /data/ansible/roles/mysql/files/my.cnf 
[mysqld]
socket=/tmp/mysql.sock
user=mysql
symbolic-links=0
datadir=/data/mysql
innodb_file_per_table=1
log-bin
pid-file=/data/mysql/mysqld.pid

[client]
port=3306
socket=/tmp/mysql.sock

[mysqld_safe]
log-error=/var/log/mysqld.log

$ cat /data/ansible/roles/mysql/files/secure_mysql.sh 
#!/bin/bash
/usr/local/mysql/bin/mysql_secure_installation <<EOF

y
magedu
magedu
y
y
y
y
EOF

$ chmod +x  /data/ansible/roles/mysql/files/secure_mysql.sh

$ ls /data/ansible/roles/mysql/files/
my.cnf  mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz  secure_mysql.sh

$ cat /data/ansible/roles/mysql/tasks/main.yml
- include: install.yml
- include: group.yml
- include: user.yml
- include: unarchive.yml
- include: link.yml
- include: data.yml
- include: config.yml
- include: service.yml
- include: path.yml
- include: secure.yml

$ cat /data/ansible/roles/mysql/tasks/install.yml 
- name: install packages                                            
  yum: name=libaio,perl-Data-Dumper,perl-Getopt-Long
$ cat /data/ansible/roles/mysql/tasks/group.yml 
- name: create mysql group
  group: name=mysql gid=306
$ cat /data/ansible/roles/mysql/tasks/user.yml 
- name: create mysql user
  user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes create_home=no home=/data/mysql
$ cat /data/ansible/roles/mysql/tasks/unarchive.yml 
- name: copy tar to remote host and file mode 
  unarchive: src=mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/local/ owner=root group=root
$ cat /data/ansible/roles/mysql/tasks/link.yml 
- name: mkdir /usr/local/mysql 
  file: src=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
$ cat /data/ansible/roles/mysql/tasks/data.yml 
- name: data dir
  shell: chdir=/usr/local/mysql/  ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql
$ cat /data/ansible/roles/mysql/tasks/config.yml 
- name: config my.cnf
  copy: src=my.cnf  dest=/etc/my.cnf 
$ cat /data/ansible/roles/mysql/tasks/service.yml 
- name: service script
  shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld;chkconfig --add mysqld;chkconfig mysqld on;/etc/init.d/mysqld start

$ cat /data/ansible/roles/mysql/tasks/path.yml 
- name: PATH variable
  copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh  

$ cat /data/ansible/roles/mysql/tasks/secure.yml 
- name: secure script
  script: secure_mysql.sh

$ tree /data/ansible/roles/mysql/
/data/ansible/roles/mysql/
â”œâ”€â”€ files
â”‚   â”œâ”€â”€ my.cnf
â”‚   â”œâ”€â”€ mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
â”‚   â””â”€â”€ secure_mysql.sh
â””â”€â”€ tasks
    â”œâ”€â”€ config.yml
    â”œâ”€â”€ data.yml
    â”œâ”€â”€ group.yml
    â”œâ”€â”€ install.yml
    â”œâ”€â”€ link.yml
    â”œâ”€â”€ main.yml
    â”œâ”€â”€ path.yml
    â”œâ”€â”€ secure.yml
    â”œâ”€â”€ service.yml
    â”œâ”€â”€ unarchive.yml
    â””â”€â”€ user.yml

2 directories, 14 files

$ cat /data/ansible/mysql_roles.yml
- hosts: dbsrvs
  remote_user: root

  roles:
    - {role: mysql,tags: ["mysql","db"]}
    - {role: nginx,tage: ["nginx","web"]}

$ ansible-playbook -t mysql /data/ansible/mysql_roles.yml
```

#### 5.5.5 æ¡ˆä¾‹5: å®ç°å¤šè§’è‰²çš„é€‰æ‹©

```shell
$ vim /data/ansible/role_httpd_nginx.yml 
---
- hosts: websrvs

  roles:
    - {role: httpd,tags: [httpd,web], when: ansible_distribution_major_version=="7" }
    - {role: nginx,tags: [nginx,web], when: ansible_distribution_major_version=="8" }

$ ansible-playbook -t nginx /data/ansible/role_httpd_nginx.yml 
```

## 6. Ansible æ¨èå­¦ä¹ èµ„æ–™

- [ansible/ansible (github.com)](https://github.com/ansible/ansible)
- [ansible/ansible-examples (github.com)](https://github.com/ansible/ansible-examples)
- [Ansible Documentation](https://docs.ansible.com/)
- [User Guide â€” Ansible Documentation](https://docs.ansible.com/ansible/2.9/user_guide/index.html#)
- [Ansible ä¸­æ–‡æƒå¨æŒ‡å— (ansible.com.cn)](http://www.ansible.com.cn/index.html)
- [Ansible Galaxy](https://galaxy.ansible.com/)
- [ansible/galaxy (github.com)](https://github.com/ansible/galaxy)
- [Ansible Automation for SysAdmins \| Opensource.com](https://opensource.com/downloads/ansible-quickstart?extIdCarryOver=true&sc_cid=701f2000001OH7YAAW)
- [A system administrator's guide to getting started with Ansible - FAST! (redhat.com)](https://www.redhat.com/en/blog/system-administrators-guide-getting-started-ansible-fast?extIdCarryOver=true&sc_cid=701f2000001OH7YAAW)

## 7. Troubleshooting

### 7.1 Ansible èŠ‚ç‚¹è¿‡å¤šè¶…æ—¶è§£å†³æ–¹æ³•

é»˜è®¤æƒ…å†µä¸‹ï¼ŒAnsible å°†å°è¯•å¹¶è¡Œç®¡ç† playbook ä¸­æ‰€æœ‰çš„æœºå™¨ã€‚å¯¹äºæ»šåŠ¨æ›´æ–°ç”¨ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨ serial å…³é”®å­—å®šä¹‰ Ansible ä¸€æ¬¡åº”ç®¡ç†å¤šå°‘ä¸»æœºï¼Œè¿˜å¯ä»¥å°† serial å…³é”®å­—æŒ‡å®šä¸ºç™¾åˆ†æ¯”ï¼Œè¡¨ç¤ºæ¯æ¬¡å¹¶è¡Œæ‰§è¡Œçš„ä¸»æœºæ•°å æ€»æ•°çš„æ¯”ä¾‹ã€‚

ç¤ºä¾‹ï¼š

```yaml
# vim test_serial.yml
---
- hosts: all
  serial: 2  # æ¯æ¬¡åªåŒæ—¶å¤„ç†2ä¸ªä¸»æœº
  gather_facts: False

  tasks:
    - name: task one
      comand: hostname
    - name: task two
      command: hostname
```

ç¤ºä¾‹ï¼š

```yaml
- name: test serail
  hosts: all
  serial: "20%"  # æ¯æ¬¡åªåŒæ—¶å¤„ç†20%çš„ä¸»æœº
```
