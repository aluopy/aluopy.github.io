---
title: "ä½¿ç”¨ kubeadm åˆ›å»ºé«˜å¯ç”¨é›†ç¾¤"
excerpt: ""
permalink: /kubernetes/kubeadm-high-availability/
toc: true
#toc_label: ""
#toc_icon: "cog"
categories: kubernetes
tags:
  - kubernetes
  - kubeadm
  - kube-vip
  - containerd
  - cilium
  - ipvs
---

## å‡†å¤‡å¼€å§‹

- ä¸€å°å…¼å®¹çš„ Linux ä¸»æœºã€‚Kubernetes é¡¹ç›®ä¸ºåŸºäº Debian å’Œ Red Hat çš„ Linux å‘è¡Œç‰ˆä»¥åŠä¸€äº›ä¸æä¾›åŒ…ç®¡ç†å™¨çš„å‘è¡Œç‰ˆæä¾›é€šç”¨çš„æŒ‡ä»¤
- æ¯å°æœºå™¨ 2 GB æˆ–æ›´å¤šçš„ RAM ï¼ˆå¦‚æœå°‘äºè¿™ä¸ªæ•°å­—å°†ä¼šå½±å“ä½ åº”ç”¨çš„è¿è¡Œå†…å­˜)
- 2 CPU æ ¸æˆ–æ›´å¤š
- é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨çš„ç½‘ç»œå½¼æ­¤å‡èƒ½ç›¸äº’è¿æ¥(å…¬ç½‘å’Œå†…ç½‘éƒ½å¯ä»¥)
- èŠ‚ç‚¹ä¹‹ä¸­ä¸å¯ä»¥æœ‰é‡å¤çš„ä¸»æœºåã€MAC åœ°å€æˆ– product_uuidã€‚è¯·å‚è§[è¿™é‡Œ](https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#verify-mac-address)äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯
- å¼€å¯æœºå™¨ä¸Šçš„æŸäº›ç«¯å£ã€‚è¯·å‚è§[è¿™é‡Œ](https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports) äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯
- ç¦ç”¨äº¤æ¢åˆ†åŒºã€‚ä¸ºäº†ä¿è¯ kubelet æ­£å¸¸å·¥ä½œï¼Œ**å¿…é¡»** ç¦ç”¨äº¤æ¢åˆ†åŒº

## é›†ç¾¤è§„åˆ’

é›†ç¾¤èŠ‚ç‚¹è§„åˆ’å¦‚ä¸‹

| ä¸»æœºå | ä¸»æœº IP        | ä¸»æœºé…ç½® | ä¸»æœºè§’è‰²      | ç³»ç»Ÿ                                 |
| ------ | -------------- | -------- | ------------- | ------------------------------------ |
| m1     | 192.168.20.17  | 2C4G     | Control plane | CentOS Linux release 7.6.1810 (Core) |
| m2     | 192.168.20.18  | 2C4G     | Control plane | CentOS Linux release 7.6.1810 (Core) |
| m3     | 192.168.20.19  | 2C4G     | Control plane | CentOS Linux release 7.6.1810 (Core) |
| w1     | 192.168.20.13  | 2C4G     | Worker node   | CentOS Linux release 7.6.1810 (Core) |
| w2     | 192.168.20.178 | 2C4G     | Worker node   | CentOS Linux release 7.6.1810 (Core) |

## ç³»ç»Ÿåˆå§‹åŒ–è®¾ç½®

### ä¿®æ”¹ä¸»æœºåç§°æ·»åŠ ä¸»æœºæ˜ å°„

ä¿®æ”¹ä¸»æœºåç§°

```shell
$ hostnamectl set-hostname $NODE-NAME
```

> **`NODE-NAME`**ï¼šè¡¨ç¤ºå°†è¦å‘½åç»™å„èŠ‚ç‚¹çš„ä¸»æœºå

æ·»åŠ ä¸»æœºæ˜ å°„

```shell
$ cat <<EOF | sudo tee -a /etc/hosts
192.168.20.17  m1
192.168.20.18  m2
192.168.20.19  m3
192.168.20.13  w1
192.168.20.178 w2
EOF
```

### ç¡®ä¿ MAC åœ°å€å’Œ product_uuid çš„å”¯ä¸€æ€§

- ä½¿ç”¨å‘½ä»¤ `ip link` æˆ– `ifconfig -a` æ¥è·å–ç½‘ç»œæ¥å£çš„ MAC åœ°å€
- ä½¿ç”¨ `sudo cat /sys/class/dmi/id/product_uuid` å‘½ä»¤å¯¹ product_uuid æ ¡éªŒ

ä¸€èˆ¬æ¥è®²ï¼Œç¡¬ä»¶è®¾å¤‡ä¼šæ‹¥æœ‰å”¯ä¸€çš„åœ°å€ï¼Œä½†æ˜¯æœ‰äº›è™šæ‹Ÿæœºçš„åœ°å€å¯èƒ½ä¼šé‡å¤ã€‚ Kubernetes ä½¿ç”¨è¿™äº›å€¼æ¥å”¯ä¸€ç¡®å®šé›†ç¾¤ä¸­çš„èŠ‚ç‚¹ã€‚ å¦‚æœè¿™äº›å€¼åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šä¸å”¯ä¸€ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®‰è£… [å¤±è´¥](https://github.com/kubernetes/kubeadm/issues/31)ã€‚

### é˜²ç«å¢™è®¾ç½®

å†…ç½‘ç¯å¢ƒå¯ä»¥ç›´æ¥å…³é—­é˜²ç«å¢™ã€‚å¦‚éœ€å¼€å¯é˜²ç«å¢™ï¼Œå¯ç”¨æŸäº›å¿…è¦çš„ç«¯å£åæ‰èƒ½ä½¿ Kubernetes çš„å„ç»„ä»¶ç›¸äº’é€šä¿¡ã€‚

#### æ–¹å¼ä¸€ï¼šç¦ç”¨é˜²ç«å¢™

æ‰€æœ‰èŠ‚ç‚¹å…³é—­ç³»ç»Ÿé˜²ç«å¢™

```shell
$ systemctl stop firewalld
```

#### æ–¹å¼äºŒï¼šå¯ç”¨æ‰€éœ€ç«¯å£

> **æ³¨æ„ï¼š**ä½¿ç”¨çš„ Pod ç½‘ç»œæ’ä»¶ä¹Ÿå¯èƒ½éœ€è¦å¼€å¯æŸäº›ç‰¹å®šç«¯å£ã€‚ç”±äºå„ä¸ª Pod ç½‘ç»œæ’ä»¶çš„åŠŸèƒ½éƒ½æœ‰æ‰€ä¸åŒï¼Œ è¯·å‚é˜…ä»–ä»¬å„è‡ªæ–‡æ¡£ä¸­å¯¹ç«¯å£çš„è¦æ±‚ã€‚

##### æ£€æŸ¥æ‰€éœ€ç«¯å£

###### æ§åˆ¶é¢

| åè®® | æ–¹å‘ | ç«¯å£èŒƒå›´  | ç›®çš„                    | ä½¿ç”¨è€…               |
| ---- | ---- | --------- | ----------------------- | -------------------- |
| TCP  | å…¥ç«™ | 6443      | Kubernetes API server   | æ‰€æœ‰                 |
| TCP  | å…¥ç«™ | 2379-2380 | etcd server client API  | kube-apiserver, etcd |
| TCP  | å…¥ç«™ | 10250     | Kubelet API             | è‡ªèº«, æ§åˆ¶é¢         |
| TCP  | å…¥ç«™ | 10259     | kube-scheduler          | è‡ªèº«                 |
| TCP  | å…¥ç«™ | 10257     | kube-controller-manager | è‡ªèº«                 |

å°½ç®¡ etcd çš„ç«¯å£ä¹Ÿåˆ—ä¸¾åœ¨æ§åˆ¶é¢çš„éƒ¨åˆ†ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨å¤–éƒ¨è‡ªå·±æ‰˜ç®¡ etcd é›†ç¾¤æˆ–è€…è‡ªå®šä¹‰ç«¯å£ã€‚

###### å·¥ä½œèŠ‚ç‚¹

| åè®® | æ–¹å‘ | ç«¯å£èŒƒå›´    | ç›®çš„               | ä½¿ç”¨è€…       |
| ---- | ---- | ----------- | ------------------ | ------------ |
| TCP  | å…¥ç«™ | 10250       | Kubelet API        | è‡ªèº«, æ§åˆ¶é¢ |
| TCP  | å…¥ç«™ | 30000-32767 | NodePort Servicesâ€  | æ‰€æœ‰         |

â€  [NodePort Services](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/) çš„é»˜è®¤ç«¯å£èŒƒå›´ã€‚

æ‰€æœ‰é»˜è®¤ç«¯å£éƒ½å¯ä»¥é‡æ–°é…ç½®ã€‚å½“ä½¿ç”¨è‡ªå®šä¹‰çš„ç«¯å£æ—¶ï¼Œéœ€è¦æ‰“å¼€è¿™äº›ç«¯å£æ¥ä»£æ›¿è¿™é‡Œæåˆ°çš„é»˜è®¤ç«¯å£ã€‚

ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯ API æœåŠ¡å™¨çš„ç«¯å£æœ‰æ—¶ä¼šé…ç½®ä¸º443ã€‚æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤ç«¯å£ï¼ŒæŠŠ API æœåŠ¡å™¨æ”¾åˆ°ä¸€ä¸ªç›‘å¬443 ç«¯å£çš„è´Ÿè½½å‡è¡¡å™¨åé¢ï¼Œå¹¶ä¸”è·¯ç”±æ‰€æœ‰è¯·æ±‚åˆ° API æœåŠ¡å™¨çš„é»˜è®¤ç«¯å£ã€‚

##### å¯ç”¨æ‰€éœ€ç«¯å£

åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå¯ç”¨å„è‡ªæ‰€éœ€çš„ç«¯å£

```shell
# æ§åˆ¶å¹³é¢èŠ‚ç‚¹
$ firewall-cmd --permanent --add-port=6443/tcp
$ firewall-cmd --permanent --add-port=2379-2380/tcp
$ firewall-cmd --permanent --add-port=10250/tcp
$ firewall-cmd --permanent --add-port=10257/tcp
$ firewall-cmd --permanent --add-port=10259/tcp

# å·¥ä½œèŠ‚ç‚¹
$ firewall-cmd --permanent --add-port=10250/tcp
$ firewall-cmd --permanent --add-port=30000-32767/tcp
```

> æ³¨æ„ Pod ç½‘ç»œæ’ä»¶æ‰€ä½¿ç”¨çš„ç«¯å£

### ç¦ç”¨äº¤æ¢åˆ†åŒº

ä¸ºäº†ä¿è¯ kubelet æ­£å¸¸å·¥ä½œï¼Œ**å¿…é¡»**ç¦ç”¨äº¤æ¢åˆ†åŒº

```bash
# ä¸´æ—¶ç¦ç”¨
$ swapoff -a
# æ°¸ä¹…ç¦ç”¨
$ sed -ri 's/.*swap.*/#&/' /etc/fstab
```

### ç¦ç”¨ SELinux

å°† SELinux è®¾ç½®ä¸º permissive æ¨¡å¼ï¼ˆç›¸å½“äºå°†å…¶ç¦ç”¨ï¼‰ï¼Œç¦ç”¨ SELinux æ˜¯å…è®¸å®¹å™¨è®¿é—®ä¸»æœºæ–‡ä»¶ç³»ç»Ÿæ‰€å¿…éœ€çš„ï¼Œè¿™äº›æ“ä½œæ˜¯ä¸ºäº†ä¾‹å¦‚ Pod ç½‘ç»œå·¥ä½œæ­£å¸¸ã€‚

```bash
$ setenforce 0
$ sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
```

### å…è®¸ iptables æ£€æŸ¥æ¡¥æ¥æµé‡

åŠ è½½ `br_netfilter` æ¨¡å—ï¼Œ`br_netfilter` æ¨¡å—ç”¨äºå°†æ¡¥æ¥æµé‡è½¬å‘è‡³ iptables é“¾

```shell
$ modprobe br_netfilter

# ç¡®ä¿ br_netfilter æ¨¡å—å·²è¢«åŠ è½½
$ lsmod | grep br_netfilter
```

ä¸ºäº†è®© Linux èŠ‚ç‚¹ä¸Šçš„ iptables èƒ½å¤Ÿæ­£ç¡®åœ°æŸ¥çœ‹æ¡¥æ¥æµé‡ï¼Œéœ€è¦ç¡®ä¿åœ¨ `sysctl` é…ç½®ä¸­å°† `net.bridge.bridge-nf-call-iptables` è®¾ç½®ä¸º 1ã€‚

```bash
$ cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

$ cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF
$ sudo sysctl --system
```

### å®‰è£… IPVS æ‰€éœ€çš„å†…æ ¸æ¨¡å—

åŠ è½½ ipvs æ‰€éœ€çš„å†…æ ¸æ¨¡å—

```shell
# ipvs æ¨¡å—è‡ªåŠ¨åŠ è½½é…ç½®
$ cat <<EOF | sudo tee /etc/sysconfig/modules/ipvs.modules
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF

# åŠ è½½ ipvs æ¨¡å—å¹¶æŸ¥çœ‹æ˜¯å¦å·²ç»æ­£ç¡®åŠ è½½
$ chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4

# å®‰è£… ipset
$ yum install ipset -y

# ä¸ºäº†ä¾¿äºæŸ¥çœ‹ ipvs çš„ä»£ç†è§„åˆ™ï¼Œæœ€å¥½å®‰è£…ä¸€ä¸‹ç®¡ç†å·¥å…· ipvsadm
$ yum install ipvsadm -y
```

> `/etc/sysconfig/modules/ipvs.modules` æ–‡ä»¶ç¡®ä¿äº†èŠ‚ç‚¹é‡å¯åèƒ½è‡ªåŠ¨åŠ è½½ç›¸å…³æ¨¡å—

## å®‰è£…å®¹å™¨è¿è¡Œæ—¶

æœ¬æ–‡é€‰æ‹© containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œå…¶ä»–å¸¸è§çš„å®¹å™¨è¿è¡Œæ—¶å®‰è£…è¯·å‚è€ƒï¼š[å®¹å™¨è¿è¡Œæ—¶ \| Kubernetes](https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/)

### å®‰è£… containerd

#### Step 1ï¼šå®‰è£… containerd

æœ¬æ–‡ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼å®‰è£… containerdï¼Œä¸‹è½½å®˜æ–¹äºŒè¿›åˆ¶æ–‡ä»¶ [Releases Â· containerd/containerd (github.com)](https://github.com/containerd/containerd/releases)

```shell
$ wget https://github.com/containerd/containerd/releases/download/v1.6.6/containerd-1.6.6-linux-amd64.tar.gz
```

åœ¨ `/usr/local/` ä¸‹è§£å‹

```shell
$ tar Cxzvf /usr/local containerd-1.6.6-linux-amd64.tar.gz
bin/
bin/containerd-shim
bin/containerd
bin/containerd-shim-runc-v1
bin/containerd-stress
bin/containerd-shim-runc-v2
bin/ctr
```

ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œcontainerd çš„é»˜è®¤é…ç½®æ–‡ä»¶ä¸º `/etc/containerd/config.toml`ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„é…ç½®æ–‡ä»¶

```shell
$ mkdir /etc/containerd
$ containerd config default > /etc/containerd/config.toml
```

systemd ç®¡ç† containerd

```shell
$ mkdir /usr/local/lib/systemd/system -p
$ curl -fsSL https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -o /usr/local/lib/systemd/system/containerd.service
```

å¯åŠ¨ containerd

```shell
$ systemctl daemon-reload
$ systemctl enable --now containerd
```

æŸ¥çœ‹ containerd ç‰ˆæœ¬ä¿¡æ¯

```shell
$ ctr version
Client:
  Version:  v1.6.6
  Revision: 10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1
  Go version: go1.17.11

Server:
  Version:  v1.6.6
  Revision: 10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1
  UUID: ba9fdc06-7734-485d-9b64-2376c7eae82c
```

#### Step 2ï¼šå®‰è£… runc

ä¸‹è½½ `runc.<ARCH>` äºŒè¿›åˆ¶æ–‡ä»¶ [Releases Â· opencontainers/runc (github.com)](https://github.com/opencontainers/runc/releases)

```shell
$ wget https://github.com/opencontainers/runc/releases/download/v1.1.3/runc.amd64
```

å°†å…¶å®‰è£…ä¸º `/usr/local/sbin/runc`

```shell
$ install -m 755 runc.amd64 /usr/local/sbin/runc
```

#### Step 3ï¼šå®‰è£… CNI æ’ä»¶

ä¸‹è½½ `cni-plugins-<OS>-<ARCH>-<VERSION>.tgz` å­˜æ¡£ [Releases Â· containernetworking/plugins (github.com)](https://github.com/containernetworking/plugins/releases)

```shell
$ wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz
```

åœ¨ `/opt/cni/bin` ä¸‹è§£å‹

```shell
$ mkdir -p /opt/cni/bin
$ tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz
./
./macvlan
./static
./vlan
./portmap
./host-local
./vrf
./bridge
./tuning
./firewall
./host-device
./sbr
./loopback
./dhcp
./ptp
./ipvlan
./bandwidth
```

#### é…ç½® `systemd` cgroup é©±åŠ¨ç¨‹åº

ç»“åˆ `runc` ä½¿ç”¨ `systemd` cgroup é©±åŠ¨ï¼Œåœ¨ `/etc/containerd/config.toml` ä¸­è®¾ç½® `SystemdCgroup = true`

```shell
$ sed -i 's,SystemdCgroup = false,SystemdCgroup = true,' /etc/containerd/config.toml
```

é‡å¯ containerd

```shell
$ systemctl restart containerd
```

#### é‡è½½æ²™ç®±ï¼ˆpauseï¼‰é•œåƒ

è®¾ç½® `sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.6"`

```shell
$ sed -ri 's,(.*sandbox_image = ).*,\1"registry.aliyuncs.com/google_containers/pause:3.6",' /etc/containerd/config.toml
```

é‡å¯ containerd

```shell
$ systemctl restart containerd
```

### å®‰è£… CLI å·¥å…·ï¼ˆå¯é€‰ï¼‰

æœ‰å‡ ä¸ªç”¨äºä¸ containerd äº¤äº’çš„å‘½ä»¤è¡Œç•Œé¢ (command line interface - CLI) é¡¹ç›®ï¼š

| Name      | Community             | API    | Target             | Web site                                                     |
| --------- | --------------------- | ------ | ------------------ | ------------------------------------------------------------ |
| `ctr`     | containerd            | Native | For debugging only | (None, see `ctr --help` to learn the usage)                  |
| `nerdctl` | containerd (non-core) | Native | General-purpose    | https://github.com/containerd/nerdctl                        |
| `crictl`  | Kubernetes SIG-node   | CRI    | For debugging only | https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md |

ctr å·¥å…·ä¸ containerd æ†ç»‘åœ¨ä¸€èµ·ï¼Œä½† ctr å·¥å…·ä»…ç”¨äºè°ƒè¯• containerdã€‚ nerdctl å·¥å…·æ˜¯ Containerd åŸç”Ÿçš„ CLI å·¥å…·ï¼Œå¹¶ä¸”å…¼å®¹ Dockerã€‚crictl ä¸ºå…¼å®¹ CRI çš„å®¹å™¨è¿è¡Œæ—¶æä¾› CLIã€‚

#### nerdctl

##### nerdctl å®‰è£…

```shell
# Minimal å®‰è£…
$ VERSION="0.22.0"
$ wget https://github.com/containerd/nerdctl/releases/download/v$VERSION/nerdctl-$VERSION-linux-amd64.tar.gz
$ tar Cxzvvf /usr/local/bin nerdctl-$VERSION-linux-amd64.tar.gz
$ rm -f nerdctl-$VERSION-linux-amd64.tar.gz

# æŸ¥çœ‹ç›¸å…³ç‰ˆæœ¬ä¿¡æ¯
$ nerdctl --version
nerdctl version 0.22.0
$ nerdctl version
WARN[0000] unable to determine buildctl version: exec: "buildctl": executable file not found in $PATH 
Client:
 Version:	v0.22.0
 OS/Arch:	linux/amd64
 Git commit:	8e278e2aa61a89d4e50d1a534217f264bd1a5ddf
 builctl:
  Version:	

Server:
 containerd:
  Version:	v1.6.6
  GitCommit:	10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1
 runc:
  Version:	1.1.3
  GitCommit:	v1.1.3-0-g6724737f


```

> **æ³¨æ„ï¼š**è¿˜éœ€è¦å®‰è£…ç”¨äºä½¿ç”¨ `nerdctl run` çš„ [CNI plugins](https://github.com/containernetworking/plugins)ï¼Œæœ¬æ–‡å‰é¢å·²ç»å®‰è£…ã€‚è¿˜å¯ä»¥å®‰è£…ä¸€äº›å¯é€‰çš„ç»„ä»¶ï¼Œå¦‚ç”¨äºä½¿ç”¨ `nerdctl build` çš„ [BuildKit](https://github.com/moby/buildkit) ç»„ä»¶, ç”¨äº Rootless æ¨¡å¼çš„ [RootlessKit](https://github.com/rootless-containers/rootlesskit) å’Œ [slirp4netns](https://github.com/rootless-containers/slirp4netns) ç»„ä»¶ã€‚

##### nerdctl å‘½ä»¤å‚è€ƒ

[containerd/nerdctl - command-reference (github.com)](https://github.com/containerd/nerdctl#command-reference)

#### crictl

##### crictl å®‰è£…

```shell
# å®‰è£…
$ VERSION="v1.24.2"
# $ curl -L https://github.com/kubernetes-sigs/cri-tools/releases/download/$VERSION/crictl-${VERSION}-linux-amd64.tar.gz --output crictl-${VERSION}-linux-amd64.tar.gz
$ wget https://github.com/kubernetes-sigs/cri-tools/releases/download/$VERSION/crictl-$VERSION-linux-amd64.tar.gz
$ tar zxvf crictl-$VERSION-linux-amd64.tar.gz -C /usr/local/bin
$ rm -f crictl-$VERSION-linux-amd64.tar.gz

# é…ç½®
$ cat <<EOF | tee /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF

# æŸ¥çœ‹ç›¸å…³ç‰ˆæœ¬ä¿¡æ¯
$ crictl --version
crictl version v1.24.2
$ crictl version
Version:  0.1.0
RuntimeName:  containerd
RuntimeVersion:  v1.6.6
RuntimeApiVersion:  v1
```

##### crictl ä½¿ç”¨

[kubernetes-sigs/cri-tools - usage (github.com)](https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md#usage)

## å®‰è£… kubeadmã€kubelet å’Œ kubectl

æ·»åŠ é˜¿é‡Œäº‘ YUM è½¯ä»¶æº

```bash
$ cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```

å®‰è£… kubeadmã€kubelet å’Œ kubectl

```bash
$ yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
$ systemctl enable --now kubelet
```

> ä»¥ä¸Šå®‰è£…å‘½ä»¤é»˜è®¤å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œå®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼š`yum install -y kubelet-1.20.0 kubeadm-1.20.0 kubectl-1.20.0`

## ä¸º kube-apiserver åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨

æœ¬æ–‡ä½¿ç”¨ [**kube-vip**](https://kube-vip.io/docs/) ä¸º Kubernetes é›†ç¾¤æä¾›é«˜å¯ç”¨è´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œkube-vip å°†ä½œä¸ºé™æ€ pod åœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚

kube-vip ä¸º Kubernetes é›†ç¾¤æä¾›äº†ä¸€ä¸ªè™šæ‹Ÿ IP å’Œè´Ÿè½½å‡è¡¡å™¨ï¼Œç”¨äºæ§åˆ¶å¹³é¢ï¼ˆç”¨äºæ„å»ºé«˜å¯ç”¨æ€§é›†ç¾¤ï¼‰å’Œ LoadBalancer ç±»å‹çš„ Kubernetes æœåŠ¡ï¼Œè€Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨ç¡¬ä»¶æˆ–è½¯ä»¶ã€‚

è¯¥é¡¹ç›®æœ€åˆæ—¨åœ¨ä¸º Kubernetes æä¾›å¼¹æ€§æ§åˆ¶å¹³é¢ï¼Œä½†åæ¥æ‰©å±•åˆ°ä¸º Kubernetes é›†ç¾¤ä¸­çš„æœåŠ¡èµ„æºæä¾›ç›¸åŒçš„åŠŸèƒ½ã€‚

### ç”Ÿæˆæ¸…å•

ä¸ºäº†æ›´è½»æ¾åœ°ä½¿ç”¨ kube-vip ä¸­çš„å„ç§åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ kube-vip å®¹å™¨æœ¬èº«æ¥ç”Ÿæˆæˆ‘ä»¬çš„é™æ€ Pod æ¸…å•ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°† kube-vip æ˜ åƒä½œä¸ºå®¹å™¨è¿è¡Œï¼Œå¹¶ä¸ºæˆ‘ä»¬æƒ³è¦å¯ç”¨çš„åŠŸèƒ½ä¼ å…¥å„ç§æ ‡å¿—ã€‚

é€‰æ‹©ä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹æ“ä½œ

#### è®¾ç½®é…ç½®ç»†èŠ‚

æˆ‘ä»¬ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥é¢„å®šä¹‰è¦æä¾›ç»™ kube-vip çš„è¾“å…¥å€¼ã€‚

```bash
$ export VIP=192.168.20.236
$ export INTERFACE=ens192
$ KVVERSION=$(curl -sL https://api.github.com/repos/kube-vip/kube-vip/releases | jq -r ".[0].name")
# æ‰‹åŠ¨è®¾ç½®
#$ export KVVERSION=v0.4.4
```

> `yum install epel-release -y && yum install jq -y`

#### åˆ›å»ºæ¸…å•

ä¸ºå®¹å™¨è¿è¡Œæ—¶åˆ›å»ºåˆ«åï¼Œæœ¬æ–‡ä½¿ç”¨çš„æ˜¯ containerdï¼Œæ‰€ä»¥åˆ›å»ºå‘½ä»¤å¦‚ä¸‹

```bash
$ alias kube-vip="ctr run --rm --net-host ghcr.io/kube-vip/kube-vip:$KVVERSION vip /kube-vip"
```

> **docker**ï¼š`alias kube-vip="docker run --network host --rm ghcr.io/kube-vip/kube-vip:$KVVERSION""`

åˆ›å»ºä¸€ä¸ªæ¸…å•ï¼Œè¯¥æ¸…å•å¯åŠ¨ kube-vipï¼Œä½¿ç”¨ leaderElection æ–¹æ³•å’Œ ARP æä¾›æ§åˆ¶å¹³é¢ VIP å’Œ Kubernetes æœåŠ¡ç®¡ç†ã€‚å½“è¿™ä¸ªå®ä¾‹è¢«é€‰ä¸¾ä¸ºé¢†å¯¼è€…æ—¶ï¼Œå®ƒä¼šå°† vip ç»‘å®šåˆ°æŒ‡å®šçš„æ¥å£ã€‚è¿™ä¸ LoadBalancer ç±»å‹çš„æœåŠ¡çš„è¡Œä¸ºç›¸åŒã€‚

```bash
$ kube-vip manifest pod \
    --interface $INTERFACE \
    --address $VIP \
    --controlplane \
    --services \
    --arp \
    --leaderElection | tee /etc/kubernetes/manifests/kube-vip.yaml
```

> **æ³¨æ„**ï¼šåœ¨å…¶ä½™æ§åˆ¶å¹³é¢é€šè¿‡ `kubeadm join` å‘½ä»¤åŠ å…¥åˆ°é›†ç¾¤ä¹‹åï¼Œéœ€è¦å°†ä¸»æ§åˆ¶å¹³é¢çš„ `kube-vip.yaml` æ–‡ä»¶æ‹·è´åˆ°å…¶ä½™æ§åˆ¶å¹³å°çš„ç›¸åº”ç›®å½•ã€‚

ç”Ÿæˆçš„ ARP æ¸…å•ç¤ºä¾‹

```yaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  name: kube-vip
  namespace: kube-system
spec:
  containers:
  - args:
    - manager
    env:
    - name: vip_arp
      value: "true"
    - name: port
      value: "6443"
    - name: vip_interface
      value: ens192
    - name: vip_cidr
      value: "32"
    - name: cp_enable
      value: "true"
    - name: cp_namespace
      value: kube-system
    - name: vip_ddns
      value: "false"
    - name: vip_leaderelection
      value: "true"
    - name: vip_leaseduration
      value: "5"
    - name: vip_renewdeadline
      value: "3"
    - name: vip_retryperiod
      value: "1"
    - name: vip_address
      value: 192.168.20.236
    image: ghcr.io/kube-vip/kube-vip:v0.4.4
    imagePullPolicy: Always
    name: kube-vip
    resources: {}
    securityContext:
      capabilities:
        add:
        - NET_ADMIN
        - NET_RAW
    volumeMounts:
    - mountPath: /etc/kubernetes/admin.conf
      name: kubeconfig
  hostAliases:
  - hostnames:
    - kubernetes
    ip: 127.0.0.1
  hostNetwork: true
  volumes:
  - hostPath:
      path: /etc/kubernetes/admin.conf
    name: kubeconfig
status: {}
```

## éƒ¨ç½²é«˜å¯ç”¨ etcd é›†ç¾¤ï¼ˆæœ¬æ–‡æœªä½¿ç”¨ï¼‰

é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadm åœ¨æ¯ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªæœ¬åœ° etcd å®ä¾‹ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ etcd é›†ç¾¤ï¼Œå¹¶åœ¨ä¸åŒçš„ä¸»æœºä¸Šæä¾› etcd å®ä¾‹ã€‚ä»¥ä¸‹åˆ›å»ºä¸€ä¸ªç”±ä¸‰ä¸ªæˆå‘˜ç»„æˆçš„é«˜å¯ç”¨å¤–éƒ¨ etcd é›†ç¾¤ï¼Œè¯¥é›†ç¾¤åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å¯è¢« kubeadm ä½¿ç”¨ã€‚

### å»ºç«‹é›†ç¾¤

ä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šç”Ÿæˆæ‰€æœ‰è¯ä¹¦å¹¶ä¸”åªåˆ†å‘è¿™äº› *å¿…è¦* çš„æ–‡ä»¶åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šã€‚

1. å°† kubelet é…ç½®ä¸º etcd çš„æœåŠ¡ç®¡ç†å™¨

   > åœ¨è¦è¿è¡Œ etcd çš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œæ­¤æ“ä½œ

   ç”±äº etcd æ˜¯é¦–å…ˆåˆ›å»ºçš„ï¼Œå› æ­¤ä½ å¿…é¡»é€šè¿‡åˆ›å»ºå…·æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„æ–°æ–‡ä»¶æ¥è¦†ç›– kubeadm æä¾›çš„ kubelet å•å…ƒæ–‡ä»¶ã€‚

   ```shell
   $ cat << EOF > /etc/systemd/system/kubelet.service.d/20-etcd-service-manager.conf
   [Service]
   ExecStart=
   # å°†ä¸‹é¢çš„ "systemd" æ›¿æ¢ä¸ºä½ çš„å®¹å™¨è¿è¡Œæ—¶æ‰€ä½¿ç”¨çš„ cgroup é©±åŠ¨ã€‚
   # kubelet çš„é»˜è®¤å€¼ä¸º "cgroupfs"ã€‚
   # å¦‚æœéœ€è¦çš„è¯ï¼Œå°† "--container-runtime-endpoint " çš„å€¼æ›¿æ¢ä¸ºä¸€ä¸ªä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶ã€‚
   ExecStart=/usr/bin/kubelet --address=127.0.0.1 --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd
   Restart=always
   EOF
   
   $ systemctl daemon-reload
   $ systemctl restart kubelet
   ```

   æ£€æŸ¥ kubelet çš„çŠ¶æ€ä»¥ç¡®ä¿å…¶å¤„äºè¿è¡ŒçŠ¶æ€ï¼š

   ```shell
   $ systemctl status kubelet
   ```

2. ä¸º kubeadm åˆ›å»ºé…ç½®æ–‡ä»¶

   ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ä¸ºæ¯ä¸ªå°†è¦è¿è¡Œ etcd æˆå‘˜çš„ä¸»æœºç”Ÿæˆä¸€ä¸ª kubeadm é…ç½®æ–‡ä»¶

   ```shell
   # ä½¿ç”¨ä½ çš„ä¸»æœº IP æ›¿æ¢ HOST0ã€HOST1 å’Œ HOST2 çš„ IP åœ°å€
   export HOST0=192.168.20.17
   export HOST1=192.168.20.18
   export HOST2=192.168.20.19
   
   # ä½¿ç”¨ä½ çš„ä¸»æœºåæ›´æ–° NAME0ã€NAME1 å’Œ NAME2
   export NAME0="m1"
   export NAME1="m2"
   export NAME2="m3"
   
   # åˆ›å»ºä¸´æ—¶ç›®å½•æ¥å­˜å‚¨å°†è¢«åˆ†å‘åˆ°å…¶å®ƒä¸»æœºä¸Šçš„æ–‡ä»¶
   mkdir -p /tmp/${HOST0}/ /tmp/${HOST1}/ /tmp/${HOST2}/
   
   HOSTS=(${HOST0} ${HOST1} ${HOST2})
   NAMES=(${NAME0} ${NAME1} ${NAME2})
   
   for i in "${!HOSTS[@]}"; do
   HOST=${HOSTS[$i]}
   NAME=${NAMES[$i]}
   cat << EOF > /tmp/${HOST}/kubeadmcfg.yaml
   ---
   apiVersion: "kubeadm.k8s.io/v1beta3"
   kind: InitConfiguration
   nodeRegistration:
       name: ${NAME}
   localAPIEndpoint:
       advertiseAddress: ${HOST}
   ---
   apiVersion: "kubeadm.k8s.io/v1beta3"
   kind: ClusterConfiguration
   etcd:
       local:
           serverCertSANs:
           - "${HOST}"
           peerCertSANs:
           - "${HOST}"
           extraArgs:
               initial-cluster: ${NAMES[0]}=https://${HOSTS[0]}:2380,${NAMES[1]}=https://${HOSTS[1]}:2380,${NAMES[2]}=https://${HOSTS[2]}:2380
               initial-cluster-state: new
               name: ${NAME}
               listen-peer-urls: https://${HOST}:2380
               listen-client-urls: https://${HOST}:2379
               advertise-client-urls: https://${HOST}:2379
               initial-advertise-peer-urls: https://${HOST}:2380
   EOF
   done
   ```

3. ç”Ÿæˆè¯ä¹¦é¢å‘æœºæ„

   å¦‚æœå·²ç»æ‹¥æœ‰ CAï¼Œé‚£ä¹ˆç›´æ¥å¤åˆ¶ CA çš„ `crt` å’Œ `key` æ–‡ä»¶åˆ° `/etc/kubernetes/pki/etcd/ca.crt` å’Œ `/etc/kubernetes/pki/etcd/ca.key`ã€‚ å¤åˆ¶å®Œè¿™äº›æ–‡ä»¶åç»§ç»­â€œä¸ºæ¯ä¸ªæˆå‘˜åˆ›å»ºè¯ä¹¦â€ã€‚

   å¦‚æœè¿˜æ²¡æœ‰ CAï¼Œåˆ™åœ¨ `$HOST0`ï¼ˆä¸º kubeadm ç”Ÿæˆé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼‰ä¸Šè¿è¡Œæ­¤å‘½ä»¤ã€‚

   ```shell
   $ kubeadm init phase certs etcd-ca
   [certs] Generating "etcd/ca" certificate and key
   ```

   è¿™ä¸€æ“ä½œåˆ›å»ºå¦‚ä¸‹ä¸¤ä¸ªæ–‡ä»¶ï¼š

   - `/etc/kubernetes/pki/etcd/ca.crt`
   - `/etc/kubernetes/pki/etcd/ca.key`

4. ä¸ºæ¯ä¸ªæˆå‘˜åˆ›å»ºè¯ä¹¦

   ```shell
   kubeadm init phase certs etcd-server --config=/tmp/${HOST2}/kubeadmcfg.yaml
   kubeadm init phase certs etcd-peer --config=/tmp/${HOST2}/kubeadmcfg.yaml
   kubeadm init phase certs etcd-healthcheck-client --config=/tmp/${HOST2}/kubeadmcfg.yaml
   kubeadm init phase certs apiserver-etcd-client --config=/tmp/${HOST2}/kubeadmcfg.yaml
   cp -R /etc/kubernetes/pki /tmp/${HOST2}/
   # æ¸…ç†ä¸å¯é‡å¤ä½¿ç”¨çš„è¯ä¹¦
   find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete
   
   kubeadm init phase certs etcd-server --config=/tmp/${HOST1}/kubeadmcfg.yaml
   kubeadm init phase certs etcd-peer --config=/tmp/${HOST1}/kubeadmcfg.yaml
   kubeadm init phase certs etcd-healthcheck-client --config=/tmp/${HOST1}/kubeadmcfg.yaml
   kubeadm init phase certs apiserver-etcd-client --config=/tmp/${HOST1}/kubeadmcfg.yaml
   cp -R /etc/kubernetes/pki /tmp/${HOST1}/
   find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete
   
   kubeadm init phase certs etcd-server --config=/tmp/${HOST0}/kubeadmcfg.yaml
   kubeadm init phase certs etcd-peer --config=/tmp/${HOST0}/kubeadmcfg.yaml
   kubeadm init phase certs etcd-healthcheck-client --config=/tmp/${HOST0}/kubeadmcfg.yaml
   kubeadm init phase certs apiserver-etcd-client --config=/tmp/${HOST0}/kubeadmcfg.yaml
   # ä¸éœ€è¦ç§»åŠ¨ certs å› ä¸ºå®ƒä»¬æ˜¯ç»™ HOST0 ä½¿ç”¨çš„
   
   # æ¸…ç†ä¸åº”ä»æ­¤ä¸»æœºå¤åˆ¶çš„è¯ä¹¦
   find /tmp/${HOST2} -name ca.key -type f -delete
   find /tmp/${HOST1} -name ca.key -type f -delete
   ```

5. å¤åˆ¶è¯ä¹¦å’Œ kubeadm é…ç½®

   è¯ä¹¦å·²ç”Ÿæˆï¼Œç°åœ¨å°†å®ƒä»¬ç§»åŠ¨åˆ°å¯¹åº”çš„ä¸»æœºã€‚

   ```shell
   USER=root
   HOST=${HOST1}
   scp -r /tmp/${HOST}/* ${USER}@${HOST}:/etc/kubernetes/
   ssh ${USER}@${HOST}
   USER@HOST $ sudo -Es
   root@HOST $ chown -R root:root pki
   root@HOST $ mv pki /etc/kubernetes/
   ```

6. ç¡®ä¿æ‰€æœ‰æ‹·è´çš„æ–‡ä»¶éƒ½å­˜åœ¨

   `$HOST0` æ‰€éœ€æ–‡ä»¶çš„å®Œæ•´åˆ—è¡¨å¦‚ä¸‹ï¼š

   ```
   /tmp/${HOST0}
   â””â”€â”€ kubeadmcfg.yaml
   ---
   /etc/kubernetes/pki
   â”œâ”€â”€ apiserver-etcd-client.crt
   â”œâ”€â”€ apiserver-etcd-client.key
   â””â”€â”€ etcd
       â”œâ”€â”€ ca.crt
       â”œâ”€â”€ ca.key
       â”œâ”€â”€ healthcheck-client.crt
       â”œâ”€â”€ healthcheck-client.key
       â”œâ”€â”€ peer.crt
       â”œâ”€â”€ peer.key
       â”œâ”€â”€ server.crt
       â””â”€â”€ server.key
   ```

   åœ¨ `$HOST1` ä¸Šï¼š

   ```
   $HOME
   â””â”€â”€ kubeadmcfg.yaml
   ---
   /etc/kubernetes/pki
   â”œâ”€â”€ apiserver-etcd-client.crt
   â”œâ”€â”€ apiserver-etcd-client.key
   â””â”€â”€ etcd
       â”œâ”€â”€ ca.crt
       â”œâ”€â”€ healthcheck-client.crt
       â”œâ”€â”€ healthcheck-client.key
       â”œâ”€â”€ peer.crt
       â”œâ”€â”€ peer.key
       â”œâ”€â”€ server.crt
       â””â”€â”€ server.key
   ```

   åœ¨ `$HOST2` ä¸Šï¼š

   ```
   $HOME
   â””â”€â”€ kubeadmcfg.yaml
   ---
   /etc/kubernetes/pki
   â”œâ”€â”€ apiserver-etcd-client.crt
   â”œâ”€â”€ apiserver-etcd-client.key
   â””â”€â”€ etcd
       â”œâ”€â”€ ca.crt
       â”œâ”€â”€ healthcheck-client.crt
       â”œâ”€â”€ healthcheck-client.key
       â”œâ”€â”€ peer.crt
       â”œâ”€â”€ peer.key
       â”œâ”€â”€ server.crt
       â””â”€â”€ server.key
   ```

7. åˆ›å»ºé™æ€ Pod æ¸…å•

   åœ¨æ¯å°ä¸»æœºä¸Šè¿è¡Œ `kubeadm` å‘½ä»¤æ¥ç”Ÿæˆ etcd ä½¿ç”¨çš„é™æ€æ¸…å•

   ```shell
   root@HOST0 $ kubeadm init phase etcd local --config=/tmp/${HOST0}/kubeadmcfg.yaml
   root@HOST1 $ kubeadm init phase etcd local --config=$HOME/kubeadmcfg.yaml
   root@HOST2 $ kubeadm init phase etcd local --config=$HOME/kubeadmcfg.yaml
   ```

8. å¯é€‰ï¼šæ£€æŸ¥é›†ç¾¤è¿è¡ŒçŠ¶å†µ

   ```shell
   $ docker run --rm -it \
   --net host \
   -v /etc/kubernetes:/etc/kubernetes k8s.gcr.io/etcd:${ETCD_TAG} etcdctl \
   --cert /etc/kubernetes/pki/etcd/peer.crt \
   --key /etc/kubernetes/pki/etcd/peer.key \
   --cacert /etc/kubernetes/pki/etcd/ca.crt \
   --endpoints https://${HOST0}:2379 endpoint health --cluster
   ...
   https://[HOST0 IP]:2379 is healthy: successfully committed proposal: took = 16.283339ms
   https://[HOST1 IP]:2379 is healthy: successfully committed proposal: took = 19.44402ms
   https://[HOST2 IP]:2379 is healthy: successfully committed proposal: took = 35.926451ms
   ```

   - å°† `${ETCD_TAG}` è®¾ç½®ä¸ºä½ çš„ etcd é•œåƒçš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œä¾‹å¦‚ `3.4.3-0`ã€‚ è¦æŸ¥çœ‹ kubeadm ä½¿ç”¨çš„ etcd é•œåƒå’Œæ ‡ç­¾ï¼Œè¯·æ‰§è¡Œ `kubeadm config images list --kubernetes-version ${K8S_VERSION}`ï¼Œ ä¾‹å¦‚ï¼Œå…¶ä¸­çš„ `${K8S_VERSION}` å¯ä»¥æ˜¯ `v1.17.0`ã€‚
   - å°† `${HOST0}` è®¾ç½®ä¸ºè¦æµ‹è¯•çš„ä¸»æœºçš„ IP åœ°å€ã€‚

## åˆå§‹åŒ– K8S é›†ç¾¤

### åˆå§‹åŒ–ä¸»æ§åˆ¶å¹³é¢

æœ¬æ–‡é€šè¿‡ä¸€ä»½é…ç½®æ–‡ä»¶è€Œä¸æ˜¯ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æ¥é…ç½® `kubeadm init` å‘½ä»¤ï¼Œ ä¸€äº›æ›´åŠ é«˜çº§çš„åŠŸèƒ½åªèƒ½å¤Ÿé€šè¿‡é…ç½®æ–‡ä»¶è®¾å®šã€‚ è¿™ä»½é…ç½®æ–‡ä»¶é€šè¿‡ `--config` é€‰é¡¹å‚æ•°æŒ‡å®šçš„ï¼Œ å®ƒå¿…é¡»åŒ…å« `ClusterConfiguration` ç»“æ„ï¼Œå¹¶å¯èƒ½åŒ…å«æ›´å¤šç”± `---\n` åˆ†éš”çš„ç»“æ„ã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¸å…è®¸å°† `--config` ä¸å…¶ä»–æ ‡å¿—æ··åˆä½¿ç”¨ã€‚è¯¦æƒ…è¯·æŸ¥çœ‹ï¼š[kubeadm config \| Kubernetes](https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-config/)

**Step 1ï¼š**å‡†å¤‡ `kubeadm init` å‘½ä»¤çš„é…ç½®æ–‡ä»¶ï¼š`kubeadm-config.yaml`

```yaml
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
# nodeRegistration:
  # name: m1
  # criSocket: /run/containerd/containerd.sock
localAPIEndpoint:
  advertiseAddress: 192.168.20.17
  bindPort: 6443
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: stable
# å¯ä»¥æŒ‡å®š TCP ç«¯å£å·ï¼Œä¼šè¦†ç›– bindPort
# å¦‚æœä¸æŒ‡å®šç«¯å£å·ï¼Œåˆ™ä½¿ç”¨ bindPort
# controlPlaneEndpoint: 192.168.20.236:8443
controlPlaneEndpoint: 192.168.20.236
apiServer:
  certSANs:
  - m1
  - m2
  - m3
  - 192.168.20.17
  - 192.168.20.18
  - 192.168.20.19
  - vip.mycluster.local
  - 192.168.20.236
  - 127.0.0.1
  extraArgs:
    authorization-mode: Node,RBAC
  timeoutForControlPlane: 4m0s
clusterName: kubernetes
certificatesDir: /etc/kubernetes/pki
imageRepository: registry.aliyuncs.com/google_containers
etcd:
  # one of local or external
  local:
    dataDir: /var/lib/etcd
  # external:
    # endpoints:
    # - 192.168.20.17:2379
    # - 192.168.20.18:2379
    # - 192.168.20.19:2379
    # caFile: /etcd/kubernetes/pki/etcd/etcd-ca.crt
    # certFile: /etcd/kubernetes/pki/etcd/etcd.crt
    # keyFile: /etcd/kubernetes/pki/etcd/etcd.key
networking:
  serviceSubnet: 10.96.0.0/16
  podSubnet: 10.244.0.0/24
  dnsDomain: cluster.local
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: ipvs
```

**Step 2ï¼š**åˆå§‹åŒ–ä¸»æ§åˆ¶å¹³é¢

```bash
$ kubeadm init --config kubeadm-config.yaml --upload-certs
...
You can now join any number of the control-plane node running the following command on each as root:

  kubeadm join 192.168.20.236:6443 --token 6srrq0.6u4zm8l9owxdtfaf \
	--discovery-token-ca-cert-hash sha256:f8a28591178ab71055be992835eda2ecf7b88e446405d016644c9847108c03d4 \
	--control-plane --certificate-key 552030cbc5d9560094e1e0c1fec20e26ee239e4baa3791c7dfc5b4b02ae3081c

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
"kubeadm init phase upload-certs --upload-certs" to reload certs afterward.

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.20.236:6443 --token 6srrq0.6u4zm8l9owxdtfaf \
	--discovery-token-ca-cert-hash sha256:f8a28591178ab71055be992835eda2ecf7b88e446405d016644c9847108c03d4
```

> `--upload-certs` æ ‡å¿—ç”¨æ¥å°†åœ¨æ‰€æœ‰æ§åˆ¶å¹³é¢å®ä¾‹ä¹‹é—´çš„å…±äº«è¯ä¹¦ä¸Šä¼ åˆ°é›†ç¾¤ã€‚ä¸»æ§åˆ¶å¹³é¢çš„è¯ä¹¦è¢«åŠ å¯†å¹¶ä¸Šä¼ åˆ° `kubeadm-certs` Secret ä¸­ã€‚
>
> é‡æ–°ä¸Šä¼ è¯ä¹¦å¹¶ç”Ÿæˆæ–°çš„è§£å¯†å¯†é’¥ï¼š`kubeadm init phase upload-certs --upload-certs`

### å…¶ä½™æ§åˆ¶å¹³é¢åŠ å…¥é›†ç¾¤

åœ¨å…¶ä½™çš„æ§åˆ¶å¹³é¢æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åŠ å…¥é›†ç¾¤

```shell
$ kubeadm join 192.168.20.236:6443 --token 6srrq0.6u4zm8l9owxdtfaf \
	--discovery-token-ca-cert-hash sha256:f8a28591178ab71055be992835eda2ecf7b88e446405d016644c9847108c03d4 \
	--control-plane --certificate-key 552030cbc5d9560094e1e0c1fec20e26ee239e4baa3791c7dfc5b4b02ae3081c
```

åœ¨ä¸»æ§åˆ¶å¹³é¢å¤åˆ¶ kube-vip æ¸…å•æ–‡ä»¶åˆ°å…¶ä½™çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œæ³¨æ„å°† **`vip_interface`** é¡¹çš„å€¼ä¿®æ”¹ä¸ºå„è‡ªèŠ‚ç‚¹çš„ç½‘å¡åç§°ã€‚

```shell
$ for i in m2 m3;do scp /etc/kubernetes/manifests/kube-vip.yaml root@$i:/etc/kubernetes/manifests/;done
```

### å®‰è£…å·¥ä½œèŠ‚ç‚¹

åœ¨æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åŠ å…¥é›†ç¾¤

```shell
$ kubeadm join 192.168.20.236:6443 --token 6srrq0.6u4zm8l9owxdtfaf \
	--discovery-token-ca-cert-hash sha256:f8a28591178ab71055be992835eda2ecf7b88e446405d016644c9847108c03d4
```

## é…ç½® kubectl å‘½ä»¤

### é…ç½®ä½¿ç”¨ kubectl å‘½ä»¤

- **é root ç”¨æˆ·**

  ```shell
  $ mkdir -p $HOME/.kube
  $ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  $ sudo chown $(id -u):$(id -g) $HOME/.kube/config
  ```

- **root ç”¨æˆ·**

  ```shell
  $ echo "export KUBECONFIG=/etc/kubernetes/admin.conf" >> /etc/profile
  $ source /etc/profile
  ```

### å¯åŠ¨ kubectl è‡ªåŠ¨è¡¥å…¨

kubectl çš„ Bash è¡¥å…¨è„šæœ¬å¯ä»¥ç”¨å‘½ä»¤ `kubectl completion bash` ç”Ÿæˆã€‚ åœ¨ shell ä¸­å¯¼å…¥ï¼ˆSourcingï¼‰è¡¥å…¨è„šæœ¬ï¼Œå°†å¯ç”¨ kubectl è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚è¡¥å…¨è„šæœ¬ä¾èµ–äºå·¥å…· [**bash-completion**](https://github.com/scop/bash-completion)ï¼Œ æ‰€ä»¥è¦å…ˆå®‰è£…å®ƒã€‚

```shell
# æ£€æŸ¥ bash-completion æ˜¯å¦å·²å®‰è£…
$ type _init_completion

# å®‰è£… bash-completion
$ yum install bash-completion -y
$ source /usr/share/bash-completion/bash_completion

# å¯åŠ¨ kubectl è‡ªåŠ¨è¡¥å…¨
# å½“å‰ç”¨æˆ·
# $ echo 'source <(kubectl completion bash)' >>~/.bashrc
# ç³»ç»Ÿå…¨å±€
$ kubectl completion bash | sudo tee /etc/bash_completion.d/kubectl > /dev/null

# å¦‚æœ kubectl æœ‰å…³è”çš„åˆ«åï¼Œå¯ä»¥æ‰©å±• shell è¡¥å…¨æ¥é€‚é…æ­¤åˆ«å
$ echo 'alias k=kubectl' >>~/.bashrc && source ~/.bashrc
$ echo 'complete -o default -F __start_kubectl k' >>~/.bashrc
```

> **è¯´æ˜ï¼š**
>
> bash-completion è´Ÿè´£å¯¼å…¥ `/etc/bash_completion.d` ç›®å½•ä¸­çš„æ‰€æœ‰è¡¥å…¨è„šæœ¬ã€‚
>
> **é‡æ–°åŠ è½½ shell åï¼Œkubectl è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½æ‰ç”Ÿæ•ˆ**ã€‚

## å®‰è£… Pod ç½‘ç»œé™„åŠ ç»„ä»¶

æœ¬æ–‡ä½¿ç”¨ [Cilium](https://github.com/cilium/cilium-cli) ä¸º kubernetes é›†ç¾¤æä¾› NetworkPolicyã€‚Cilium æ˜¯å¼€æºè½¯ä»¶ï¼Œç”¨äºé€æ˜åœ°ä¿æŠ¤ä½¿ç”¨ Linux å®¹å™¨ç®¡ç†å¹³å°ï¼ˆå¦‚ Docker å’Œ Kubernetesï¼‰éƒ¨ç½²çš„åº”ç”¨ç¨‹åºæœåŠ¡ä¹‹é—´çš„ç½‘ç»œè¿æ¥å’Œè´Ÿè½½å¹³è¡¡ã€‚Cilium åœ¨ç¬¬ 3/4 å±‚è¿è¡Œä»¥æä¾›ä¼ ç»Ÿçš„ç½‘ç»œå’Œå®‰å…¨æœåŠ¡ï¼Œå¹¶åœ¨ç¬¬ 7 å±‚è¿è¡Œä»¥ä¿æŠ¤å’Œä¿æŠ¤ç°ä»£åº”ç”¨ç¨‹åºåè®®ï¼ˆå¦‚ HTTPã€gRPC å’Œ Kafkaï¼‰çš„ä½¿ç”¨ã€‚ Cilium è¢«é›†æˆåˆ° Kubernetes ç­‰å¸¸è§çš„ç¼–æ’æ¡†æ¶ä¸­ã€‚

### å®‰è£… cilium

#### å®‰è£… Cilium CLI

å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Cilium CLIã€‚ Cilium CLI å¯ç”¨äºå®‰è£… Ciliumã€æ£€æŸ¥ Cilium å®‰è£…çš„çŠ¶æ€ä»¥åŠå¯ç”¨/ç¦ç”¨å„ç§åŠŸèƒ½ï¼ˆä¾‹å¦‚ clustermeshã€Hubbleï¼‰

```shell
$ wget https://github.com/cilium/cilium-cli/releases/download/v0.11.11/cilium-linux-amd64.tar.gz
$ tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
$ rm -f cilium-linux-amd64.tar.gz
```

#### å®‰è£… Cilium

**è¦æ±‚**ï¼š

- Kubernetes å¿…é¡»é…ç½®ä¸ºä½¿ç”¨ CNI
- Linux kernel >= 4.9.17

**å®‰è£… Cilium**

å°† Cilium å®‰è£…åˆ°å½“å‰ kubectl ä¸Šä¸‹æ–‡æŒ‡å‘çš„ Kubernetes é›†ç¾¤ä¸­ï¼š

```shell
$ cilium install
â„¹ï¸  Using Cilium version 1.11.6
ğŸ”® Auto-detected cluster name: kubernetes
ğŸ”® Auto-detected datapath mode: tunnel
â„¹ï¸  helm template --namespace kube-system cilium cilium/cilium --version 1.11.6 --set cluster.id=0,cluster.name=kubernetes,encryption.nodeEncryption=false,kubeProxyReplacement=disabled,operator.replicas=1,serviceAccounts.cilium.name=cilium,serviceAccounts.operator.name=cilium-operator,tunnel=vxlan
â„¹ï¸  Storing helm values file in kube-system/cilium-cli-helm-values Secret
ğŸ”‘ Created CA in secret cilium-ca
ğŸ”‘ Generating certificates for Hubble...
ğŸš€ Creating Service accounts...
ğŸš€ Creating Cluster roles...
ğŸš€ Creating ConfigMap for Cilium version 1.11.6...
ğŸš€ Creating Agent DaemonSet...
level=warning msg="spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[1].matchExpressions[0].key: beta.kubernetes.io/os is deprecated since v1.14; use \"kubernetes.io/os\" instead" subsys=klog
ğŸš€ Creating Operator Deployment...
âŒ› Waiting for Cilium to be installed and ready...
â™»ï¸  Restarting unmanaged pods...
â™»ï¸  Restarted unmanaged pod kube-system/coredns-74586cf9b6-h2bfr
â™»ï¸  Restarted unmanaged pod kube-system/coredns-74586cf9b6-t5g45
âœ… Cilium was successfully installed! Run 'cilium status' to view installation health
```

å¦‚æœç”±äºæŸç§åŸå› å®‰è£…å¤±è´¥ï¼Œè¯·è¿è¡Œ `cilium status` ä»¥æ£€ç´¢ Cilium éƒ¨ç½²çš„æ•´ä½“çŠ¶æ€ï¼Œå¹¶æ£€æŸ¥ä»»ä½•æœªèƒ½éƒ¨ç½²çš„ pod çš„æ—¥å¿—ã€‚

### éªŒè¯å®‰è£…

è¦éªŒè¯ Cilium æ˜¯å¦å·²æ­£ç¡®å®‰è£…ï¼Œæ‚¨å¯ä»¥è¿è¡Œ

```shell
$ cilium status --wait
    /Â¯Â¯\
 /Â¯Â¯\__/Â¯Â¯\    Cilium:         OK
 \__/Â¯Â¯\__/    Operator:       OK
 /Â¯Â¯\__/Â¯Â¯\    Hubble:         disabled
 \__/Â¯Â¯\__/    ClusterMesh:    disabled
    \__/

DaemonSet         cilium             Desired: 5, Ready: 5/5, Available: 5/5
Deployment        cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
Containers:       cilium             Running: 5
                  cilium-operator    Running: 1
Cluster Pods:     2/2 managed by Cilium
Image versions    cilium-operator    quay.io/cilium/operator-generic:v1.11.6@sha256:9f6063c7bcaede801a39315ec7c166309f6a6783e98665f6693939cf1701bc17: 1
                  cilium             quay.io/cilium/cilium:v1.11.6@sha256:f7f93c26739b6641a3fa3d76b1e1605b15989f25d06625260099e01c8243f54c: 5
```

æŸ¥çœ‹ Cilium ç›¸å…³ç‰ˆæœ¬

```shell
$ cilium version
cilium-cli: v0.11.11 compiled with go1.18.3 on linux/amd64
cilium image (default): v1.11.6
cilium image (stable): v1.11.6
cilium image (running): v1.11.6
```

éªŒè¯é›†ç¾¤æ˜¯å¦å…·æœ‰æ­£ç¡®çš„ç½‘ç»œè¿æ¥

```shell
$ cilium connectivity test
```

## æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

```shell
$ kubectl cluster-info
Kubernetes control plane is running at https://192.168.20.236:6443
CoreDNS is running at https://192.168.20.236:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.

$ kubectl get nodes
NAME   STATUS   ROLES           AGE   VERSION
m1     Ready    control-plane   23h   v1.24.3
m2     Ready    control-plane   23h   v1.24.3
m3     Ready    control-plane   23h   v1.24.3
w1     Ready    <none>          22h   v1.24.3
w2     Ready    <none>          22h   v1.24.3
```

